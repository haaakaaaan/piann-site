<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>piann — puan & sıralama</title>
<style>
  :root{
    --bg:#0A66C2; --ink:#0f1419; --text:#fff; --muted:#d7e6f7;
    --card:#ffffff; --line:rgba(255,255,255,.18);
    --container:min(1200px,96vw);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text);background:var(--bg)}
  a{color:inherit}
  .nav{position:sticky;top:0;backdrop-filter:saturate(140%) blur(6px);background:rgba(10,102,194,.75);border-bottom:1px solid var(--line);z-index:10}
  .nav-inner{max-width:var(--container);margin:0 auto;padding:12px 20px;display:flex;align-items:center;gap:16px}
  .nav-left, .nav-middle, .nav-right{display:flex;align-items:center;gap:12px}
  .nav-middle{margin-inline:auto;font-weight:700;letter-spacing:.5px}
  .btn{appearance:none;border:1px solid var(--line);background:rgba(255,255,255,.12);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{background:rgba(255,255,255,.18)}
  .btn-primary{background:#fff;color:#0A66C2;border:none}
  .btn-primary:hover{filter:brightness(.95)}
  .wrap{max-width:var(--container);margin:0 auto;padding:24px 20px}
  .hero{display:grid;grid-template-columns: 1.2fr .8fr;gap:24px;align-items:center;margin-top:18px}
  .card{background:var(--card);color:var(--ink);border-radius:16px;border:1px solid rgba(16,24,40,.08);box-shadow:0 6px 24px rgba(0,0,0,.08)}
  .card .in{padding:18px}
  h1,h2,h3{margin:8px 0 12px}
  .muted{color:#475467}
  .list{display:flex;flex-direction:column;gap:8px}
  .row{display:grid;grid-template-columns:56px 1fr auto;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;border:1px solid rgba(16,24,40,.08)}
  .row img{width:48px;height:48px;border-radius:50%;object-fit:cover}
  .row strong{display:block}
  .row small{color:#475467}
  .row .score{font-weight:700}
  .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .pill{background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 10px;font-size:12px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .hidden{display:none}
  .center{text-align:center}
  input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:20px}
  .modal .panel{max-width:520px;width:100%}
  .footer{opacity:.9;font-size:13px;margin-top:22px}
</style>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <button class="btn" id="go-home">Ana sayfa</button>
        <button class="btn" id="go-board">Liderboard</button>
      </div>
      <div class="nav-middle">piann</div>
      <div class="nav-right" id="auth-area">
        <!-- filled by JS -->
      </div>
    </div>
  </nav>

  <main class="wrap">
    <!-- HOME -->
    <section id="home">
      <div class="hero">
        <div class="card">
          <div class="in">
            <h1>Profilini puanla, saygıyla sıralan.</h1>
            <p class="muted">Facebook + IMDb karması: insanlar birbirine 0-100 arası puan verir, tek görünen skor güvenli LCB olur.</p>
            <div style="display:flex;gap:10px;margin-top:8px" id="home-cta">
              <!-- buttons injected -->
            </div>
            <div class="footer">Üye sayısı: <span id="stat-users">—</span> • Puanlanan: <span id="stat-rated">—</span></div>
          </div>
        </div>
        <div class="card">
          <div class="in">
            <div class="bar">
              <h3>Top 10</h3>
              <span class="pill">LCB</span>
            </div>
            <div id="top10" class="list"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="board" class="hidden">
      <div class="card">
        <div class="in">
          <div class="bar">
            <h2>Liderboard</h2>
            <div>
              <button class="btn" id="reload-board">Yenile</button>
            </div>
          </div>
          <div id="board-list" class="list"></div>
          <div class="center" style="margin-top:12px">
            <button class="btn" id="more">Daha fazla</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profile" class="hidden">
      <div class="grid-2">
        <div class="card">
          <div class="in">
            <h3>Profilim</h3>
            <div id="me-box">—</div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn" id="edit-profile">Düzenle</button>
              <button class="btn" id="sign-out">Çıkış</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="in">
            <h3>Top-10 (kopya)</h3>
            <div id="top10b" class="list"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- RATE MODAL -->
  <div class="modal" id="rate-modal">
    <div class="panel card">
      <div class="in">
        <h3 id="rate-title">Puan ver</h3>
        <p class="muted" id="rate-sub">0–100 arası, ondalık serbest (örn: 83.75)</p>
        <input type="number" id="rate-input" min="0" max="100" step="0.01" placeholder="Örn: 88.5" />
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button class="btn" id="rate-cancel">İptal</button>
          <button class="btn btn-primary" id="rate-save">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT PROFILE MODAL -->
  <div class="modal" id="edit-modal">
    <div class="panel card">
      <div class="in">
        <h3>Profili Düzenle</h3>
        <div class="grid-2">
          <div>
            <label>Ad</label>
            <input id="p-name" placeholder="Görünen ad" />
          </div>
          <div>
            <label>@kullanıcı adı</label>
            <input id="p-handle" placeholder="Benzersiz handle" />
          </div>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <div>
            <label>Web</label>
            <input id="p-web" placeholder="https://..." />
          </div>
          <div>
            <label>Konum</label>
            <input id="p-loc" placeholder="Şehir, Ülke" />
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Bio</label>
          <textarea id="p-bio" rows="3" placeholder="Kısa açıklama"></textarea>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <div>
            <label>Avatar URL</label>
            <input id="p-photo" placeholder="https://..." />
          </div>
          <div>
            <label>Kapak URL</label>
            <input id="p-cover" placeholder="https://..." />
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button class="btn" id="edit-cancel">İptal</button>
          <button class="btn btn-primary" id="edit-save">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase v10 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
      collection, query, where, orderBy, limit, getDocs, startAfter,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // TODO: KENDİ BİLGİLERİNİ YAPIŞTIR (PASTE YOUR OWN CONFIG)
    const firebaseConfig = {
      apiKey: "AIz...ES8Q",
      authDomain: "piann-c58b8.firebaseapp.com",
      projectId: "piann-c58b8",
      storageBucket: "piann-c58b8.appspot.com",
      messagingSenderId: "11806334896697",
      appId: "1:11806334896697:web:7770adc7f9438be4a49be8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ----- UI helpers
    const $ = (s)=>document.querySelector(s);
    const home = $("#home"), board=$("#board"), profile=$("#profile");
    const authArea = $("#auth-area"), homeCta=$("#home-cta");
    const top10 = $("#top10"), top10b=$("#top10b");
    const boardList = $("#board-list"), moreBtn=$("#more");
    const statUsers=$("#stat-users"), statRated=$("#stat-rated");
    const meBox=$("#me-box");
    const goHome=$("#go-home"), goBoard=$("#go-board");
    const reloadBoard=$("#reload-board");
    const editModal=$("#edit-modal"), rateModal=$("#rate-modal");
    const editBtn=$("#edit-profile"), signOutBtn=$("#sign-out");

    let currentUser=null;
    let lastCursor=null; // for pagination
    let visitorMode=false;
    let rateTarget=null;

    function show(sec){
      for (const el of [home,board,profile]) el.classList.add("hidden");
      sec.classList.remove("hidden");
    }
    goHome.onclick=()=>show(home);
    goBoard.onclick=()=>{ show(board); loadBoard(true); };

    // ----- AUTH AREA
    async function renderAuth(){
      homeCta.innerHTML="";
      authArea.innerHTML="";
      if(currentUser){
        const img = currentUser.photoURL || "https://i.pravatar.cc/100?u="+currentUser.uid;
        authArea.innerHTML = `
          <img src="${img}" alt="" style="width:32px;height:32px;border-radius:50%;border:1px solid #fff3;margin-right:6px">
          <button class="btn" id="go-profile">Profilim</button>
          <button class="btn" id="btn-signout">Çıkış</button>`;
        $("#go-profile").onclick=()=>{ show(profile); refreshMe(); loadTop10s(); };
        $("#btn-signout").onclick=()=>signOut(auth);
        homeCta.innerHTML = `<button class="btn btn-primary" id="cta-board">Liderboard’a git</button>`;
        $("#cta-board").onclick=()=>{ show(board); loadBoard(true); };
        visitorMode=false;
      }else{
        const btnGoogle = `<button class="btn btn-primary" id="btn-google">Google ile giriş</button>`;
        const btnGuest  = `<button class="btn" id="btn-guest">Ziyaretçi olarak devam et</button>`;
        authArea.innerHTML = btnGoogle;
        homeCta.innerHTML = btnGoogle + btnGuest;
        $("#btn-google").onclick=signInWithGoogle;
        $("#btn-guest").onclick=()=>{ visitorMode=true; show(board); loadBoard(true); };
      }
    }

    async function signInWithGoogle(){
      await signInWithPopup(auth, provider);
      // İlk girişte users/{uid} ve profiles/{uid} yarat/yenile
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      await ensureUserDocs();
      await renderAuth();
      await loadStats();
      await loadTop10s();
      if(currentUser){ show(profile); refreshMe(); } else { show(home); }
    });

    async function ensureUserDocs(){
      if(!currentUser) return;
      const uref = doc(db,"users",currentUser.uid);
      const snap = await getDoc(uref);
      if(!snap.exists()){
        await setDoc(uref,{
          ratingCount: 0,
          ratingSumMicro: 0,
          ratingSumSqMicro: 0,
          avgMicroCache: 0,
          scoreLCB: 0,
          displayName: currentUser.displayName || "Kullanıcı",
          photoURL: currentUser.photoURL || "",
          joinedAt: serverTimestamp()
        });
      }else{
        // displayName/photo güncel tut
        await updateDoc(uref,{
          displayName: currentUser.displayName || snap.data().displayName || "Kullanıcı",
          photoURL: currentUser.photoURL || snap.data().photoURL || ""
        });
      }
      const pref = doc(db,"profiles",currentUser.uid);
      const psnap = await getDoc(pref);
      if(!psnap.exists()){
        await setDoc(pref,{
          displayName: currentUser.displayName || "Kullanıcı",
          displayNameLower: (currentUser.displayName||"").toLowerCase(),
          handle: "",
          handleLower: "",
          bio: "",
          website: "",
          location: "",
          photoURL: currentUser.photoURL || "",
          coverURL: ""
        });
      }
    }

    // ----- Stats (approx via queries)
    async function loadStats(){
      // Kullanıcı sayısı ~ users koleksiyonu doc sayısı (cheap approximation via Top10 + Board load)
      // Burada sadece "puanlanan" istatistiğini güvenli hesaplarız: ratingCount>0
      const q1 = query(collection(db,"users"), where("ratingCount",">",0), limit(1));
      const snap1 = await getDocs(q1);
      let ratedCount = 0;
      if(!snap1.empty){
        // Firestore'da tam sayıyı almak için sayım koleksiyonu gerekir; basit MVP’de göstergeyi Top10/Board sayılarıyla dolduracağız.
      }
      // Sade gösterim:
      statUsers.textContent = "—";
      statRated.textContent = "LCB listesinde olanlar";
    }

    // ----- Top10 & copy
    async function loadTop10s(){
      top10.innerHTML = "Yükleniyor…";
      top10b.innerHTML = "Yükleniyor…";
      const qTop = query(
        collection(db,"users"),
        where("ratingCount",">",0),
        orderBy("scoreLCB","desc"),
        orderBy("ratingCount","desc"),
        limit(10)
      );
      const snap = await getDocs(qTop);
      const items=[];
      snap.forEach(docu=>{
        const d = docu.data();
        items.push(renderRow(docu.id, d, true));
      });
      top10.innerHTML = items.join("") || "<div class='muted'>Henüz veri yok</div>";
      top10b.innerHTML = top10.innerHTML;
    }

    // ----- Board + pagination
    async function loadBoard(reset=false){
      if(reset){ boardList.innerHTML=""; lastCursor=null; }
      const baseQ = query(
        collection(db,"users"),
        where("ratingCount",">",0),
        orderBy("scoreLCB","desc"),
        orderBy("ratingCount","desc"),
        limit(25)
      );
      const q2 = lastCursor ? query(baseQ, startAfter(lastCursor.scoreLCB, lastCursor.ratingCount)) : baseQ;
      const snap = await getDocs(q2);
      if(snap.empty){ moreBtn.disabled=true; moreBtn.textContent="Bitti"; return; }
      const arr=[];
      let last=null;
      snap.forEach(docu=>{
        const d = docu.data();
        arr.push(renderRow(docu.id, d, false));
        last = { scoreLCB: d.scoreLCB, ratingCount: d.ratingCount };
      });
      boardList.insertAdjacentHTML("beforeend", arr.join(""));
      lastCursor = last;
      moreBtn.disabled=false; moreBtn.textContent="Daha fazla";
    }

    moreBtn.onclick = ()=>loadBoard(false);
    reloadBoard.onclick=()=>loadBoard(true);

    // ----- Render helpers
    function num(x){ return typeof x==="number" && isFinite(x) ? x : 0; }
    function to2(x){ return Math.round(x*100)/100; }

    function renderRow(uid, d, compact=false){
      const img = d.photoURL || ("https://i.pravatar.cc/100?u="+uid);
      const name = d.displayName || "Kullanıcı";
      const lcb = to2(num(d.scoreLCB));
      const cnt = num(d.ratingCount);
      const rateBtn = currentUser && !visitorMode && currentUser.uid!==uid
        ? `<button class="btn" data-rate="${uid}" data-name="${name}">Puan Ver</button>`
        : `<button class="btn" disabled>Puan Ver</button>`;
      return `
        <div class="row">
          <img src="${img}" alt="">
          <div>
            <strong>${name}</strong>
            <small>LCB: ${lcb} • Oy: ${cnt}</small>
          </div>
          <div class="score">${lcb}</div>
          ${compact?``:``}
          <div style="grid-column:1/-1;display:flex;justify-content:flex-end;gap:8px">${rateBtn}</div>
        </div>`;
    }

    document.addEventListener("click",(e)=>{
      const t = e.target.closest("[data-rate]");
      if(t){
        if(visitorMode){ alert("Puan vermek için giriş yapın."); return; }
        rateTarget = { uid: t.dataset.rate, name: t.dataset.name };
        $("#rate-title").textContent = `${rateTarget.name} için puan ver`;
        $("#rate-input").value = "";
        rateModal.style.display="flex";
      }
    });
    $("#rate-cancel").onclick=()=>{ rateModal.style.display="none"; rateTarget=null; };
    $("#rate-save").onclick=saveRating;

    // ----- LCB hesap (mikro tam sayılarla)
    function computeLCBFromSums(sumMicro, sumSqMicro, count){
      if(count<=0) return 0;
      const avgMicro = sumMicro / count; // mikro birim
      const mean = avgMicro / 100000;   // 0..100 float
      // Varyans (mikro^2 birim): E[x^2] - (E[x])^2
      const ex2_micro2 = (sumSqMicro / count);
      const var_micro2 = Math.max(0, ex2_micro2 - avgMicro*avgMicro);
      // Standart sapma (mikro)
      const sd_micro = Math.sqrt(var_micro2);
      const sd = sd_micro / 100000;
      const lcb = mean - 1.96 * (sd / Math.sqrt(count));
      const clipped = Math.max(0, Math.min(100, lcb));
      return clipped;
    }

    // ----- Puan Kaydet (transaction ile delta işle)
    async function saveRating(){
      if(!currentUser || !rateTarget) return;
      const val = parseFloat($("#rate-input").value);
      if(!isFinite(val) || val<0 || val>100){ alert("0–100 arası değer girin."); return; }
      const newMicro = Math.round(val * 100000);
      const targetUid = rateTarget.uid;
      const rDoc = doc(db,"users",targetUid,"ratings", currentUser.uid);
      const uDoc = doc(db,"users",targetUid);

      try{
        await runTransaction(db, async (tx)=>{
          const rSnap = await tx.get(rDoc);
          const uSnap = await tx.get(uDoc);
          if(!uSnap.exists()){
            // hedef kullanıcı yoksa oluştur (nadir)
            tx.set(uDoc,{
              ratingCount: 0, ratingSumMicro: 0, ratingSumSqMicro: 0,
              avgMicroCache: 0, scoreLCB: 0, displayName:"Kullanıcı", photoURL:"", joinedAt: serverTimestamp()
            });
          }
          let { ratingCount, ratingSumMicro, ratingSumSqMicro } = uSnap.exists()? uSnap.data() : { ratingCount:0, ratingSumMicro:0, ratingSumSqMicro:0 };

          let oldMicro = null;
          if(rSnap.exists()){
            oldMicro = rSnap.data().micro|0;
          }

          if(oldMicro===null){
            // ilk oy
            ratingCount += 1;
            ratingSumMicro += newMicro;
            ratingSumSqMicro += (newMicro*newMicro);
          }else{
            // güncelleme
            ratingSumMicro += (newMicro - oldMicro);
            ratingSumSqMicro += (newMicro*newMicro - oldMicro*oldMicro);
          }

          const avgMicroCache = Math.floor(ratingCount>0 ? ratingSumMicro / ratingCount : 0);
          const scoreLCB = computeLCBFromSums(ratingSumMicro, ratingSumSqMicro, ratingCount);

          tx.set(rDoc, { micro:newMicro, updatedAt: serverTimestamp() }, { merge:true });
          tx.set(uDoc, {
            ratingCount, ratingSumMicro, ratingSumSqMicro, avgMicroCache, scoreLCB,
          }, { merge:true });
        });

        rateModal.style.display="none";
        rateTarget=null;
        await loadTop10s();
        await loadBoard(true);
      }catch(err){
        console.error(err);
        alert("Puan kaydedilemedi: " + (err?.message||""));
      }
    }

    // ----- Profilim
    async function refreshMe(){
      if(!currentUser){ meBox.textContent="—"; return; }
      const uref = doc(db,"users",currentUser.uid);
      const usnap = await getDoc(uref);
      const d = usnap.data()||{};
      const img = d.photoURL || ("https://i.pravatar.cc/100?u="+currentUser.uid);
      const lcb = (Math.round((d.scoreLCB||0)*100)/100).toFixed(2);
      meBox.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center">
          <img src="${img}" style="width:56px;height:56px;border-radius:50%;object-fit:cover">
          <div>
            <div style="font-weight:700">${d.displayName||"Kullanıcı"}</div>
            <div class="muted">LCB: ${lcb} • Oy: ${d.ratingCount||0}</div>
          </div>
        </div>`;
    }

    // ----- Edit profile
    editBtn && (editBtn.onclick=async ()=>{
      if(!currentUser) return;
      // load existing
      const psnap = await getDoc(doc(db,"profiles",currentUser.uid));
      const p = psnap.data()||{};
      $("#p-name").value = p.displayName||"";
      $("#p-handle").value = p.handle||"";
      $("#p-bio").value = p.bio||"";
      $("#p-web").value = p.website||"";
      $("#p-loc").value = p.location||"";
      $("#p-photo").value = p.photoURL||"";
      $("#p-cover").value = p.coverURL||"";
      editModal.style.display="flex";
    });
    $("#edit-cancel").onclick=()=>editModal.style.display="none";
    $("#edit-save").onclick=async ()=>{
      if(!currentUser) return;
      const displayName = $("#p-name").value.trim();
      const handle = $("#p-handle").value.trim();
      const data = {
        displayName, displayNameLower: displayName.toLowerCase(),
        handle, handleLower: handle.toLowerCase(),
        bio: $("#p-bio").value.trim(),
        website: $("#p-web").value.trim(),
        location: $("#p-loc").value.trim(),
        photoURL: $("#p-photo").value.trim(),
        coverURL: $("#p-cover").value.trim(),
      };
      await setDoc(doc(db,"profiles",currentUser.uid), data, { merge:true });
      await updateDoc(doc(db,"users",currentUser.uid), {
        displayName: displayName || "Kullanıcı",
        photoURL: data.photoURL || ""
      });
      editModal.style.display="none";
      refreshMe();
      await loadTop10s();
    };

    // ----- Sign out
    signOutBtn && (signOutBtn.onclick=()=>signOut(auth));
  </script>
</body>
</html>

