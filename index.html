<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>piann — Gerçek değerini keşfet; skorun senin imzan</title>
<style>
  :root{
    --bg:#f7f8fb; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --line:#e6e9ef;
    --accent:#0A66C2; --accent-600:#0857A6; --good:#16a34a; --bad:#ef4444;
    --container:max(320px,min(1200px,92vw));
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  a{color:inherit;text-decoration:none}
  .nav{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:5}
  .nav-in{max-width:var(--container);margin:0 auto;display:flex;gap:12px;align-items:center;padding:12px 8px}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand em{color:var(--accent);font-style:normal}
  .sp{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.ghost{background:#fff}
  .wrap{max-width:var(--container);margin:18px auto;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr;} .aside{order:-1} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);padding:6px}
  .tab{padding:8px 12px;border-radius:999px;cursor:pointer}
  .tab.active{background:#eef5ff;color:#0a56a8}
  .list{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  @media (max-width: 860px){ .list{grid-template-columns:1fr 1fr} }
  @media (max-width: 560px){ .list{grid-template-columns:1fr} }
  .p-card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:8px}
  .p-top{display:flex;gap:10px;align-items:center}
  .avatar{width:56px;height:56px;border-radius:50%;background:#e2e8f0;overflow:hidden;border:1px solid #e6e9ef}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .name{font-weight:700}
  .handle{color:var(--muted);font-size:13px}
  .bio{color:#334155;font-size:14px}
  .meta{display:flex;gap:10px;color:#475569;font-size:12px}
  .rank{margin-left:auto;padding:4px 8px;border-radius:8px;background:#f1f5f9;font-weight:700}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .stat{border:1px solid var(--line);border-radius:10px;padding:8px}
  .k{font-size:12px;color:var(--muted)}
  .v{font-size:20px;font-weight:800}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{font-size:12px;border:1px solid var(--line);padding:6px 8px;border-radius:999px;cursor:pointer}
  .chip:hover{background:#f8fafc}
  .aside h3{margin:8px 0 12px 0}
  .lb-row{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px}
  .lb-row:hover{background:#f8fafc}
  .lb-rank{width:26px;font-weight:800;text-align:right}
  .lb-score{margin-left:auto;font-weight:800}
  .footer{max-width:var(--container);margin:12px auto 32px auto;color:var(--muted);font-size:12px}
  /* Profile page bits */
  .cover{height:160px;background:#f1f5f9;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .cover img{width:100%;height:100%;object-fit:cover}
  .p-head{display:flex;gap:16px;margin-top:-40px;align-items:flex-end}
  .p-avatar{width:96px;height:96px;border-radius:50%;border:4px solid #fff;background:#e2e8f0;overflow:hidden}
  .p-avatar img{width:100%;height:100%;object-fit:cover}
  .p-title{display:flex;flex-direction:column;gap:6px}
  .p-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  .p-stats{display:flex;gap:12px;margin-top:10px}
  .p-stat{flex:1;border:1px solid var(--line);border-radius:12px;padding:10px}
  .p-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
  @media (max-width: 860px){ .p-grid{grid-template-columns:1fr} }
  .edit{margin-top:12px;border:1px dashed #cbd5e1;border-radius:12px;padding:12px;display:none}
  .edit.visible{display:block}
  .edit label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
  .edit input,.edit textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;margin-top:4px}
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0A66C2;color:#fff;padding:10px 14px;border-radius:12px;display:none}
</style>
</head>
<body>
  <nav class="nav">
    <div class="nav-in">
      <a href="#/discover" class="brand">piann <em>· skorun senin imzan</em></a>
      <a id="tabDiscover" class="tab" href="#/discover">Keşfet</a>
      <a id="tabRanking" class="tab" href="#/ranking">Top 500</a>
      <a id="tabNetwork" class="tab" href="#/network">Ağım</a>
      <span class="sp"></span>
      <div id="userBadge" class="muted"></div>
      <button id="btnSignIn" class="btn primary">Google ile Giriş</button>
      <button id="btnSignOut" class="btn ghost" style="display:none">Çıkış</button>
    </div>
  </nav>

  <div class="wrap">
    <main id="main"></main>
    <aside class="aside">
      <div class="card">
        <h3>Top 25</h3>
        <div id="lb25"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div style="font-size:12px;color:var(--muted)">
          Slogan: “Gerçek değerini keşfet; skorun senin imzan.”<br/>
          Beğeni/yorum yok—sadece puan ve sıralama.
        </div>
      </div>
    </aside>
  </div>

  <div class="footer">© piann — LCB ile sıralama • anonim oy • tek arenada yarış</div>
  <div id="toast" class="toast"></div>

<!-- ====================== APP SCRIPT ====================== -->
<script type="module">
/*** ---------- Firebase Imports ---------- ***/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
  collection, getDocs, query, orderBy, limit, where, runTransaction
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

/*** ---------- Config (EDIT HERE) ---------- ***/
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
/* ↑↑↑ Proje bilgilerini kendi Firebase konsolundan kopyala. ↑↑↑ */
/* ↑↑↑ Copy your own Firebase config from console. ↑↑↑ */

/*** ---------- Init ---------- ***/
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/*** ---------- Helpers ---------- ***/
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => [...document.querySelectorAll(sel)];
function toast(msg){
  const el = $("#toast"); el.textContent = msg; el.style.display="block";
  setTimeout(()=>{ el.style.display="none"; }, 1300);
}
const microToScore = (micro) => (micro/100000).toFixed(2);
function computeLCB(n, sumMicro, sumSqMicro){
  if(!n || n < 1) return 0;
  const mu = sumMicro / n;
  const varMicro = Math.max(0, (sumSqMicro / n) - (mu*mu));
  const sd = Math.sqrt(varMicro);
  const lcbMicro = mu - 1.96 * (sd / Math.sqrt(n));
  const lcb = Math.max(0, Math.min(100, lcbMicro / 100000));
  return Number(lcb.toFixed(2));
}
function byLCBDesc(a,b){ return b.lcb - a.lcb; }
function sample(arr, k){
  const copy = arr.slice(); const out=[];
  while(copy.length && out.length<k){
    const i = Math.floor(Math.random()*copy.length);
    out.push(copy.splice(i,1)[0]);
  }
  return out;
}

/*** ---------- Auth UI ---------- ***/
$("#btnSignIn").addEventListener("click", async () => {
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
});
$("#btnSignOut").addEventListener("click", async () => { await signOut(auth); });

/*** ---------- First login bootstrap ---------- ***/
async function ensureUserDocs(user){
  const uid = user.uid;
  const uRef = doc(db, "users", uid);
  const pRef = doc(db, "profiles", uid);
  const [uSnap, pSnap] = await Promise.all([getDoc(uRef), getDoc(pRef)]);
  const now = serverTimestamp();

  if(!uSnap.exists()){
    await setDoc(uRef, {
      displayName: user.displayName || "",
      photoURL: user.photoURL || "",
      joinedAt: now,
      ratingCount: 0,
      ratingSumMicro: 0,
      ratingSumSqMicro: 0,
      avgMicroCache: 0
    }, { merge: true });
  }
  if(!pSnap.exists()){
    await setDoc(pRef, {
      displayName: user.displayName || "Yeni Kullanıcı",
      handle: "",
      bio: "",
      website: "",
      location: "",
      photoURL: user.photoURL || "",
      coverURL: "",
      joinedAt: now,
      updatedAt: now
    }, { merge: true });
  }
}

/*** ---------- Rating (anonymous) ---------- ***/
// Not: Güvenlik kuralların “ratings read: deny; write: only rater” şeklinde olmalı.
// Note: Your rules should enforce ratings anonymity.
async function rateUser(targetUid, meUid, score){
  if(!meUid){ toast("Önce giriş yap"); return; }
  if(targetUid === meUid){ toast("Kendine oy veremezsin"); return; }
  const val = Number(score);
  if(!(val > 0 && val <= 100)){ toast("Puan 0–100 arası"); return; }

  const micro = Math.round(val*100000);
  const rRef = doc(db, "users", targetUid, "ratings", meUid);
  const uRef = doc(db, "users", targetUid);
  const now = serverTimestamp();

  // Oy belgesini yaz + (geçici) agregaları client’ta güncelle
  // (Sunucu tarafında Cloud Function kurduğunda, sadece rating yazmak yeterli olacak.)
  await runTransaction(db, async (tx) => {
    const rSnap = await tx.get(rRef);
    const uSnap = await tx.get(uRef);
    if(!uSnap.exists()) throw "Target user missing";

    let { ratingCount=0, ratingSumMicro=0, ratingSumSqMicro=0 } = uSnap.data();

    if(rSnap.exists()){
      const prev = rSnap.data().micro || 0;
      // sum/sumSq düzelt
      ratingSumMicro += (micro - prev);
      ratingSumSqMicro += (micro*micro - prev*prev);
      tx.update(rRef, { micro, updatedAt: now });
    }else{
      ratingCount += 1;
      ratingSumMicro += micro;
      ratingSumSqMicro += micro*micro;
      tx.set(rRef, { micro, createdAt: now, updatedAt: now });
    }
    const avgMicroCache = Math.floor(ratingCount ? (ratingSumMicro / ratingCount) : 0);
    tx.update(uRef, { ratingCount, ratingSumMicro, ratingSumSqMicro, avgMicroCache });
  });

  toast("Puan gönderildi");
}

/*** ---------- Data Loads ---------- ***/
async function loadUsersBatch(limitN=120){
  const q1 = query(collection(db,"users"), orderBy("ratingCount","desc"), limit(limitN));
  const snap = await getDocs(q1);
  const rows = [];
  for(const d of snap.docs){
    const uid = d.id;
    const u = d.data();
    const pSnap = await getDoc(doc(db,"profiles",uid));
    const p = pSnap.exists()? pSnap.data(): {};
    rows.push({
      uid,
      displayName: p.displayName || u.displayName || "İsimsiz",
      handle: p.handle || "",
      photoURL: p.photoURL || u.photoURL || "",
      bio: p.bio || "",
      location: p.location || "",
      website: p.website || "",
      ratingCount: u.ratingCount||0,
      ratingSumMicro: u.ratingSumMicro||0,
      ratingSumSqMicro: u.ratingSumSqMicro||0,
      joinedAt: u.joinedAt,
    });
  }
  // LCB hesapla
  rows.forEach(r => r.lcb = computeLCB(r.ratingCount, r.ratingSumMicro, r.ratingSumSqMicro));
  return rows;
}

async function loadTop(limitN=500){ return loadUsersBatch(limitN); }

async function loadFollowing(meUid){
  const fSnap = await getDocs(collection(db,"users",meUid,"following"));
  const ids = fSnap.docs.map(d=>d.id);
  if(!ids.length) return [];
  // Firestore "in" koşulunu parça parça (max 10) yapalım
  const chunks = []; for(let i=0;i<ids.length;i+=10) chunks.push(ids.slice(i,i+10));
  const acc=[];
  for(const chunk of chunks){
    const qx = query(collection(db,"users"), where("__name__","in",chunk));
    const snap = await getDocs(qx);
    for(const d of snap.docs){
      const uid = d.id; const u = d.data();
      const pSnap = await getDoc(doc(db,"profiles",uid));
      const p = pSnap.exists()? pSnap.data(): {};
      acc.push({
        uid,
        displayName: p.displayName || u.displayName || "İsimsiz",
        handle: p.handle || "",
        photoURL: p.photoURL || u.photoURL || "",
        ratingCount: u.ratingCount||0,
        ratingSumMicro: u.ratingSumMicro||0,
        ratingSumSqMicro: u.ratingSumSqMicro||0,
      });
    }
  }
  acc.forEach(r => r.lcb = computeLCB(r.ratingCount, r.ratingSumMicro, r.ratingSumSqMicro));
  return acc;
}

/*** ---------- Small UI Partials ---------- ***/
function profileMiniRow(i, r){
  const h = r.handle ? "@"+r.handle : "";
  return `
    <a class="lb-row" href="#/u/${r.uid}">
      <div class="lb-rank">${i}</div>
      <div class="avatar" style="width:28px;height:28px;"><img src="${r.photoURL||''}" alt=""></div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.displayName}</div>
        <div style="color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${h}</div>
      </div>
      <div class="lb-score">${r.lcb.toFixed(2)}</div>
    </a>
  `;
}
function profileCard(r, me){
  const h = r.handle ? "@"+r.handle : "";
  return `
  <div class="p-card">
    <div class="p-top">
      <div class="avatar"><img src="${r.photoURL||''}" alt=""></div>
      <div>
        <div class="name">${r.displayName}</div>
        <div class="handle">${h}</div>
      </div>
      <div class="rank">LCB ${r.lcb.toFixed(2)}</div>
    </div>
    <div class="bio">${r.bio || ""}</div>
    <div class="grid2">
      <div class="stat"><div class="k">Ortalama</div><div class="v">${
        r.ratingCount ? microToScore(r.ratingSumMicro/r.ratingCount) : "—"
      }</div></div>
      <div class="stat"><div class="k">Oy</div><div class="v">${r.ratingCount||0}</div></div>
    </div>
    <div class="chips">
      ${me && me.uid!==r.uid ? `
        <span class="chip rate" data-uid="${r.uid}" data-q="70">70</span>
        <span class="chip rate" data-uid="${r.uid}" data-q="80">80</span>
        <span class="chip rate" data-uid="${r.uid}" data-q="90">90</span>
        <span class="chip rate" data-uid="${r.uid}" data-q="95">95</span>
        <span class="chip open" data-uid="${r.uid}">Profili gör</span>
      ` : `<span class="chip open" data-uid="${r.uid}">Profili gör</span>`}
    </div>
  </div>`;
}

/*** ---------- Views ---------- ***/
// Discover: Üstte “Düello” (2 kart), altta 3 kartlık keşfet
async function viewDiscover(){
  const me = auth.currentUser;
  const rows = await loadUsersBatch(120);
  const others = rows.filter(r => !me || r.uid !== me.uid);
  const duel = sample(others, 2);
  const picks = sample(others, 3);

  $("#main").innerHTML = `
    <div class="card">
      <div class="tabs"><div class="tab active">Düello</div></div>
      <div class="list" style="grid-template-columns:1fr 1fr">
        ${
          duel.map(r => `
            <div class="p-card">
              <div class="p-top">
                <div class="avatar" style="width:64px;height:64px;"><img src="${r.photoURL||''}" alt=""></div>
                <div>
                  <div class="name">${r.displayName}</div>
                  <div class="handle">${r.handle? "@"+r.handle : ""}</div>
                </div>
                <div class="rank">LCB ${r.lcb.toFixed(2)}</div>
              </div>
              <div class="bio">${r.bio||""}</div>
              <div class="grid2">
                <div class="stat"><div class="k">Ortalama</div><div class="v">${
                  r.ratingCount ? microToScore(r.ratingSumMicro/r.ratingCount) : "—"
                }</div></div>
                <div class="stat"><div class="k">Oy</div><div class="v">${r.ratingCount||0}</div></div>
              </div>
              <div class="chips">
                ${me && me.uid!==r.uid ? `
                  <span class="chip rate" data-uid="${r.uid}" data-q="75">Sol daha iyi (75)</span>
                  <span class="chip rate" data-uid="${r.uid}" data-q="92.5">Sağ daha iyi (92.5)</span>
                  <span class="chip rate" data-uid="${r.uid}" data-q="70">70</span>
                  <span class="chip rate" data-uid="${r.uid}" data-q="80">80</span>
                  <span class="chip rate" data-uid="${r.uid}" data-q="90">90</span>
                  <span class="chip rate" data-uid="${r.uid}" data-q="95">95</span>
                ` : `<span class="chip">Giriş yaparak oy verebilirsin</span>`}
                <span class="chip open" data-uid="${r.uid}">Profili gör</span>
              </div>
            </div>
          `).join("")
        }
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="tabs"><div class="tab active">Keşfet</div></div>
      <div class="list">
        ${picks.map(r => profileCard(r, me)).join("")}
      </div>
    </div>
  `;

  bindRates();
  bindOpenProfileLinks();
}

// Ranking: Top500 (LCB’ye göre client tarafında sıralanır)
async function viewRanking(){
  $("#main").innerHTML = `<div class="card"><div class="tabs"><div class="tab active">Top 500</div></div><div id="rk"></div></div>`;
  const rows = await loadTop(500);
  rows.sort(byLCBDesc);
  $("#rk").innerHTML = rows.slice(0,500).map((r,i)=>`
    <div class="lb-row">
      <div class="lb-rank">${i+1}</div>
      <div class="avatar" style="width:28px;height:28px;"><img src="${r.photoURL||''}" alt=""></div>
      <a href="#/u/${r.uid}" style="flex:1">
        <div style="font-weight:700">${r.displayName}</div>
        <div style="font-size:12px;color:var(--muted)">${r.handle? "@"+r.handle:""}</div>
      </a>
      <div class="lb-score">${r.lcb.toFixed(2)}</div>
    </div>
  `).join("");
}

// Network: Takip ettiklerim arasında sıralama
async function viewNetwork(){
  const me = auth.currentUser;
  if(!me){ $("#main").innerHTML = `<div class="card">Ağını görmek için giriş yap.</div>`; return; }
  $("#main").innerHTML = `<div class="card"><div class="tabs"><div class="tab active">Ağım</div></div><div id="nw"></div></div>`;
  const rows = await loadFollowing(me.uid);
  rows.sort(byLCBDesc);
  $("#nw").innerHTML = rows.length
    ? rows.map((r,i)=> profileMiniRow(i+1,r)).join("")
    : `<div class="muted" style="padding:10px">Henüz kimseyi takip etmiyorsun.</div>`;
}

// Profile: #/u/{uid}
async function viewProfile(uid){
  const me = auth.currentUser;
  const pRef = doc(db,"profiles",uid);
  const uRef = doc(db,"users",uid);
  const [pSnap, uSnap] = await Promise.all([getDoc(pRef), getDoc(uRef)]);
  if(!uSnap.exists()){
    $("#main").innerHTML = `<div class="card">Profil bulunamadı.</div>`; return;
  }
  const p = pSnap.exists()? pSnap.data(): {};
  const u = uSnap.data();
  const lcb = computeLCB(u.ratingCount||0, u.ratingSumMicro||0, u.ratingSumSqMicro||0);
  const avg = u.ratingCount ? microToScore(u.ratingSumMicro/u.ratingCount) : "—";

  // Following state (owner-only visible anyway)
  let isFollowing = false;
  if(me && me.uid !== uid){
    const fSnap = await getDoc(doc(db,"users",me.uid,"following",uid));
    isFollowing = fSnap.exists();
  }

  $("#main").innerHTML = `
  <div class="card">
    <div class="cover">${p.coverURL ? `<img src="${p.coverURL}" alt="">` : `<span style="color:var(--muted)">Kapak görseli</span>`}</div>
    <div class="p-head">
      <div class="p-avatar"><img src="${(p.photoURL || u.photoURL || '')}" alt=""></div>
      <div class="p-title">
        <div class="name" style="font-size:24px;font-weight:800">${p.displayName || u.displayName || "İsimsiz"}</div>
        <div class="handle" style="color:var(--muted)">${p.handle? "@"+p.handle:""}</div>
        <div class="meta" style="color:#475569;font-size:13px">
          ${p.location ? `📍 ${p.location}`:''}
          ${p.website ? `<a href="${p.website}" target="_blank" rel="noopener">🔗 ${p.website}</a>`:''}
          <span style="color:var(--muted)">UID: ${uid.slice(0,6)}…</span>
        </div>
      </div>
      <div class="p-actions">
        <button class="btn ghost" id="shareBtn">Paylaş</button>
        ${
          me ? (me.uid===uid
            ? `<button class="btn primary" id="editToggle">Profili Düzenle</button>`
            : `<button class="btn primary" id="followBtn">${isFollowing? "Takibi Bırak":"Takip Et"}</button>`
          ) : ``
        }
      </div>
    </div>

    <div class="p-stats">
      <div class="p-stat"><div class="k">LCB</div><div class="v">${lcb.toFixed(2)}</div></div>
      <div class="p-stat"><div class="k">Ortalama</div><div class="v">${avg}</div></div>
      <div class="p-stat"><div class="k">Oy</div><div class="v">${u.ratingCount||0}</div></div>
    </div>

    <div class="p-grid">
      <div class="card">
        <div class="bio">${p.bio || "Henüz bio yok."}</div>
      </div>
      <div class="card">
        ${
          !me || me.uid===uid
          ? `<div class="muted">Bu profile puan vermek için başka bir hesapla giriş yap.</div>`
          : `
            <div style="font-weight:700;margin-bottom:6px">Puan Ver (0–100)</div>
            <div class="chips">
              <span class="chip rate" data-uid="${uid}" data-q="70">70</span>
              <span class="chip rate" data-uid="${uid}" data-q="80">80</span>
              <span class="chip rate" data-uid="${uid}" data-q="90">90</span>
              <span class="chip rate" data-uid="${uid}" data-q="95">95</span>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <input id="customScore" type="number" min="1" max="100" step="0.01" placeholder="87.50"
                     style="flex:1;padding:8px;border:1px solid var(--line);border-radius:10px"/>
              <button class="btn primary" id="btnCustomRate">Puanla</button>
            </div>
            <div class="muted" style="margin-top:6px">Puan veren anonim kalır.</div>
          `
        }
      </div>
    </div>

    <div class="edit" id="editPane">
      <div style="font-weight:700">Profil Düzenle</div>
      <label>Ad</label><input id="fDisplayName" value="${p.displayName||""}"/>
      <label>Handle (a–z,0–9,_)</label><input id="fHandle" value="${p.handle||""}"/>
      <label>Bio</label><textarea id="fBio" rows="3">${p.bio||""}</textarea>
      <label>Website</label><input id="fWebsite" value="${p.website||""}"/>
      <label>Konum</label><input id="fLocation" value="${p.location||""}"/>
      <label>Foto URL</label><input id="fPhoto" value="${(p.photoURL||u.photoURL||"")}"/>
      <label>Kapak URL</label><input id="fCover" value="${p.coverURL||""}"/>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn primary" id="saveProfile">Kaydet</button>
        <button class="btn ghost" id="cancelEdit">İptal</button>
      </div>
    </div>
  </div>`;

  // Actions
  const shareBtn = $("#shareBtn");
  if(shareBtn){
    shareBtn.onclick = async () => {
      const url = `${location.origin}${location.pathname}#/u/${uid}`;
      try{ await navigator.clipboard.writeText(url); toast("Link kopyalandı"); }
      catch{ alert(url); }
    };
  }
  const followBtn = $("#followBtn");
  if(followBtn && me && me.uid!==uid){
    followBtn.onclick = async ()=>{
      const fRef = doc(db,"users",me.uid,"following",uid);
      const exists = (await getDoc(fRef)).exists();
      if(exists){ await updateDoc(fRef,{updatedAt: serverTimestamp()}); /* dilersen deleteDoc */ }
      else{ await setDoc(fRef,{createdAt: serverTimestamp(), updatedAt: serverTimestamp()}); }
      viewProfile(uid);
    };
  }
  const btnCustomRate = $("#btnCustomRate");
  if(btnCustomRate && me){
    btnCustomRate.onclick = async ()=>{
      const v = Number(($("#customScore").value||"0"));
      await rateUser(uid, me.uid, v);
      viewProfile(uid);
    };
  }
  const editToggle = $("#editToggle");
  if(editToggle){ editToggle.onclick = ()=> $("#editPane").classList.toggle("visible"); }
  $("#cancelEdit")?.addEventListener("click", ()=> $("#editPane").classList.remove("visible"));
  $("#saveProfile")?.addEventListener("click", async ()=>{
    await setDoc(pRef,{
      displayName: $("#fDisplayName").value.trim(),
      handle: $("#fHandle").value.trim(),
      bio: $("#fBio").value.trim(),
      website: $("#fWebsite").value.trim(),
      location: $("#fLocation").value.trim(),
      photoURL: $("#fPhoto").value.trim(),
      coverURL: $("#fCover").value.trim(),
      updatedAt: serverTimestamp()
    }, { merge:true });
    toast("Profil güncellendi");
    viewProfile(uid);
  });

  bindRates();
}

/*** ---------- Bind helpers ---------- ***/
function bindRates(){
  $$(".rate").forEach(el=>{
    el.addEventListener("click", async ()=>{
      const me = auth.currentUser;
      const uid = el.getAttribute("data-uid");
      const q = Number(el.getAttribute("data-q"));
      await rateUser(uid, me?.uid||null, q);
      // küçük yenilemeler
      if(location.hash.startsWith("#/u/")) viewProfile(uid);
      else viewDiscover();
      loadLeaderboard25(); // yan paneli tazele
    });
  });
}
function bindOpenProfileLinks(){
  $$(".open").forEach(el=>{
    el.addEventListener("click", ()=>{
      const uid = el.getAttribute("data-uid");
      location.hash = `#/u/${uid}`;
    });
  });
}

/*** ---------- Leaderboard side (Top 25) ---------- ***/
async function loadLeaderboard25(){
  const rows = await loadUsersBatch(120);
  rows.sort(byLCBDesc);
  $("#lb25").innerHTML = rows.slice(0,25).map((r,i)=> profileMiniRow(i+1,r)).join("");
}

/*** ---------- Router ---------- ***/
function route(){
  const h = location.hash || "#/discover";
  $$(".tab").forEach(t=>t.classList.remove("active"));
  if(h.startsWith("#/ranking")) $("#tabRanking").classList.add("active");
  else if(h.startsWith("#/network")) $("#tabNetwork").classList.add("active");
  else $("#tabDiscover").classList.add("active");

  if(h.startsWith("#/u/")){
    const uid = h.split("/")[2];
    viewProfile(uid);
  }else if(h.startsWith("#/ranking")){
    viewRanking();
  }else if(h.startsWith("#/network")){
    viewNetwork();
  }else{
    viewDiscover();
  }
}

/*** ---------- Auth state ---------- ***/
onAuthStateChanged(auth, async (user)=>{
  if(user){
    $("#btnSignIn").style.display="none";
    $("#btnSignOut").style.display="inline-flex";
    $("#userBadge").textContent = user.displayName || "Kullanıcı";
    await ensureUserDocs(user);
  }else{
    $("#btnSignIn").style.display="inline-flex";
    $("#btnSignOut").style.display="none";
    $("#userBadge").textContent = "";
  }
  await loadLeaderboard25();
  route();
});

window.addEventListener("hashchange", route);

// İlk yükleme
loadLeaderboard25(); route();

</script>
</body>
</html>
