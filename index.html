<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>piann — Gerçek değerini keşfet; skorun senin imzan</title>
<meta name="description" content="Yorum yok, gürültü yok; sadece puan ve sıralama. Gerçek değerini keşfet; skorun senin imzan.">
<style>
  :root{
    --bg:#f7f8fb; --ink:#0f172a; --muted:#64748b;
    --card:#ffffff; --line:#e6e9ef;
    --accent:#0A66C2; --accent-600:#0857A6;
    --ok:#10b981; --err:#ef4444;
    --container:max(320px, min(1200px, 92vw));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  a{color:inherit;text-decoration:none}
  .btn{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent-600);border-color:var(--accent-600)}
  .btn.ghost{background:#fff;border-color:var(--line)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--muted)}

  /* NAV */
  .nav{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .nav-inner{max-width:var(--container);margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:800;color:var(--accent)}
  .spacer{flex:1}
  .count{color:var(--muted);font-size:14px}

  /* RIBBON */
  .ribbon{background:#eef5ff;border-bottom:1px solid #d5e7ff}
  .ribbon .inner{max-width:var(--container);margin:0 auto;padding:8px 16px;color:#0a3e78;font-weight:600}

  /* DEBUG */
  #debug{display:none;background:#fff4f4;border-bottom:1px solid #ffd6d6;color:#991b1b;padding:8px 16px;font-size:14px}
  #debug b{color:#b91c1c}

  /* WRAPS */
  .wrap{max-width:var(--container);margin:24px auto 64px;padding:0 16px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 24px rgba(15,23,42,.04)}
  .hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
  .bd{padding:16px}
  .muted{color:var(--muted)}

  /* DISCOVER ROW */
  .row{display:grid;grid-template-columns:1fr 220px;gap:14px;align-items:center}
  .left{display:flex;gap:14px}
  .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#f2f3f7;border:1px solid var(--line)}
  .name{font-weight:800}
  .handle{color:var(--muted);font-size:14px}
  .bio{color:#1f2937;margin:8px 0 10px;font-size:15px;line-height:1.4}
  input[type=text]{padding:10px 12px;border:1px solid var(--line);border-radius:10px}
  .rightbox{background:#eef5ff;border:1px solid #d5e7ff;border-radius:12px;padding:20px;text-align:center}
  .score{font-weight:900;font-size:28px;color:#0a3e78}
  .sub{color:var(--muted);font-size:12px}

  /* TABLE */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{color:#111827}

  /* DUEL — NEW LOOK */
  .duel-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.duel-grid{grid-template-columns:1fr}}
  .duel-card{border:1px solid var(--line);border-radius:14px;background:#fff;padding:14px;display:flex;flex-direction:column;gap:12px;position:relative}
  .duel-head{display:flex;align-items:center;gap:12px}
  .duel-head img{width:64px;height:64px;border-radius:50%;border:1px solid var(--line)}
  .duel-title{font-weight:800}
  .rank-badge{position:absolute;top:12px;right:12px;background:#0a3e7833;color:#0a3e78;font-weight:800;border-radius:999px;padding:6px 10px;border:1px solid #cfe2ff}
  .bigscore{font-size:40px;font-weight:900;color:#0a3e78}
  .statline{display:flex;gap:10px;flex-wrap:wrap}
  .meta{font-size:13px;color:#475569}
  .duel-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .duel-footer{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:4px}
  .swap-tip{font-size:12px;color:#64748b}
  .skip-hint{font-size:12px;color:#64748b;text-align:center;margin-top:4px}

  footer{margin:32px 0;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-inner">
    <a href="#/" class="brand">piann</a>
    <a href="#/" class="btn">Ana sayfa</a>
    <a href="#/ranking" class="btn">Leaderboard</a>
    <div class="spacer"></div>
    <a href="#/profile/me" class="btn">Profil (Hakan)</a>
    <span id="memberCount" class="count">Üye: —</span>
  </div>
</nav>

<!-- SLOGAN -->
<div class="ribbon"><div class="inner">Gerçek değerini keşfet; skorun senin imzan.</div></div>

<!-- DEBUG BAR -->
<div id="debug"></div>

<!-- LAYOUT -->
<main class="wrap">
  <div class="grid">
    <!-- LEFT COLUMN -->
    <div>
      <!-- DUEL ARENA (single matchup) -->
      <section class="card" id="duelCard">
        <div class="hd">Düello Arenası</div>
        <div class="bd" id="duelStage">
          Yükleniyor…
        </div>
        <div class="bd" style="border-top:1px solid var(--line);display:flex;gap:8px;justify-content:space-between;align-items:center">
          <span class="swap-tip">İpucu: <b>Sağa kaydır</b> → atla • Klavye: <b>→</b> atla, <b>←</b> yer değiştir</span>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" id="btnSkip">Atla →</button>
            <button class="btn" id="btnShuffle">Karıştır (Yeni Düello)</button>
          </div>
        </div>
      </section>

      <!-- DISCOVER -->
      <section class="card" style="margin-top:16px">
        <div class="hd">Keşfet</div>
        <div class="bd" id="discoverBox">Yükleniyor…</div>
      </section>
    </div>

    <!-- RIGHT COLUMN -->
    <aside>
      <!-- MY RANK -->
      <section class="card">
        <div class="hd">Benim Sıram</div>
        <div class="bd" id="meCard">—</div>
      </section>

      <!-- TOP 50 -->
      <section class="card" style="margin-top:16px">
        <div class="hd">Top 50</div>
        <div class="bd" id="top50Wrap">Yükleniyor…</div>
      </section>

      <!-- LIVE TICKER -->
      <section class="card" style="margin-top:16px">
        <div class="hd">Canlı Aktivite</div>
        <div class="bd"><div class="ticker" id="ticker">—</div></div>
      </section>
    </aside>
  </div>
</main>

<!-- RANKING PAGE -->
<section id="pageRanking" class="wrap" style="display:none">
  <div class="card">
    <div class="hd">Leaderboard – İlk 500</div>
    <div class="bd">
      <div id="rankWrap">Yükleniyor…</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="btnPrev">Önceki</button>
        <span class="muted" id="pageInfo">—</span>
        <button class="btn" id="btnNext">Sonraki</button>
      </div>
    </div>
  </div>
</section>

<!-- PROFILE -->
<section id="pageProfile" class="wrap" style="display:none">
  <div class="card">
    <div class="hd">Profil</div>
    <div class="bd" id="profWrap">—</div>
  </div>
</section>

<footer>© piann.com — demo prototip</footer>

<script>
/* ====== Basit hata yakalama ====== */
(function(){
  const dbg=document.getElementById('debug');
  window.addEventListener('error', e=>{
    dbg.style.display='block';
    dbg.innerHTML = `<b>Hata:</b> ${e.message || e}`;
    console.error(e.error || e.message || e);
  });
  window.addEventListener('unhandledrejection', e=>{
    dbg.style.display='block';
    dbg.innerHTML = `<b>Hata:</b> ${e.reason && e.reason.message ? e.reason.message : e.reason}`;
    console.error(e.reason);
  });
})();

/* ===== Utilities ===== */
const $=(s)=>document.querySelector(s);
const to5=(n)=>Number.isFinite(n)?n.toFixed(5).replace('.',','):'—';
const clip=(x)=>Math.max(0,Math.min(100,x));
function lcb(sumMicro,sumSqMicro,n){
  if(!n||n<=0) return 0;
  const mean=(sumMicro/n)/1e5;
  let sd=25;
  if(n>1){
    const ex2=(sumSqMicro/n)/1e10;
    const ex =(sumMicro/n)/1e5;
    const variance=Math.max(0,ex2-ex*ex);
    sd=Math.sqrt(variance);
  }
  return clip(mean - 1.96*(sd/Math.sqrt(n)));
}
const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick=(arr,n)=>{const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a.slice(0,n)}
const shuffle=(a)=>pick(a,a.length);

/* ===== Yerel avatar ===== */
function initials(name){
  const parts = (name||'').trim().split(/\s+/);
  const a = (parts[0]||'').charAt(0);
  const b = (parts[1]||'').charAt(0);
  return (a+b).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,2) || 'P';
}
function avatarDataURL(name, tone='brand'){
  const bg = tone==='brand' ? '#0A66C2' : '#64748b';
  const txt = '#ffffff';
  const init = initials(name);
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'>
    <rect width='100' height='100' rx='50' ry='50' fill='${bg}'/>
    <text x='50%' y='56%' text-anchor='middle' dominant-baseline='middle'
      font-size='44' font-family='Arial, Helvetica, sans-serif' fill='${txt}'>${init}</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

/* ===== Seed Data (500 profiles) ===== */
const fixedPeople=["Cristiano Ronaldo","Lionel Messi","Kylian Mbappé","Erling Haaland","Neymar Jr",
"Elon Musk","Bill Gates","Mark Zuckerberg","Jeff Bezos","Tim Cook","Taylor Swift","Ariana Grande",
"Beyoncé","Ed Sheeran","Rihanna","Hakan Kocapüskül"];
const fixedBrands=["Coca-Cola","Pepsi","Nike","Adidas","Apple","Samsung","Microsoft","Google","Amazon","Tesla",
"BMW","Mercedes-Benz","Audi","Ferrari","Puma","Fenerbahçe","Galatasaray","Beşiktaş","Real Madrid","Barcelona"];

const firstNames=["Hakan","Zeynep","Mert","Ayşe","Efe","Deniz","Can","Selin","Emre","Derya","Barış","Seda","Kerem","Burak","Melis","Oğuzhan","Gizem","Cem","İrem","Ahmet","Mehmet","Fatma","Gamze","Onur","Ada","Cansu","Ömer","Yunus","Elif","Berk","Naz","Sinem","Tolga","Gökçe","Eda","Kaan","Yasemin","Hüseyin","Beril","Arda"];
const lastNames=["Yılmaz","Kaya","Demir","Çelik","Aydın","Koç","Arslan","Korkmaz","Kara","Şahin","Tunç","Öz","Taş","Can","Kurt","Uçar","Ege","Kır","Er","Polat","Aslan","Güneş","Yıldırım","Kaplan","Doğan","Sezer","Aksoy","Yalçın","Karaca","Işık","Öztürk","Yavuz","Bayraktar","Kılınç","Baş","Sarı","Taşkın","Tekin","Dağ","Uslu"];
const bios=["Kısa ve net: skor konuşur.","Her gün biraz daha iyi.","Veri takıntılı, kahve bağımlısı.",
"Sade, hızlı, net.","Takım oyuncusu.","Minimalist, sonuç odaklı.","Bugün daha iyi.","Deney ve öğren.",
"Puanlarınla şekilleniyorum.","Zirve radarımda.","Yarış ruhu yüksek.","Rakamlara inanırım."];

function makeId(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,16)||('id'+Math.random().toString(36).slice(2,8))}
function mkAgg(n,mean,sd){const sumMicro=Math.round(n*mean*1e5);const ex2=sd*sd+mean*mean;const sumSqMicro=Math.round(n*ex2*1e10);return{ratingCount:n,ratingSumMicro:sumMicro,ratingSumSqMicro:sumSqMicro,avgMicroCache:Math.floor(sumMicro/n)}}

const profiles=[];
function seedAll(){
  // Fixed celebs/people
  fixedPeople.forEach((name,i)=>{
    const id=(name==="Hakan Kocapüskül")?"me":makeId(name)+(i%3);
    const n=randInt(50,2500), m=randInt(55,95), sd=randInt(5,16);
    profiles.push({id,displayName:name,type:"person",tags:["celebrity"],photoURL:avatarDataURL(name,'person'),bio:bios[randInt(0,bios.length-1)],location:"",website:"",...mkAgg(n,m,sd)});
  });
  // Brands/Teams
  fixedBrands.forEach((name,i)=>{
    const id=makeId(name)+(i%3), n=randInt(80,3000), m=randInt(45,92), sd=randInt(5,16);
    const t=(["Fenerbahçe","Galatasaray","Beşiktaş","Real Madrid","Barcelona"].includes(name)?"team":"brand");
    profiles.push({id,displayName:name,type:t,tags:["popular"],photoURL:avatarDataURL(name,'brand'),bio:`${name} için topluluk skoru.`,location:"",website:"",...mkAgg(n,m,sd)});
  });
  // Generated persons to reach 500
  while(profiles.length<500){
    const fn=firstNames[randInt(0,firstNames.length-1)];
    const ln=lastNames[randInt(0,lastNames.length-1)];
    const name=`${fn} ${ln}`;
    const id=makeId(name)+randInt(0,9);
    const n=randInt(5,1500), m=randInt(40,90), sd=randInt(6,20);
    const locs=["İstanbul","Ankara","İzmir","Bursa","Tekirdağ","Antalya","Eskişehir","Konya","Gaziantep","Kayseri"];
    const webs=["","https://piann.com","https://example.com","https://linktr.ee/demo",""];
    profiles.push({id,displayName:name,type:"person",tags:["demo"],photoURL:avatarDataURL(name,'person'),bio:bios[randInt(0,bios.length-1)],location:locs[randInt(0,locs.length-1)],website:webs[randInt(0,webs.length-1)],...mkAgg(n,m,sd)});
  }
}

/* ===== Router ===== */
const views=['main','#pageRanking','#pageProfile'];
function showOnly(ids){views.forEach(id=>{const el=(id==='main')?document.querySelector('main'):$(id);if(el) el.style.display = ids.includes(id)?'block':'none';});}
function route(){
  const h=location.hash||'#/';
  if(h.startsWith('#/ranking')){ showOnly(['#pageRanking']); loadRanking(); return; }
  if(h.startsWith('#/profile/')){ const uid=h.split('/')[2]; showOnly(['#pageProfile']); renderProfile(uid); return; }
  showOnly(['main']); renderAllHome();
}

/* ===== Core helpers ===== */
function rankArray(list=profiles){
  const arr=list.filter(x=>x.ratingCount>0).map(x=>({id:x.id,name:x.displayName,count:x.ratingCount,score:lcb(x.ratingSumMicro,x.ratingSumSqMicro,x.ratingCount)}));
  arr.sort((a,b)=> b.score - a.score || b.count - a.count);
  return arr;
}
function rankOf(id){ const arr=rankArray(); const i=arr.findIndex(x=>x.id===id); return i>=0? i+1 : null; }
function percentileOf(id){
  const arr=rankArray(); const pos=arr.findIndex(x=>x.id===id); if(pos<0||arr.length===0) return {rank:'—',total:arr.length,p:0};
  const rank=pos+1, total=arr.length, p = Math.round((1 - (rank-1)/total)*100);
  return {rank,total,p};
}

/* ===== In-memory rating ===== */
const activityLog=[]; // {t,id,v}
function rateInMemory(targetId, val){
  if(targetId===window.__ME__.id){ alert('Kendini puanlayamazsın (demo).'); return; }
  const u=profiles.find(p=>p.id===targetId); if(!u) return;
  const micro=Math.round(val*1e5); const old=0; const deltaSum=micro-old; const deltaCnt=1;
  u.ratingSumMicro += deltaSum;
  u.ratingSumSqMicro += (micro*micro - old*old);
  u.ratingCount += deltaCnt;
  u.avgMicroCache = Math.floor(u.ratingSumMicro/u.ratingCount);
  activityLog.push({t:Date.now(), id:targetId, v:val});
}

/* ===== Home render ===== */
function renderAllHome(){ renderDuelSingle(); loadDiscover(); loadTop50(); renderMeCard(); renderTicker(); }

/* ===== DUEL — Single matchup ===== */
function idByName(name){ const p=profiles.find(x=>x.displayName===name); return p?.id; }
const duelNames = [
  ["Cristiano Ronaldo","Lionel Messi"],
  ["Coca-Cola","Pepsi"],
  ["Nike","Adidas"],
  ["Apple","Samsung"],
  ["Real Madrid","Barcelona"],
  ["Elon Musk","Bill Gates"],
  ["Taylor Swift","Rihanna"],
  ["BMW","Mercedes-Benz"]
];
let duelQueue = [];
let currentDuel = null;

function refillDuelQueue(){
  const base = duelNames.map(([a,b])=>{
    const la=idByName(a) || profiles[1].id; const rb=idByName(b) || profiles[2].id;
    return [la,rb];
  });
  // ayrıca rastgele 5 çift ekleyelim (ME hariç)
  const others = profiles.filter(p=>p.id!==window.__ME__.id);
  for(let i=0;i<5;i++){
    const [x,y] = pick(others,2);
    base.push([x.id,y.id]);
  }
  duelQueue = shuffle(base);
}
function nextDuel(){
  if(duelQueue.length===0) refillDuelQueue();
  currentDuel = duelQueue.shift();
  renderDuelSingle();
}
function shuffleDuel(){
  refillDuelQueue();
  nextDuel();
}
function swapDuel(){
  if(!currentDuel) return;
  currentDuel = [currentDuel[1], currentDuel[0]];
  renderDuelSingle();
}

function renderDuelSingle(){
  if(!currentDuel){ refillDuelQueue(); currentDuel = duelQueue.shift(); }
  const [leftId,rightId] = currentDuel;
  const L=profiles.find(p=>p.id===leftId), R=profiles.find(p=>p.id===rightId);
  const lS=lcb(L.ratingSumMicro,L.ratingSumSqMicro,L.ratingCount);
  const rS=lcb(R.ratingSumMicro,R.ratingSumSqMicro,R.ratingCount);
  const lRank=rankOf(L.id); const rRank=rankOf(R.id);
  const lMeta=(L.location?('📍 '+L.location):'') + (L.website?(' • 🔗 '+L.website):'');
  const rMeta=(R.location?('📍 '+R.location):'') + (R.website?(' • 🔗 '+R.website):'');

  $('#duelStage').innerHTML = `
    <div class="duel-grid" id="duelGrid">
      <!-- LEFT CARD -->
      <div class="duel-card" id="duelLeft">
        <div class="rank-badge">Rank #${lRank ?? '—'}</div>
        <div class="duel-head">
          <img src="${L.photoURL}" alt="">
          <div>
            <div class="duel-title">${L.displayName}</div>
            <div class="handle">@${L.id.slice(0,8)} • <span class="muted">${L.type}</span></div>
          </div>
        </div>
        <div class="statline">
          <span class="bigscore" id="scL">${to5(lS)}</span>
          <span class="pill">Oy: ${L.ratingCount}</span>
        </div>
        <div class="meta">${lMeta}</div>
        <div class="bio">${L.bio||''}</div>
        <div class="duel-actions">
          <button class="btn ql" data-v="70">70</button>
          <button class="btn ql" data-v="80">80</button>
          <button class="btn ql" data-v="90">90</button>
          <button class="btn ql" data-v="95">95</button>
          <input class="score-input" id="inL" type="text" placeholder="0–100 (örn: 92,50000)" style="max-width:200px">
          <button class="btn primary" id="btnRateL">Puanla</button>
        </div>
      </div>

      <!-- RIGHT CARD -->
      <div class="duel-card" id="duelRight">
        <div class="rank-badge">Rank #${rRank ?? '—'}</div>
        <div class="duel-head">
          <img src="${R.photoURL}" alt="">
          <div>
            <div class="duel-title">${R.displayName}</div>
            <div class="handle">@${R.id.slice(0,8)} • <span class="muted">${R.type}</span></div>
          </div>
        </div>
        <div class="statline">
          <span class="bigscore" id="scR">${to5(rS)}</span>
          <span class="pill">Oy: ${R.ratingCount}</span>
        </div>
        <div class="meta">${rMeta}</div>
        <div class="bio">${R.bio||''}</div>
        <div class="duel-actions">
          <button class="btn qr" data-v="70">70</button>
          <button class="btn qr" data-v="80">80</button>
          <button class="btn qr" data-v="90">90</button>
          <button class="btn qr" data-v="95">95</button>
          <input class="score-input" id="inR" type="text" placeholder="0–100 (örn: 87,00000)" style="max-width:200px">
          <button class="btn primary" id="btnRateR">Puanla</button>
        </div>
      </div>
    </div>

    <div class="duel-footer">
      <button class="btn ghost" id="chooseL">◀ Sol daha iyi</button>
      <button class="btn ghost" id="btnSwap">Yer değiştir</button>
      <button class="btn ghost" id="chooseR">Sağ daha iyi ▶</button>
    </div>
    <div class="skip-hint">Sağa kaydır → Düelloyu atla</div>
  `;

  // quick fill
  $('#duelLeft').querySelectorAll('.ql').forEach(b=> b.onclick=()=> $('#inL').value=b.dataset.v.replace('.',','));
  $('#duelRight').querySelectorAll('.qr').forEach(b=> b.onclick=()=> $('#inR').value=b.dataset.v.replace('.',','));

  // buttons
  $('#btnRateL').onclick=()=>{
    const v=Number(($('#inL').value||'').replace(',','.'));
    if(!isFinite(v)||v<=0||v>100){alert('0<puan≤100');return;}
    rateInMemory(L.id,v); afterScore();
  };
  $('#btnRateR').onclick=()=>{
    const v=Number(($('#inR').value||'').replace(',','.'));
    if(!isFinite(v)||v<=0||v>100){alert('0<puan≤100');return;}
    rateInMemory(R.id,v); afterScore();
  };
  $('#chooseL').onclick=()=>{ rateInMemory(L.id,92.5); rateInMemory(R.id,75); afterScore(true); };
  $('#chooseR').onclick=()=>{ rateInMemory(R.id,92.5); rateInMemory(L.id,75); afterScore(true); };
  $('#btnSwap').onclick=()=> swapDuel();
  $('#btnSkip').onclick=()=> nextDuel();
  $('#btnShuffle').onclick=()=> shuffleDuel();

  // keyboard shortcuts
  document.onkeydown=(e)=>{
    if(e.key==='ArrowRight'){ nextDuel(); }
    else if(e.key==='ArrowLeft'){ swapDuel(); }
  };

  // swipe to skip (right swipe)
  const grid = $('#duelGrid');
  let sx=null, sy=null;
  grid.addEventListener('touchstart', (ev)=>{ const t=ev.changedTouches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
  grid.addEventListener('touchend', (ev)=>{
    if(sx==null) return;
    const t=ev.changedTouches[0]; const dx=t.clientX - sx; const dy=t.clientY - sy;
    if(Math.abs(dx)>60 && Math.abs(dx)>Math.abs(dy) && dx>0){ nextDuel(); }
    sx=sy=null;
  }, {passive:true});

  function afterScore(confetti=false){
    if(confetti){
      ['#scL','#scR'].forEach(id=>{
        const el=$(id); el.style.transition='transform .15s'; el.style.transform='scale(1.1)'; setTimeout(()=>el.style.transform='scale(1)',180);
      });
    }
    // re-render current (scores & ranks may değişti)
    renderDuelSingle();
    loadTop50(); renderMeCard(); renderTicker();
  }
}

/* ===== DISCOVER (3) ===== */
function loadDiscover(){
  const box=$('#discoverBox'); box.textContent='Yükleniyor…';
  const candidates = profiles.filter(p=>p.id!==window.__ME__.id);
  const three = pick(candidates,3);
  const html = three.map(u=>{
    const s=lcb(u.ratingSumMicro,u.ratingSumSqMicro,u.ratingCount);
    return `
      <div class="card" style="margin-bottom:12px">
        <div class="bd">
          <div class="row">
            <div class="left">
              <img class="avatar" src="${u.photoURL}">
              <div style="flex:1">
                <div class="name">${u.displayName}</div>
                <div class="handle">@${u.id.slice(0,8)} • <span class="muted">${u.type}</span></div>
                <div class="bio">${u.bio||''}</div>
                <div class="muted" style="font-size:13px">${u.location?('📍 '+u.location):''} ${u.website?(' • 🔗 '+u.website):''}</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
                  <button class="btn q" data-id="${u.id}" data-v="70">70</button>
                  <button class="btn q" data-id="${u.id}" data-v="80">80</button>
                  <button class="btn q" data-id="${u.id}" data-v="90">90</button>
                  <button class="btn q" data-id="${u.id}" data-v="95">95</button>
                  <input class="score-input" data-id="${u.id}" type="text" placeholder="0–100 (örn: 88,75000)" style="max-width:200px">
                  <button class="btn primary save" data-id="${u.id}">Puanla</button>
                  <button class="btn ghost skip">Atla</button>
                  <a href="#/profile/${u.id}" class="btn">Profili gör</a>
                </div>
              </div>
            </div>
            <div class="rightbox">
              <div class="score">${to5(s)}</div>
              <div class="sub">Oy: ${u.ratingCount}</div>
            </div>
          </div>
        </div>
      </div>`;
  }).join('');
  box.innerHTML = html;

  box.querySelectorAll('.btn.q').forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.id, v=b.dataset.v;
      const inp=box.querySelector(`.score-input[data-id="${id}"]`);
      if(inp) inp.value=v.replace('.',',');
    };
  });
  box.querySelectorAll('.btn.save').forEach(b=>{
    b.onclick=()=>{
      const uid=b.dataset.id;
      const inp=box.querySelector(`.score-input[data-id="${uid}"]`);
      const v=Number((inp.value||'').replace(',','.'));
      if(!isFinite(v)||v<=0||v>100){alert('0<puan≤100');return;}
      rateInMemory(uid,v);
      loadDiscover(); loadTop50(); renderMeCard(); renderTicker();
    };
  });
  box.querySelectorAll('.btn.skip').forEach(b=> b.onclick=()=> loadDiscover());
}

/* ===== TOP 50 ===== */
function loadTop50(){
  const wrap=$('#top50Wrap'); wrap.textContent='Yükleniyor…';
  const arr = rankArray().slice(0,50);
  if(!arr.length){ wrap.textContent='Henüz veri yok.'; return; }
  let html='<table><thead><tr><th>#</th><th>Ad</th><th>Puan</th><th>Oy</th></tr></thead><tbody>';
  arr.forEach((u,i)=> html+=`<tr><td>${i+1}</td><td><a href="#/profile/${u.id}">${u.name}</a></td><td>${to5(u.score)}</td><td>${u.count}</td></tr>`);
  html+='</tbody></table>';
  wrap.innerHTML=html;
}

/* ===== ME CARD ===== */
function renderMeCard(){
  const me = window.__ME__;
  const cnt=me.ratingCount, s=lcb(me.ratingSumMicro,me.ratingSumSqMicro,cnt);
  const {rank,total,p} = percentileOf(me.id);
  const nextP = Math.min(99, Math.ceil(p/5)*5 + 5);
  const prog = Math.max(0, Math.min(100, (p/nextP)*100));
  $('#meCard').innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <img class="avatar" src="${me.photoURL}">
      <div>
        <div class="name">${me.displayName}</div>
        <div class="muted">@${me.id.slice(0,8)}</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <span class="pill">Puan: ${to5(s)}</span>
      <span class="pill">Oy: ${cnt}</span>
      <span class="pill">Sıra: ${rank} / ${total}</span>
      <span class="pill">%${p} dilim</span>
    </div>
    <div style="margin-top:12px">
      <div class="muted" style="margin-bottom:6px">Hedef: %${nextP} dilim</div>
      <div style="height:10px;border:1px solid #d5e7ff;border-radius:999px;overflow:hidden;background:#f0f6ff">
        <div style="height:100%;width:${prog}%;background:#0A66C2"></div>
      </div>
    </div>
  `;
}

/* ===== TICKER ===== */
function renderTicker(){
  const now=Date.now(), oneH=3600e3;
  const lastHour = activityLog.filter(a=> now-a.t<=oneH).length;
  const arr=rankArray();
  const hot = arr.slice(0,3);
  const msg = [
    `<span class="tick-b">Son 1 saatte <b>${lastHour}</b> puan</span>`,
    hot[0] ? `<span class="tick-b">Top #1: ${hot[0].name}</span>` : ``,
    hot[1] ? `<span class="tick-b">Top #2: ${hot[1].name}</span>` : ``,
    hot[2] ? `<span class="tick-b">Top #3: ${hot[2].name}</span>` : ``,
  ].filter(Boolean).join(' ');
  $('#ticker').innerHTML = msg || '<span class="muted">Henüz aktivite yok.</span>';
}

/* ===== RANKING PAGE ===== */
const paging={list:[],page:1,per:50};
function attachRankingButtons(){
  $('#btnPrev').onclick=()=>{ if(paging.page>1){ paging.page--; renderRankingPage(); } };
  $('#btnNext').onclick=()=>{ const max=Math.ceil(paging.list.length/paging.per)||1; if(paging.page<max){ paging.page++; renderRankingPage(); } };
}
function loadRanking(){
  const wrap=$('#rankWrap'); wrap.textContent='Yükleniyor…';
  const list=rankArray().slice(0,500);
  paging.list=list; paging.page=1; renderRankingPage();
}
function renderRankingPage(){
  const wrap=$('#rankWrap'); const start=(paging.page-1)*paging.per, end=start+paging.per;
  const pageItems=paging.list.slice(start,end);
  if(!pageItems.length){ wrap.textContent='Kayıt yok.'; $('#pageInfo').textContent='—'; return; }
  let html='<table><thead><tr><th>#</th><th>Ad</th><th>Puan</th><th>Oy</th><th>Profil</th></tr></thead><tbody>';
  pageItems.forEach((u,i)=> html+=`<tr><td>${start+i+1}</td><td>${u.name}</td><td>${to5(u.score)}</td><td>${u.count}</td><td><a href="#/profile/${u.id}">Gör</a></td></tr>`);
  html+='</tbody></table>'; wrap.innerHTML=html;
  const max=Math.ceil(paging.list.length/paging.per)||1; $('#pageInfo').textContent=`Sayfa ${paging.page}/${max}`;
}

/* ===== PROFILE PAGE ===== */
function renderProfile(uid){
  const box=$('#profWrap'); box.textContent='Yükleniyor…';
  const p=profiles.find(x=>x.id===uid)||profiles[0];
  const cnt=p.ratingCount||0; const s=lcb(p.ratingSumMicro,p.ratingSumSqMicro,cnt);
  const arr=rankArray(); const rank=arr.findIndex(x=>x.id===p.id)+1; const total=arr.length;
  box.innerHTML=`
    <div style="display:flex;gap:14px;align-items:center;margin-bottom:12px">
      <img class="avatar" src="${p.photoURL}">
      <div>
        <div class="name">${p.displayName}</div>
        <div class="muted">@${p.id.slice(0,8)} • ${p.type}${p.location?(' • '+p.location):''}</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <span class="pill">Puan: ${to5(s)}</span>
          <span class="pill">Oy: ${cnt}</span>
          <span class="pill">Sıra: ${rank||'—'} / ${total}</span>
        </div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        ${ uid===window.__ME__.id ? '' : '<button class="btn primary" id="btnRateOpen">Puan ver</button>'}
        <button class="btn" id="btnShare">Paylaş</button>
      </div>
    </div>
    <div class="bio">${p.bio||''}</div>
    <div class="muted" style="font-size:14px">${p.website?('🔗 '+p.website):''}</div>
    ${ uid===window.__ME__.id ? `<div class="muted" style="margin-top:8px">Bu demo sürümünde profil düzenleme kapalıdır.</div>`:`
      <div id="rateBox" style="margin-top:12px">
        <input id="rateInput" type="text" placeholder="0–100, 5 ondalık (örn: 89,12345)" style="max-width:220px">
        <button class="btn primary" id="btnRate">Puanla / Güncelle</button>
      </div>`}
  `;
  $('#btnShare').onclick=()=>{ const link=location.origin+location.pathname+'#/profile/'+p.id; navigator.clipboard?.writeText(link).then(()=> alert('Bağlantı kopyalandı: '+link)).catch(()=>alert(link)); };
  if(uid!==window.__ME__.id){
    $('#btnRateOpen') && ($('#btnRateOpen').onclick=()=> $('#rateInput').focus());
    $('#btnRate').onclick=()=>{
      const v=Number(($('#rateInput').value||'').replace(',','.'));
      if(!isFinite(v)||v<=0||v>100){alert('0<puan≤100');return;}
      rateInMemory(uid,v); renderProfile(uid); loadTop50(); renderMeCard(); renderTicker();
    };
  }
}

/* ===== Boot ===== */
function boot(){
  seedAll();
  window.__ME__ = profiles.find(p=>p.id==="me") || profiles[0];
  $('#memberCount').textContent = 'Üye: '+profiles.length;
  attachRankingButtons();
  route();
  // canlılık simülasyonu (hafif)
  setInterval(()=>{
    const target = profiles[randInt(0,profiles.length-1)];
    const val = randInt(60,95);
    rateInMemory(target.id, val);
    loadTop50(); renderMeCard(); renderTicker();
  }, 9000);
  console.log('Ready: profiles=', profiles.length);
}

document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
