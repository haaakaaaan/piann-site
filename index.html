<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>piann â€” keÅŸfet & puanlama (beta)</title>
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e6e9ef;
      --ink:#0f172a; --muted:#64748b;
      --accent:#0A66C2; --accent-50:#eef5ff; --accent-200:#c2dbfb;
      --accent-700:#0857A6; --ok:#10b981; --err:#ef4444;
      --radius:14px; --shadow:0 10px 24px rgba(15,23,42,.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    a{color:var(--accent-700);text-decoration:none} a:hover{text-decoration:underline}

    /* NAV */
    .nav{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .nav-inner{max-width:1160px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:800;color:var(--accent-700)}
    .spacer{flex:1}
    .count{color:var(--muted);font-size:14px}

    /* LAYOUT */
    .wrap{max-width:1160px;margin:24px auto 64px;padding:0 16px}
    .split{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width:1000px){.split{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:800}
    .bd{padding:16px}
    .muted{color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.primary:hover{background:var(--accent-700)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input[type=text]{width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;color:var(--ink)}
    table{width:100%;border-collapse:collapse} th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    tbody tr:hover{background:#f9fbff}
    .num{font-variant-numeric:tabular-nums}
    footer{margin:32px 0;text-align:center;color:var(--muted);font-size:12px}

    /* DISCOVER */
    .disco-grid{display:flex;flex-direction:column;gap:14px}
    .disco-card{display:grid;grid-template-columns:1fr 170px;gap:12px;padding:16px;border:1px solid var(--line);border-radius:12px;background:#fff}
    .disco-left{display:flex;flex-direction:column;gap:8px}
    .disco-head{display:flex;align-items:center;gap:10px}
    .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#f2f3f7;border:1px solid var(--line)}
    .handle{color:var(--muted);font-size:13px}
    .bio{font-size:14px;color:var(--muted);line-height:1.4;max-height:3.2em;overflow:hidden}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:3px 8px;border-radius:999px;border:1px solid var(--accent-200);background:#fff;color:var(--accent-700);font-size:12px}
    .quick{display:flex;gap:6px}
    .quick .q{padding:6px 10px;border:1px dashed var(--accent-200);border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
    .disco-actions{display:flex;gap:8px;flex-wrap:wrap}
    .disco-right{display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--accent-50);border-radius:10px;padding:10px}
    .disco-score{font-size:24px;font-weight:800;color:var(--accent)}
    .disco-rank{font-size:13px;color:var(--muted);margin-top:4px}

    /* === Login page (kurumsal sade) === */
    .login-wrap{
      min-height: calc(100vh - 60px);
      display:grid; grid-template-columns:1.1fr .9fr; gap:20px;
      align-items:center; justify-content:center; padding:40px 16px;
      max-width:1160px; margin:0 auto;
    }
    @media (max-width:980px){ .login-wrap{grid-template-columns:1fr} }
    .login-hero{
      background:linear-gradient(135deg,#0A66C2 0%, #3f8ce2 100%);
      border-radius:16px; color:#fff; padding:26px; box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.18);
    }
    .login-hero h1{margin:0 0 8px; font-size:28px}
    .login-hero p{margin:0 0 8px; color:#e7f2ff}
    .login-pts{display:grid; gap:8px; margin-top:10px}
    .login-pts span{display:flex; gap:8px; align-items:flex-start}
    .login-card{
      width:min(520px, 92vw);
      background:#fff; border:1px solid var(--line); border-radius:14px;
      box-shadow:0 18px 48px rgba(2,32,71,.08); justify-self:center;
    }
    .login-card .hd{ padding:18px 20px; border-bottom:1px solid var(--line); font-weight:800; }
    .login-card .bd{ padding:20px; }
    .login-title{ font-size:22px; font-weight:800; margin:0 0 6px }
    .login-sub{ color:var(--muted); margin:0 0 16px }
    .login-btn{ width:100%; display:flex; align-items:center; gap:10px;
      padding:12px 14px; border:1px solid var(--line); border-radius:10px;
      background:#fff; cursor:pointer; font-weight:600; margin-bottom:10px;
    }
    .login-btn:hover{ background:#f9fafb }
    .login-btn img{ width:20px; height:20px }
    .login-note{ font-size:12px; color:var(--muted); margin-top:8px }
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">piann</div>
      <a href="#/" class="btn">KeÅŸfet</a>
      <a href="#/rank" class="btn">Liderboard</a>
      <div class="spacer"></div>
      <span id="memberCount" class="count">Ãœye: â€”</span>
      <span id="ratedCount" class="count">Puanlanan: â€”</span>
      <a href="#/login" id="btnGoLogin" class="btn">GiriÅŸ</a>
      <a id="btnMyProfile" href="#/" class="btn" style="display:none">Profilim</a>
      <button id="btnSignOut" class="btn" style="display:none">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </div>

  <main class="wrap">
    <!-- LOGIN (sade) -->
    <section id="pageLogin" class="login-wrap" style="display:none">
      <div class="login-hero">
        <h1>SaygÄ±lÄ± puanlama, gÃ¼venli sÄ±ralama.</h1>
        <p>Tek gÃ¶rÃ¼nÃ¼r skor: <b>LCB</b> â€” dÃ¼ÅŸÃ¼k oylarda temkinli, Ã§ok oylarda gÃ¼venli.</p>
        <div class="login-pts">
          <span>âœ… 0â€“100 arasÄ± puan, 5 ondalÄ±k hassasiyet</span>
          <span>âœ… LCB sÄ±ralamasÄ±: Ortalama âˆ’ 1.96 Ã— (StdSapma / âˆšOy)</span>
          <span>âœ… Spam ve suistimal tespit kurallarÄ±</span>
        </div>
      </div>
      <div class="login-card">
        <div class="hd">GiriÅŸ yap</div>
        <div class="bd">
          <h2 class="login-title">piannâ€™a hoÅŸ geldin</h2>
          <p class="login-sub">KeÅŸfetmek, puan vermek ve sÄ±ralamaya girmek iÃ§in giriÅŸ yap.</p>

          <!-- Sadece Google ile devam et -->
          <button class="login-btn" id="btnLoginGoogle">
            <img alt="" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
            <span>Google ile devam et</span>
          </button>

          <div class="login-note">
            GiriÅŸle birlikte profilin oluÅŸturulur. <a href="#/privacy">Gizlilik</a> â€¢ <a href="#/terms">KullanÄ±m</a>
          </div>
        </div>
      </div>
    </section>

    <!-- HOME / DISCOVER -->
    <div class="split">
      <section id="pageHome" class="card" style="display:none">
        <div class="hd">KeÅŸfet</div>
        <div class="bd">
          <div id="discoverGrid" class="disco-grid"></div>
          <div class="row" style="margin-top:10px;justify-content:flex-end">
            <button id="btnDiscoRefresh" class="btn">Yenile</button>
          </div>
        </div>
      </section>
      <aside class="card" id="sideTop" style="display:none">
        <div class="hd">Top 10</div>
        <div class="bd" id="homeTop10">YÃ¼kleniyorâ€¦</div>
      </aside>
    </div>

    <!-- RANK -->
    <section id="pageRank" class="card" style="display:none">
      <div class="hd">Liderboard</div>
      <div class="bd">
        <div class="row" style="justify-content:space-between">
          <div class="muted">Sadece <b>en az 1 oy almÄ±ÅŸ</b> profiller gÃ¶sterilir.</div>
          <span class="pill" id="rankTotal">Puanlanan Ã¼ye: â€”</span>
        </div>
        <div style="height:10px"></div>
        <div id="rankTableWrap">YÃ¼kleniyorâ€¦</div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="pageProfile" class="card" style="display:none">
      <div class="hd">Profil</div>
      <div class="bd">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div class="row" style="align-items:center">
            <img id="profAvatar" class="avatar" style="width:96px;height:96px" alt="">
            <div style="margin-left:12px">
              <div id="profName" style="font-weight:800;font-size:20px">â€”</div>
              <div id="profHandle" class="handle">@â€”</div>
              <div class="row" style="margin-top:10px">
                <span class="chip">#<span id="kpiRank" class="num">â€”</span></span>
                <span class="chip">LCB <span id="kpiLCB" class="num">â€”</span></span>
                <span class="chip">Oy <span id="kpiVotes" class="num">â€”</span></span>
                <span class="chip" id="kpiTopWrap" style="display:none">Top <span id="kpiTop" class="num">â€”</span>%</span>
              </div>
            </div>
          </div>
          <div class="row">
            <button id="btnRateOpen" class="btn" style="display:none">Puan ver</button>
            <button id="btnShare" class="btn">PaylaÅŸ</button>
          </div>
        </div>

        <p id="profBio" class="muted" style="margin:10px 0 6px"></p>
        <div id="profMeta" class="muted" style="font-size:14px"></div>

        <div id="rateBox" class="row" style="margin-top:14px;display:none">
          <input id="scoreInput" type="text" placeholder="0â€“100, 5 ondalÄ±k (Ã¶rn: 89,12345)" style="max-width:220px" />
          <button id="btnRate" class="btn primary">Puanla / GÃ¼ncelle</button>
          <span id="rateMsg" class="muted"></span>
        </div>

        <h3 style="margin:18px 0 8px">AlÄ±nan Puanlar</h3>
        <div class="muted" style="margin:-6px 0 8px">Puan deÄŸerleri gizlidir; aÅŸaÄŸÄ±da yalnÄ±zca veren kiÅŸi ve tarih gÃ¶rÃ¼nÃ¼r.</div>
        <div id="receivedList" class="muted">YÃ¼kleniyorâ€¦</div>
      </div>
    </section>
  </main>

  <footer>Â© piann.com</footer>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    /* ===== Firebase config ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyCB71Ffsvv3y5QArsgauAC91lhjFiE5K8Q",
      authDomain: "piann-c58b8.firebaseapp.com",
      projectId: "piann-c58b8",
      storageBucket: "piann-c58b8.appspot.com",
      messagingSenderId: "1086334896697",
      appId: "1:1086334896697:web:7770adc7f9438be4a49be8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    /* ===== Helpers ===== */
    const $ = (s)=>document.querySelector(s);
    const toComma2 = (n)=> Number.isFinite(n)? (Math.round(n*100)/100).toFixed(2).replace('.', ',') : 'â€”';
    const normUrl = (u)=> u && !/^https?:\/\//i.test(u) ? ('https://' + u) : u;
    function clamp01_100(x){ return Math.max(0, Math.min(100, x)); }

    // LCB: mean âˆ’ 1.96 * (sd / sqrt(n))
    function lcbScoreFromAggregates(sumMicro, sumSqMicro, n){
      if(!n || n<=0) return 0;
      const mean = (sumMicro / n) / 100000; // 0..100
      let sd;
      if(n>1){
        const ex2 = (sumSqMicro / n) / 1e10;
        const ex  = (sumMicro / n) / 1e5;
        const variance = Math.max(0, ex2 - ex*ex);
        sd = Math.sqrt(variance);
      }else{ sd = 25; }
      const z = 1.96, se = sd / Math.sqrt(n);
      return clamp01_100(mean - z * se);
    }

    // ---- Rank map cache (1 dk) ----
    let _rankCache = { ts: 0, map: {}, total: 0 };
    async function getRankMap(){
      const now = Date.now();
      if (now - _rankCache.ts < 60_000 && _rankCache.total) return _rankCache;

      const qs = await db.collection('users').get();
      const arr = [];
      qs.forEach(d=>{
        const u = d.data(), c = u.ratingCount||0;
        if (c <= 0) return;
        const score = lcbScoreFromAggregates(u.ratingSumMicro||0, u.ratingSumSqMicro||0, c);
        arr.push({ id: d.id, score, count: c });
      });
      arr.sort((a,b)=> b.score - a.score || b.count - a.count);

      const map = {};
      arr.forEach((x,i)=> map[x.id] = i+1);
      _rankCache = { ts: now, map, total: arr.length };
      return _rankCache;
    }

    function parseScore(s){
      if(!s) return null; s=String(s).trim().replace(',', '.');
      const v=Number(s); if(!isFinite(v)) return null;
      const r=Math.round(v*100000)/100000;
      if(!(r>0 && r<=100)) return null;
      return {val:r, micro:Math.round(r*100000)};
    }

    /* ===== Auth state ===== */
    let me=null;
    auth.onAuthStateChanged(async (u)=>{
      me=u;

      // NAV gÃ¶rÃ¼nÃ¼rlÃ¼k
      $('#btnGoLogin').style.display = u ? 'none':'inline-block';
      $('#btnSignOut').style.display = u ? 'inline-block':'none';
      $('#btnMyProfile').style.display = u ? 'inline-block':'none';
      if(u) $('#btnMyProfile').href = '#/u/'+u.uid;

      if(u){
        await ensureUserDocs(u);
        await updateCounters();

        // login sayfasÄ±ndayken giriÅŸ yapÄ±ldÄ±ysa profilime gÃ¶nder
        if(location.hash.startsWith('#/login')){ location.hash = '#/u/'+u.uid; return; }
      }else{
        // GiriÅŸ yoksa her rotayÄ± login'e zorunlu yÃ¶nlendir
        if(!location.hash.startsWith('#/login')){ location.hash = '#/login'; return; }
      }
      router();
    });

    // Login tÄ±k
    $('#btnLoginGoogle').onclick = async ()=>{
      try{
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      }catch(err){
        if(err && (err.code==='auth/popup-blocked' || err.code==='auth/popup-closed-by-user')){
          try{ await auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider()); }
          catch(e2){ alert(e2.message); }
        }else{
          alert(err.message || 'GiriÅŸ baÅŸarÄ±sÄ±z.');
        }
      }
    };

    $('#btnSignOut').onclick = ()=> auth.signOut();

    async function ensureUserDocs(u){
      const uRef = db.collection('users').doc(u.uid);
      const uSnap= await uRef.get();
      if(!uSnap.exists){
        await uRef.set({
          displayName: u.displayName || u.email || null,
          photoURL: u.photoURL || null,
          joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
          ratingCount:0, ratingSumMicro:0, ratingSumSqMicro:0, avgMicroCache:0,
          givenCount:0, rand: Math.random()
        }, {merge:true});
      }else if(uSnap.exists && (uSnap.data().rand==null)){
        await uRef.set({ rand: Math.random() }, { merge:true });
      }
      const pRef = db.collection('profiles').doc(u.uid);
      const pSnap= await pRef.get();
      if(!pSnap.exists){
        const base = (u.displayName||u.email||'user').split(/[ @]/)[0].toLowerCase();
        await pRef.set({
          displayName: u.displayName || (u.email||'KullanÄ±cÄ±'),
          displayNameLower: (u.displayName||'KullanÄ±cÄ±').toLowerCase(),
          handle: base, handleLower: base,
          bio:'', location:'', website:'', photoURL: u.photoURL||'', coverURL:''
        }, {merge:true});
      }
    }

    async function updateCounters(){
      try{
        const s = await db.collection('users').get();
        $('#memberCount').textContent = 'Ãœye: ' + s.size;
        let rated=0; s.forEach(d=>{ if((d.data().ratingCount||0)>0) rated++; });
        $('#ratedCount').textContent = 'Puanlanan: ' + rated;
      }catch{}
    }

    /* ===== Home (Discover + Side Top10) â€” GiriÅŸ zorunlu ===== */
    async function renderHome(){
      showPage('home');
      await renderDiscover3();
      await renderHomeTop10();
      $('#btnDiscoRefresh').onclick = renderDiscover3;
    }

    async function renderHomeTop10(){
      const box = $('#homeTop10');
      box.textContent = 'YÃ¼kleniyorâ€¦';
      try{
        const qs = await db.collection('users').get();
        const arr=[];
        qs.forEach(doc=>{
          const u=doc.data(), c=u.ratingCount||0;
          if(c<=0) return;
          const score = lcbScoreFromAggregates(u.ratingSumMicro||0, u.ratingSumSqMicro||0, c);
          arr.push({id:doc.id, name:u.displayName||'(Ä°simsiz)', score, count:c});
        });
        arr.sort((a,b)=> b.score - a.score || b.count - a.count);
        const top=arr.slice(0,10);
        if(top.length===0){ box.textContent='Puanlanan Ã¼ye yok.'; return; }
        let html='<table><thead><tr><th>#</th><th>Ad</th><th>Puan</th></tr></thead><tbody>';
        top.forEach((u,i)=> html+=`<tr><td>${i+1}</td><td><a href="#/u/${u.id}">${u.name}</a></td><td class="num">${toComma2(u.score)}</td></tr>`);
        html+='</tbody></table><div style="text-align:right;margin-top:8px"><a href="#/rank">TÃ¼mÃ¼nÃ¼ gÃ¶r â†’</a></div>';
        box.innerHTML=html;
      }catch(e){ box.textContent='Hata: '+e.message; }
    }

    async function renderDiscover3(){
      const wrap = $('#discoverGrid');
      wrap.innerHTML = '';

      // AdaylarÄ± topla
      const excluded = await getExcludedIds(me.uid);
      const qs = await db.collection('users').limit(120).get();
      const cand=[];
      qs.forEach(d=>{
        if(d.id===me.uid) return;
        if(excluded.has(d.id)) return;
        const u=d.data();
        cand.push({
          uid:d.id,
          name:u.displayName||'(KullanÄ±cÄ±)',
          photo: u.photoURL || ('https://i.pravatar.cc/100?u='+d.id),
          cnt: u.ratingCount||0,
          sum: u.ratingSumMicro||0,
          sumsq: u.ratingSumSqMicro||0
        });
      });
      cand.sort(()=> Math.random()-0.5);

      // profile alanlarÄ±nÄ± ekle
      const pick = cand.slice(0,12);
      for(const c of pick){
        try{
          const ps = await db.collection('profiles').doc(c.uid).get();
          if(ps.exists){
            const p=ps.data();
            c.handle = p.handle || c.uid.slice(0,6);
            c.bio    = p.bio || '';
            if(p.photoURL) c.photo = p.photoURL;
          }else{
            c.handle = c.uid.slice(0,6);
            c.bio    = '';
          }
        }catch{ c.handle = c.uid.slice(0,6); c.bio=''; }
      }

      const three = pick.slice(0,3);
      if(three.length===0){
        wrap.innerHTML = '<div class="muted">GÃ¶sterilecek profil bulunamadÄ±.</div>';
        return;
      }

      const rm = await getRankMap();

      three.forEach(p=>{
        const lcb = lcbScoreFromAggregates(p.sum, p.sumsq, p.cnt);
        const rank = (p.cnt > 0 && rm.map[p.uid]) ? rm.map[p.uid] : null;
        const total = rm.total || null;
        wrap.appendChild(buildDiscoverCard({
          uid:p.uid, name:p.name, handle:p.handle, bio:p.bio, photo:p.photo,
          lcb: Number.isFinite(lcb)? lcb : null, cnt:p.cnt, isNew:(p.cnt||0)===0,
          rank, total
        }));
      });
    }

    function buildDiscoverCard(p){
      const el = document.createElement('div');
      el.className = 'disco-card';
      el.innerHTML = `
        <div class="disco-left">
          <div class="disco-head">
            <img class="avatar" src="${p.photo||''}" alt="">
            <div>
              <div style="font-weight:700">${p.name||'(KullanÄ±cÄ±)'}</div>
              <div class="handle">@${(p.handle||'user')}</div>
              <div class="chips" style="margin-top:6px">
                ${p.isNew ? `<span class="chip">Yeni</span>`:''}
                <span class="chip">Oy ${p.cnt||0}</span>
              </div>
            </div>
          </div>
          <div class="bio">${p.bio||''}</div>

          <div class="quick">
            <span class="q" data-q="70">70</span>
            <span class="q" data-q="80">80</span>
            <span class="q" data-q="90">90</span>
            <span class="q" data-q="95">95</span>
          </div>

          <div class="disco-actions">
            <input type="text" placeholder="0â€“100 (Ã¶rn: 88,75)" class="in-score" style="max-width:160px">
            <button class="btn primary btn-save">Kaydet</button>
            <button class="btn btn-skip">Atla</button>
            <a class="btn" href="#/u/${p.uid}">Profili gÃ¶r</a>
            <span class="muted msg"></span>
          </div>
        </div>

        <div class="disco-right">
          <div class="disco-score">${Number.isFinite(p.lcb)? toComma2(p.lcb) : 'â€”'}</div>
          <div class="disco-rank">
            ${ p.rank ? ('SÄ±ra: #'+p.rank+' / '+(p.total||'â€”'))
                      : ( (p.cnt||0)>0 ? 'SÄ±ra: â€”' : 'Yeni') }
          </div>
          <div class="disco-rank">Oy: ${p.cnt||0}</div>
        </div>
      `;

      const inScore = el.querySelector('.in-score');
      const btnSave = el.querySelector('.btn-save');
      const btnSkip = el.querySelector('.btn-skip');
      const msg     = el.querySelector('.msg');
      el.querySelectorAll('.q').forEach(ch => {
        ch.onclick = ()=>{ inScore.value = ch.dataset.q; inScore.focus(); };
      });

      btnSave.onclick = async ()=>{
        const parsed = parseScore(inScore.value);
        if(!parsed){ msg.textContent='GeÃ§ersiz deÄŸer'; return; }
        msg.textContent='Kaydediliyorâ€¦';
        try{
          await rateUser(p.uid, parsed.micro);
          await markSeen(p.uid);
          msg.textContent='Kaydedildi âœ”';
          el.style.opacity = .6;
          setTimeout(()=>{ el.remove(); }, 350);
        }catch(e){ msg.textContent='Hata: '+(e?.message||e); }
      };
      btnSkip.onclick = async ()=>{
        try{ await markSeen(p.uid); }catch{}
        el.style.opacity = .6;
        setTimeout(()=>{ el.remove(); }, 200);
      };

      return el;
    }

    async function getExcludedIds(myUid){
      const set = new Set();
      try{
        const g = await db.collection('users').doc(myUid).collection('given').limit(1000).get();
        g.forEach(d=> set.add(d.id));
      }catch{}
      try{
        const since = new Date(Date.now() - 14*24*60*60*1000);
        const s = await db.collection('users').doc(myUid).collection('discoverSeen')
                  .where('seenAt','>=', since).limit(1000).get();
        s.forEach(d=> set.add(d.id));
      }catch{}
      return set;
    }
    async function markSeen(targetUid){
      if(!me) return;
      const ref = db.collection('users').doc(me.uid).collection('discoverSeen').doc(targetUid);
      await ref.set({ seenAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    }

    async function rateUser(targetUid, newMicro){
      const meUser = auth.currentUser;
      if(!meUser) throw new Error('Ã–nce giriÅŸ yapÄ±n');
      if(meUser.uid===targetUid) throw new Error('Kendini puanlayamazsÄ±n');

      await db.runTransaction( async (tx)=>{
        const targetRef = db.collection('users').doc(targetUid);
        const rateRef   = targetRef.collection('ratings').doc(meUser.uid);
        const meRef     = db.collection('users').doc(meUser.uid);
        const givenRef  = meRef.collection('given').doc(targetUid);

        const tSnap = await tx.get(targetRef);
        if(!tSnap.exists) throw new Error('KullanÄ±cÄ± yok');

        const rSnap = await tx.get(rateRef);
        const mSnap = await tx.get(meRef);
        const gSnap = await tx.get(givenRef);

        const oldMicro = rSnap.exists ? (rSnap.data().micro||0) : 0;

        let ratingCount = tSnap.data().ratingCount||0;
        let ratingSum   = tSnap.data().ratingSumMicro||0;
        let ratingSumSq = tSnap.data().ratingSumSqMicro||0;

        if(!rSnap.exists){
          ratingCount += 1;
          ratingSum   += newMicro;
          ratingSumSq += (newMicro*newMicro);
        }else{
          ratingSum   += (newMicro - oldMicro);
          ratingSumSq += (newMicro*newMicro - oldMicro*oldMicro);
        }
        const avgMicroCache = ratingCount>0 ? Math.floor(ratingSum / ratingCount) : 0;

        tx.set(rateRef, {
          micro: newMicro,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: rSnap.exists ? rSnap.data().createdAt : firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        tx.set(targetRef, {
          ratingCount, ratingSumMicro:ratingSum, ratingSumSqMicro:ratingSumSq, avgMicroCache
        }, { merge:true });

        if(!gSnap.exists){
          const givenCount = (mSnap.exists ? (mSnap.data().givenCount||0) : 0) + 1;
          tx.set(meRef, { givenCount }, { merge:true });
          tx.set(givenRef, { createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        }
      });
    }

    /* ===== Rank page ===== */
    async function renderRank(){
      // giriÅŸ yoksa login'e
      if(!me){ location.hash = '#/login'; return; }
      showPage('rank');
      const wrap=$('#rankTableWrap'); wrap.textContent='YÃ¼kleniyorâ€¦';
      const qs=await db.collection('users').get();
      const arr=[];
      qs.forEach(doc=>{
        const u=doc.data(), c=u.ratingCount||0;
        if(c<=0) return;
        const score=lcbScoreFromAggregates(u.ratingSumMicro||0, u.ratingSumSqMicro||0, c);
        arr.push({id:doc.id, name:u.displayName||'(Ä°simsiz)', score, count:c});
      });
      $('#rankTotal').textContent='Puanlanan Ã¼ye: '+arr.length;
      arr.sort((a,b)=> b.score - a.score || b.count - a.count);
      if(arr.length===0){ wrap.textContent='Puanlanan Ã¼ye yok.'; return; }
      let html='<table><thead><tr><th>#</th><th>Ad</th><th>Puan</th><th>Oy</th><th>Profil</th></tr></thead><tbody>';
      arr.forEach((u,i)=> html+=`<tr><td>${i+1}</td><td>${u.name}</td><td class="num">${toComma2(u.score)}</td><td>${u.count}</td><td><a href="#/u/${u.id}">GÃ¶r</a></td></tr>`);
      html+='</tbody></table>'; wrap.innerHTML=html;
    }

    /* ===== Profile page ===== */
    let currentProfileUid=null;
    async function renderProfile(uid){
      if(!me){ location.hash = '#/login'; return; }
      showPage('profile'); currentProfileUid=uid;

      const uRef = db.collection('users').doc(uid);
      const uDoc = await uRef.get();
      if(!uDoc.exists){ $('#pageProfile .bd').innerHTML='<p class="muted">KullanÄ±cÄ± bulunamadÄ±.</p>'; return; }
      const udat=uDoc.data();
      const cnt=udat.ratingCount||0, sum=udat.ratingSumMicro||0, sumsq=udat.ratingSumSqMicro||0;

      if(cnt>0){
        const myScore = lcbScoreFromAggregates(sum, sumsq, cnt);
        $('#kpiLCB').textContent   = toComma2(myScore);
        $('#kpiVotes').textContent = String(cnt);

        const all=await db.collection('users').get();
        const arr=[];
        all.forEach(d=>{
          const x=d.data(); const c=x.ratingCount||0; if(c<=0) return;
          arr.push({id:d.id, score:lcbScoreFromAggregates(x.ratingSumMicro||0, x.ratingSumSqMicro||0, c), count:c});
        });
        arr.sort((a,b)=> b.score - a.score || b.count - a.count);
        const pos=arr.findIndex(x=>x.id===uid);
        $('#kpiRank').textContent = (pos>=0? pos+1 : 'â€”');
        if(arr.length>0 && pos>=0){
          const pct = Math.ceil(100 * (pos+1) / arr.length);
          $('#kpiTop').textContent = String(pct);
          $('#kpiTopWrap').style.display='inline-flex';
        }else{
          $('#kpiTopWrap').style.display='none';
        }
      }else{
        $('#kpiLCB').textContent   = 'â€”';
        $('#kpiVotes').textContent = '0';
        $('#kpiRank').textContent  = 'â€”';
        $('#kpiTopWrap').style.display='none';
      }

      const pRef=db.collection('profiles').doc(uid);
      const pDoc=await pRef.get();
      const p=pDoc.exists ? pDoc.data() : {
        displayName: udat.displayName||'(KullanÄ±cÄ±)', handle: uid.slice(0,6),
        bio:'', website:'', location:'', photoURL: udat.photoURL||''
      };
      $('#profName').textContent = p.displayName || '(KullanÄ±cÄ±)';
      $('#profHandle').textContent = '@'+(p.handle||uid.slice(0,6));
      $('#profBio').textContent = p.bio || '';
      $('#profAvatar').src = p.photoURL || '';
      const meta=[];
      if(p.location) meta.push('ðŸ“ '+p.location);
      if(p.website)  meta.push('ðŸ”— '+normUrl(p.website));
      $('#profMeta').textContent = meta.join('   ');

      const own = me && me.uid===uid;
      $('#btnRateOpen').style.display = own ? 'none' : 'inline-block';
      $('#rateBox').style.display     = own ? 'none' : 'flex';
      $('#btnShare').onclick = ()=>{
        const link = location.origin + '/#/u/' + uid;
        navigator.clipboard.writeText(link).then(()=> alert('BaÄŸlantÄ± kopyalandÄ±: ' + link));
      };

      loadReceived(uid);
    }

    async function loadReceived(uid){
      const box=$('#receivedList'); box.textContent='YÃ¼kleniyorâ€¦';
      try{
        const snap=await db.collection('users').doc(uid).collection('ratings').orderBy('updatedAt','desc').limit(20).get();
        if(snap.empty){ box.textContent='HenÃ¼z oy yok.'; return; }
        let html='<table><thead><tr><th>Veren</th><th>Tarih</th></tr></thead><tbody>';
        for(const d of snap.docs){
          const r=d.data();
          let who=d.id;
          try{ const pp=await db.collection('profiles').doc(d.id).get(); if(pp.exists){ const pd=pp.data(); who=pd.displayName || '@'+(pd.handle||d.id.slice(0,6)); } }catch{}
          const t = r.updatedAt && r.updatedAt.toDate ? r.updatedAt.toDate().toLocaleString() : '-';
          html+=`<tr><td>${who}</td><td>${t}</td></tr>`;
        }
        html+='</tbody></table>'; box.innerHTML=html;
      }catch(e){ box.textContent='Hata: '+e.message; }
    }

    // Profile inline rate
    $('#btnRate')?.addEventListener('click', async ()=>{
      const uid=currentProfileUid, msg=$('#rateMsg');
      if(!me){ msg.textContent='Ã–nce giriÅŸ yap.'; return; }
      if(me.uid===uid){ msg.textContent='Kendini puanlayamazsÄ±n.'; return; }
      const parsed = parseScore($('#scoreInput').value);
      if(!parsed){ msg.textContent='GeÃ§ersiz deÄŸer.'; return; }
      try{
        await rateUser(uid, parsed.micro);
        msg.textContent='Kaydedildi âœ”';
        renderProfile(uid);
      }catch(e){ msg.textContent='Hata: '+(e?.message||e); }
    });

    /* ===== Router ===== */
    function showPage(name){
      $('#pageLogin').style.display  = name==='login' ? 'grid':'none';
      $('#pageHome').style.display   = name==='home' ? 'block':'none';
      $('#pageRank').style.display   = name==='rank' ? 'block':'none';
      $('#pageProfile').style.display= name==='profile' ? 'block':'none';
      $('#sideTop').style.display    = name==='home' ? 'block':'none';
    }
    function router(){
      const h=location.hash||'#/login';
      if(h==='#/login'){ showPage('login'); return; }
      if(!me){ showPage('login'); return; } // gÃ¼venlik: giriÅŸ yoksa kilit
      if(h==='#/'||h==='#'){ renderHome(); return; }
      if(h.startsWith('#/rank')){ renderRank(); return; }
      if(h.startsWith('#/u/')){ renderProfile(h.split('/')[2]); return; }
      renderHome();
    }
    window.addEventListener('hashchange', router);
    router();

    // SayaÃ§lar (ilk yÃ¼kleme)
    updateCounters();
  </script>
</body>
</html>
