<!-- PROFILE VIEW CONTAINER (sayfada uygun yere koy) -->
<section id="profile-view"></section>

<script type="module">
/* ===== Imports (Firebase v10+) ===== */
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
  collection, getCountFromServer
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

/* ===== Init ===== */
const auth = getAuth();
const db   = getFirestore();

/* ===== Utilities ===== */
const microToScore = (micro) => (micro / 100000).toFixed(2);          // 2 ondalƒ±k (e.g., 87.53)
const clamp01 = (x) => Math.max(0, Math.min(1, x));
function computeLCB(ratingCount, ratingSumMicro, ratingSumSqMicro){
  if(!ratingCount || ratingCount < 1) return 0;
  // mean & sd (micro birim ‚Üí 0..10_000_000)
  const n   = ratingCount;
  const mu  = ratingSumMicro / n;                           // micro ort
  const varMicro = Math.max(0, (ratingSumSqMicro / n) - (mu*mu));
  const sd  = Math.sqrt(varMicro);
  const lcbMicro = mu - 1.96 * (sd / Math.sqrt(n));
  // 0..100‚Äôe kƒ±rp
  const lcb = Math.max(0, Math.min(100, lcbMicro / 100000));
  // 2 ondalƒ±k
  return Number(lcb.toFixed(2));
}

/* ===== Templating ===== */
function profileCSS(){
  return `
  <style id="profile-card-styles">
    .p-card{max-width:960px;margin:24px auto;padding:16px;border:1px solid #e6e9ef;border-radius:16px;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:#0f172a}
    .p-cover{height:160px;background:#f1f5f9;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .p-cover img{width:100%;height:100%;object-fit:cover}
    .p-head{display:flex;gap:16px;margin-top:-40px;align-items:flex-end}
    .p-avatar{width:96px;height:96px;border-radius:50%;border:4px solid #fff;background:#e2e8f0;overflow:hidden}
    .p-avatar img{width:100%;height:100%;object-fit:cover}
    .p-title{display:flex;flex-direction:column;gap:6px}
    .p-name{font-size:24px;font-weight:700}
    .p-handle{color:#64748b}
    .p-meta{display:flex;gap:12px;flex-wrap:wrap;color:#475569;font-size:14px;margin-top:4px}
    .p-bio{margin-top:12px;color:#334155}
    .p-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    button.p-btn{padding:8px 12px;border:1px solid #e2e8f0;background:#0A66C2;color:#fff;border-radius:10px;cursor:pointer;font-weight:600}
    button.p-btn.ghost{background:#fff;color:#0f172a}
    .p-stats{display:flex;gap:16px;margin-top:16px}
    .p-stat{flex:1;border:1px solid #e6e9ef;border-radius:12px;padding:12px}
    .p-stat .k{font-size:12px;color:#64748b}
    .p-stat .v{font-size:28px;font-weight:800}
    .p-edit{margin-top:16px;border:1px dashed #cbd5e1;border-radius:12px;padding:12px;display:none}
    .p-edit.visible{display:block}
    .p-edit label{display:block;font-size:12px;color:#64748b;margin-top:8px}
    .p-edit input,.p-edit textarea{width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:10px;margin-top:4px}
    .p-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .p-card2{border:1px solid #e6e9ef;border-radius:12px;padding:12px}
    .rate-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .rate-row input[type=number]{width:90px}
    .chip{font-size:12px;border:1px solid #e2e8f0;padding:6px 8px;border-radius:999px;cursor:pointer}
    .chip:hover{background:#f8fafc}
    .muted{color:#64748b}
    .link{color:#0A66C2;text-decoration:none}
  </style>`;
}

function profileHTML(state){
  const {
    meUid, uid, isOwner,
    profile, userAgg,
    isFollowing, lcb, avg, votes
  } = state;

  const displayName = profile?.displayName || "ƒ∞simsiz";
  const handle = profile?.handle ? "@"+profile.handle : "";
  const bio = profile?.bio || "Hen√ºz bio yok.";
  const website = profile?.website || "";
  const location = profile?.location || "";
  const photoURL = profile?.photoURL || "";
  const coverURL = profile?.coverURL || "";

  return `
  ${profileCSS()}
  <div class="p-card">
    <div class="p-cover">${coverURL ? `<img src="${coverURL}" alt="">` : `<span class="muted">Kapak g√∂rseli</span>`}</div>

    <div class="p-head">
      <div class="p-avatar">${photoURL ? `<img src="${photoURL}" alt="">` : ""}</div>
      <div class="p-title">
        <div class="p-name">${displayName}</div>
        <div class="p-handle">${handle}</div>
        <div class="p-meta">
          ${location ? `<span>üìç ${location}</span>` : ``}
          ${website ? `<a class="link" href="${website}" target="_blank" rel="noopener">üîó ${website}</a>` : ``}
          <span class="muted">UID: ${uid.slice(0,6)}‚Ä¶</span>
        </div>
      </div>
      <div class="p-actions">
        <button class="p-btn ghost" id="shareBtn">Payla≈ü</button>
        ${isOwner
          ? `<button class="p-btn" id="editToggle">Profili D√ºzenle</button>`
          : (meUid ? `<button class="p-btn" id="followBtn">${isFollowing ? "Takibi Bƒ±rak" : "Takip Et"}</button>` : ``)
        }
      </div>
    </div>

    <div class="p-stats">
      <div class="p-stat">
        <div class="k">LCB</div>
        <div class="v">${lcb.toFixed(2)}</div>
      </div>
      <div class="p-stat">
        <div class="k">Ortalama</div>
        <div class="v">${avg}</div>
      </div>
      <div class="p-stat">
        <div class="k">Oy Sayƒ±sƒ±</div>
        <div class="v">${votes}</div>
      </div>
    </div>

    <div class="p-grid">
      <div class="p-card2">
        <div class="p-bio">${bio}</div>
      </div>

      <div class="p-card2">
        ${isOwner
          ? `<div class="muted">Kendi profilin: puan veremezsin.</div>`
          : (meUid ? `
              <div><strong>Puan Ver</strong> (0‚Äì100)</div>
              <div class="rate-row">
                <input type="number" id="rateInput" min="1" max="100" step="0.01" placeholder="87.50" />
                <button class="p-btn" id="rateBtn">Puanla</button>
              </div>
              <div class="rate-row">
                <span class="chip" data-q="70">70</span>
                <span class="chip" data-q="80">80</span>
                <span class="chip" data-q="90">90</span>
                <span class="chip" data-q="95">95</span>
              </div>
              <div class="muted" style="margin-top:6px;">Puan veren anonim kalƒ±r.</div>
            ` : `<div class="muted">Puan vermek i√ßin giri≈ü yap.</div>` )
        }
      </div>
    </div>

    <div class="p-edit" id="editPane">
      <div><strong>Profil D√ºzenle</strong></div>
      <label>Ad</label><input id="fDisplayName" value="${profile?.displayName || ""}" />
      <label>Handle (a‚Äìz, 0‚Äì9, _)</label><input id="fHandle" value="${profile?.handle || ""}" />
      <label>Bio</label><textarea id="fBio" rows="3">${profile?.bio || ""}</textarea>
      <label>Website</label><input id="fWebsite" value="${website}" />
      <label>Konum</label><input id="fLocation" value="${location}" />
      <label>Foto URL</label><input id="fPhoto" value="${photoURL}" />
      <label>Kapak URL</label><input id="fCover" value="${coverURL}" />
      <div style="margin-top:10px;display:flex;gap:8px;">
        <button class="p-btn" id="saveProfile">Kaydet</button>
        <button class="p-btn ghost" id="cancelEdit">ƒ∞ptal</button>
      </div>
    </div>
  </div>`;
}

/* ===== Firestore IO ===== */
async function fetchProfile(uid){
  const pRef = doc(db, "profiles", uid);
  const uRef = doc(db, "users", uid);
  const [pSnap, uSnap] = await Promise.all([getDoc(pRef), getDoc(uRef)]);
  return { profile: pSnap.exists() ? pSnap.data() : null, userAgg: uSnap.exists() ? uSnap.data() : null };
}

async function isFollowing(meUid, targetUid){
  if(!meUid) return false;
  const fRef = doc(db, "users", meUid, "following", targetUid);
  const fSnap = await getDoc(fRef);
  return fSnap.exists();
}

async function toggleFollow(meUid, targetUid){
  const fRef = doc(db, "users", meUid, "following", targetUid);
  const now = serverTimestamp();
  const exists = (await getDoc(fRef)).exists();
  if(exists){
    await updateDoc(fRef, { updatedAt: now }); // or delete; kural izin veriyor
    // delete tercih ediyorsan:
    // await deleteDoc(fRef);
  }else{
    await setDoc(fRef, { createdAt: now, updatedAt: now });
  }
}

async function sendRating(targetUid, meUid, score){
  // score: 0..100 ‚Üí micro
  const micro = Math.round(score * 100000);
  if(micro < 1 || micro > 10000000) throw new Error("Puan aralƒ±k dƒ±≈üƒ±");
  const rRef = doc(db, "users", targetUid, "ratings", meUid);
  const now = serverTimestamp();
  // create/update (Cloud Functions'ta agregat g√ºncelleyeceƒüiz ‚Äì Adƒ±m 6)
  // ≈üimdilik client tarafƒ± only: doc kurallarƒ± throttle & sƒ±nƒ±rlarƒ± kontrol ediyor.
  const snap = await getDoc(rRef);
  if(snap.exists()){
    await updateDoc(rRef, { micro, updatedAt: now });
  }else{
    await setDoc(rRef, { micro, createdAt: now, updatedAt: now });
  }
}

/* ===== Page Controller ===== */
async function renderProfilePage(uid){
  const container = document.getElementById("profile-view");
  const me = auth.currentUser;
  const meUid = me?.uid || null;

  const {profile, userAgg} = await fetchProfile(uid);
  const votes = userAgg?.ratingCount || 0;
  const avg = userAgg?.ratingCount
    ? microToScore(userAgg.ratingSumMicro / userAgg.ratingCount)
    : "‚Äî";
  const lcb = computeLCB(
    userAgg?.ratingCount || 0,
    userAgg?.ratingSumMicro || 0,
    userAgg?.ratingSumSqMicro || 0
  );
  const owner = meUid && meUid === uid;
  const fol = await isFollowing(meUid, uid);

  const state = {
    meUid, uid, isOwner: owner,
    profile, userAgg, isFollowing: fol,
    lcb, avg, votes
  };
  container.innerHTML = profileHTML(state);

  // Actions
  const shareBtn = document.getElementById("shareBtn");
  if(shareBtn){
    shareBtn.onclick = async () => {
      const url = `${location.origin}${location.pathname}#/u/${uid}`;
      try{
        await navigator.clipboard.writeText(url);
        shareBtn.textContent = "Kopyalandƒ±!";
        setTimeout(()=> shareBtn.textContent = "Payla≈ü", 1200);
      }catch{ window.alert(url); }
    };
  }

  const followBtn = document.getElementById("followBtn");
  if(followBtn){
    followBtn.onclick = async () => {
      if(!meUid){ alert("√ñnce giri≈ü yap."); return; }
      await toggleFollow(meUid, uid);
      await renderProfilePage(uid); // refresh
    };
  }

  const chips = [...document.querySelectorAll(".chip")];
  const rateInput = document.getElementById("rateInput");
  chips.forEach(c => c.addEventListener("click", () => {
    const q = Number(c.dataset.q || "0");
    rateInput.value = q.toFixed(2);
  }));

  const rateBtn = document.getElementById("rateBtn");
  if(rateBtn){
    rateBtn.onclick = async () => {
      const val = Number(rateInput.value);
      if(!(val > 0 && val <= 100)){ alert("Puan 0‚Äì100 arasƒ± olmalƒ±."); return; }
      await sendRating(uid, meUid, val);
      await renderProfilePage(uid); // refresh stats
    };
  }

  const editToggle = document.getElementById("editToggle");
  const editPane = document.getElementById("editPane");
  if(editToggle && editPane){
    editToggle.onclick = () => editPane.classList.toggle("visible");
  }
  const cancelEdit = document.getElementById("cancelEdit");
  if(cancelEdit){ cancelEdit.onclick = () => editPane.classList.remove("visible"); }

  const saveBtn = document.getElementById("saveProfile");
  if(saveBtn){
    saveBtn.onclick = async () => {
      const pRef = doc(db, "profiles", uid);
      const patch = {
        displayName: document.getElementById("fDisplayName").value.trim(),
        handle: document.getElementById("fHandle").value.trim(),
        bio: document.getElementById("fBio").value.trim(),
        website: document.getElementById("fWebsite").value.trim(),
        location: document.getElementById("fLocation").value.trim(),
        photoURL: document.getElementById("fPhoto").value.trim(),
        coverURL: document.getElementById("fCover").value.trim(),
        updatedAt: serverTimestamp(),
      };
      await setDoc(pRef, patch, { merge:true });
      await renderProfilePage(uid);
    };
  }
}

/* ===== Router glue (#/u/{uid}) ===== */
function getUidFromHash(){
  const m = location.hash.match(/^#\/u\/([^\/?#]+)/);
  return m ? m[1] : null;
}
async function handleRoute(){
  const uid = getUidFromHash();
  if(!uid){
    document.getElementById("profile-view").innerHTML =
      '<div class="p-card"><div class="muted">Profil bulunamadƒ±.</div></div>';
    return;
  }
  await renderProfilePage(uid);
}
window.addEventListener("hashchange", handleRoute);
onAuthStateChanged(auth, handleRoute);
handleRoute();
</script>
