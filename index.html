<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>piann ‚Äî puan & sƒ±ralama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#8ec5ff; --bg2:#156fbf;           /* daha a√ßƒ±k LinkedIn mavisi gradyan */
      --panel: rgba(11, 62, 119, .88);
      --panel-border: rgba(159, 210, 255, .28);
      --line: rgba(159, 210, 255, .18);
      --fg:#F3F8FF; --muted:#D9E9FF;
      --accent:#0A66C2; --accent-2:#9FD2FF;
      --green:#34d399; --red:#ef4444;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Arial,sans-serif; color:var(--fg);
      background:
        radial-gradient(900px 500px at 100% 0%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(900px 500px at 0% 100%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
    }
    a{color:#eef6ff; text-decoration:none}

    .nav{ position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, rgba(8,87,166,.50), rgba(8,87,166,.32));
      backdrop-filter:blur(10px); border-bottom:1px solid var(--panel-border)}
    .nav-inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center}
    .brand{font-weight:700;letter-spacing:.2px}.spacer{flex:1}

    .btn{padding:10px 14px;border:1px solid rgba(255,255,255,.18);background:var(--panel);color:#fff;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.accent{background:linear-gradient(90deg,#0857A6,#0A66C2);border-color:rgba(255,255,255,.25)}
    .btn.small{padding:8px 10px;font-size:14px}.btn.ghost{background:transparent;border-color:var(--panel-border)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .wrap{max-width:1100px;margin:26px auto 64px;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--panel-border);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.35)}
    .hd{padding:14px 16px;border-bottom:1px solid var(--panel-border);font-weight:700}
    .bd{padding:16px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{color:#f4f9ff;font-weight:700}

    .pill{font-size:12px;color:#eef6ff;background:rgba(10,102,194,.18);border:1px solid var(--panel-border);border-radius:999px;padding:4px 8px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type=text], textarea{background:#0b1220;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:10px 12px;min-width:220px}
    textarea{min-height:80px;width:100%;resize:vertical}
    .avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--panel);background:#0a0f1c}
    .center{text-align:center}
    .bar{height:10px;background:rgba(255,255,255,.16);border-radius:6px;overflow:hidden;flex:1}
    .fill{height:100%;background:var(--accent-2)}
    .err{color:var(--red)} .ok{color:var(--green)}

    /* X tarzƒ± profil */
    .profile-card{overflow:hidden;padding:0}
    .cover{height:180px;background:#123a73;background-size:cover;background-position:center;border-top-left-radius:16px;border-top-right-radius:16px}
    .profile-main{padding:16px}
    .avatar-wrap{position:relative;margin-top:-60px;display:flex;align-items:end;justify-content:space-between}
    .avatar-left{display:flex;align-items:end;gap:12px}
    .name{font-size:22px;font-weight:800}.handle{color:#cbe3ff;font-size:14px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .meta{display:flex;gap:12px;flex-wrap:wrap;color:#d9e9ff;font-size:14px}
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--panel-border);margin-top:12px}
    .tab{padding:10px 12px;border-bottom:2px solid transparent;cursor:pointer}
    .tab.active{border-color:#9FD2FF;font-weight:700}
    .profile-section{padding-top:12px}

    /* Arama */
    .search{position:relative;min-width:220px;flex:1;max-width:340px}
    .search input{width:100%;padding:8px 12px 8px 36px;border-radius:12px;border:1px solid var(--panel-border);background:rgba(0,0,0,.25);color:#fff}
    .search::before{content:"üîé";position:absolute;left:10px;top:6px;opacity:.8}
    .drop{position:absolute;top:42px;left:0;right:0;background:var(--panel);border:1px solid var(--panel-border);border-radius:12px;box-shadow:0 15px 40px rgba(0,0,0,.35);overflow:hidden}
    .drop.hidden{display:none}
    .drop-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-bottom:1px solid var(--line);cursor:pointer}
    .drop-item:hover{background:rgba(255,255,255,.06)}
    .drop-item img{width:28px;height:28px;border-radius:50%;object-fit:cover}
    .drop-item .h{font-weight:700}
    .drop-empty{padding:10px;color:var(--muted)}
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">piann</div>
      <a href="#/" class="btn small">Ana sayfa</a>
      <a href="#/rank" class="btn small">Liderboard</a>

      <!-- Hƒ±zlƒ± arama -->
      <div class="search">
        <input id="q" type="text" placeholder="Kullanƒ±cƒ± ara (ad veya @handle)" autocomplete="off" />
        <div id="qDrop" class="drop hidden"></div>
      </div>

      <span class="spacer"></span>
      <span class="muted" id="memberCount">√úye: ‚Äî</span>
      <span class="spacer" style="flex:0"></span>
      <button id="btnSignIn" class="btn accent small">Google ile giri≈ü yap</button>
      <a id="btnMyProfile" href="#/" class="btn small" style="display:none">Profilim</a>
      <button id="btnSignOut" class="btn small" style="display:none">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <main class="wrap">
    <!-- HOME -->
    <section id="pageHome" class="card" style="display:none">
      <div class="hd">Ho≈ü geldin</div>
      <div class="bd">
        <div class="grid">
          <div>
            <p class="muted">Google ile giri≈ü yap, profilin otomatik olu≈üsun. Diƒüer √ºyeler 0‚Äì100 arasƒ± (5 ondalƒ±k) puan verebilir. Profil puanƒ±n, verilen t√ºm puanlarƒ±n <b>aritmetik ortalamasƒ±</b>dƒ±r.</p>
            <div class="row" style="margin-top:8px">
              <button id="homeGoProfile" class="btn">Profilime git</button>
              <a href="#/rank" class="btn">Liderboard‚Äôu g√∂r</a>
            </div>
          </div>
          <div>
            <h3 style="margin:0 0 8px">Top 10</h3>
            <div id="homeTop10" class="muted">Y√ºkleniyor‚Ä¶</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RANK -->
    <section id="pageRank" class="card" style="display:none">
      <div class="hd">Liderboard</div>
      <div class="bd">
        <div class="row" style="justify-content:space-between">
          <div class="muted">√úyeler ortalama puana g√∂re sƒ±ralƒ±.</div>
          <div class="row"><span class="pill" id="rankTotal">Toplam √ºye: ‚Äî</span></div>
        </div>
        <div style="height:10px"></div>
        <div id="rankTableWrap">Y√ºkleniyor‚Ä¶</div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="pageProfile" class="card profile-card" style="display:none">
      <div id="profCover" class="cover"></div>
      <div class="profile-main">
        <div class="avatar-wrap">
          <div class="avatar-left">
            <img id="profAvatar" class="avatar" alt="">
            <div>
              <div id="profName" class="name">‚Äî</div>
              <div id="profHandle" class="handle">@‚Äî</div>
            </div>
          </div>
          <div class="actions">
            <button id="btnShare" class="btn small ghost">Payla≈ü</button>
            <button id="btnEdit" class="btn small" style="display:none">Profili d√ºzenle</button>
            <button id="btnRateOpen" class="btn small" style="display:none">Puan ver</button>
          </div>
        </div>

        <div id="profBio" class="profile-section muted" style="margin-top:8px"></div>
        <div class="profile-section meta" id="profMeta"></div>

        <div class="profile-section row" style="gap:12px">
          <span class="pill" id="profAvg">Ortalama: ‚Äî</span>
          <span class="pill" id="profCount">Oy: ‚Äî</span>
          <span class="pill" id="profRank">Sƒ±ra: ‚Äî</span>
        </div>

        <div class="tabs">
          <div id="tabOverview" class="tab active">Overview</div>
          <div id="tabReceived" class="tab">Ratings Received</div>
        </div>

        <div id="tabContent" class="profile-section">
          <div id="overviewPane">
            <p class="muted">√ñzet bilgiler ve profil metni √ºstte. ‚ÄúPuan ver‚Äù ile bu profile 0‚Äì100 (5 ondalƒ±k) arasƒ± puan verebilirsin.</p>
          </div>
          <div id="receivedPane" style="display:none">
            <div class="muted" id="receivedList">Y√ºkleniyor‚Ä¶</div>
          </div>

          <!-- Rate box (yalnƒ±zca ba≈ükasƒ±nƒ±n profilinde g√∂r√ºn√ºr) -->
          <div id="rateBox" class="row" style="margin-top:14px; display:none">
            <input id="scoreInput" type="text" placeholder="0‚Äì100, 5 ondalƒ±k (√∂rn: 89,12345)" />
            <button id="btnRate" class="btn">Puanla / G√ºncelle</button>
            <span id="rateMsg" class="muted"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="center muted">¬© piann.com</footer>

  <!-- EDIT MODAL (URL ile) -->
  <div id="editBack" class="modal-back" style="display:none; align-items:center; justify-content:center; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:50">
    <div class="modal" style="width:min(680px,92vw);background:var(--panel);border:1px solid var(--panel-border);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.5)">
      <div class="hd" style="display:flex;align-items:center;justify-content:space-between">
        <span>Profili d√ºzenle</span>
        <button id="editClose" class="btn small ghost">Kapat</button>
      </div>
      <div class="bd" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="full" style="grid-column:1/-1">
          <label class="muted">G√∂r√ºnen ad</label>
          <input id="edName" type="text" placeholder="Ad Soyad" style="width:100%">
        </div>
        <div>
          <label class="muted">Kullanƒ±cƒ± adƒ± (@)</label>
          <input id="edHandle" type="text" placeholder="ornek_kullanici">
          <small style="font-size:12px;color:#cfe7ff">3‚Äì15, harf-rakam-alt√ßizgi. Benzersiz olmalƒ±.</small>
        </div>
        <div>
          <label class="muted">Web sitesi</label>
          <input id="edWeb" type="text" placeholder="https://...">
        </div>
        <div class="full" style="grid-column:1/-1">
          <label class="muted">Bio</label>
          <textarea id="edBio" maxlength="160" placeholder="Kƒ±sa bio (‚â§160)"></textarea>
        </div>
        <div>
          <label class="muted">Konum</label>
          <input id="edLoc" type="text" placeholder="ƒ∞stanbul, TR">
        </div>
        <div>
          <label class="muted">Avatar (URL)</label>
          <input id="edAvatar" type="text" placeholder="https://...">
        </div>
        <div class="full" style="grid-column:1/-1">
          <label class="muted">Kapak (URL)</label>
          <input id="edCover" type="text" placeholder="https://...">
        </div>
        <div class="full row" style="justify-content:flex-end">
          <span id="edMsg" class="muted"></span>
          <button id="edSave" class="btn accent">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    /* Firebase config ‚Äî piann-c58b8 */
    const firebaseConfig = {
      apiKey: "AIzaSyCB71Ffsvv3y5QArsgauAC91lhjFiE5K8Q",
      authDomain: "piann-c58b8.firebaseapp.com",
      projectId: "piann-c58b8",
      storageBucket: "piann-c58b8.appspot.com",
      messagingSenderId: "1086334896697",
      appId: "1:1086334896697:web:7770adc7f9438be4a49be8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* ==== Yardƒ±mcƒ±lar ==== */
    const $ = (s)=>document.querySelector(s);
    const pages = {home:$('#pageHome'), rank:$('#pageRank'), profile:$('#pageProfile')};
    const elMemberCount = $('#memberCount');
    const btnIn = $('#btnSignIn'), btnOut=$('#btnSignOut'), btnMy=$('#btnMyProfile'), homeGoProfile=$('#homeGoProfile');

    function showPage(name){
      pages.home.style.display = name==='home' ? 'block':'none';
      pages.rank.style.display = name==='rank' ? 'block':'none';
      pages.profile.style.display = name==='profile' ? 'block':'none';
    }
    const toComma = (n)=> n.toFixed(5).replace('.', ',');
    const parseScore = (s)=>{
      if(!s) return null;
      s = String(s).trim().replace(',', '.');
      const v = Number(s);
      if(!isFinite(v)) return null;
      const r = Math.round(v*100000)/100000;
      if(!(r>0 && r<=100)) return null;
      const micro = Math.round(r*100000);
      return {val:r, micro};
    };
    const normUrl = (u)=> u && !/^https?:\/\//i.test(u) ? ('https://' + u) : u;
    const slugHandle = (s)=>{
      if(!s) return '';
      s = s.toString().trim().toLowerCase();
      s = s.replace(/[^a-z0-9_]+/g,'_').replace(/_+/g,'_');
      if(s.length<3) s = s.padEnd(3,'0');
      if(s.length>15) s = s.slice(0,15);
      return s;
    };
    async function ensureHandleUnique(base, myUid){
      const q = await db.collection('profiles').where('handleLower','==', base).limit(1).get();
      if(q.empty) return base;
      const doc = q.docs[0];
      if(doc.id === myUid) return base;
      return base + Math.floor(Math.random()*9000 + 1000);
    }
    const debounce = (fn, t=250)=>{ let to; return (...a)=>{ clearTimeout(to); to=setTimeout(()=>fn(...a),t); } };

    /* ==== Auth ==== */
    let me=null;
    auth.onAuthStateChanged(async (u)=>{
      me = u;
      if(u){
        btnIn.style.display='none'; btnOut.style.display='inline-block'; btnMy.style.display='inline-block';
        btnMy.href = '#/u/'+u.uid; homeGoProfile.onclick = ()=>location.hash = '#/u/'+u.uid;
        await ensureUserDocs(u);
      }else{
        btnIn.style.display='inline-block'; btnOut.style.display='none'; btnMy.style.display='none';
        homeGoProfile.onclick = ()=>alert('√ñnce giri≈ü yap');
      }
      router();
    });
    btnIn.onclick = async ()=>{ try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(e){ alert(e.message); } };
    btnOut.onclick = ()=> auth.signOut();

    async function ensureUserDocs(u){
      const uRef = db.collection('users').doc(u.uid);
      const uSnap = await uRef.get();
      if(!uSnap.exists){
        await uRef.set({
          displayName: u.displayName || u.email || null,
          photoURL: u.photoURL || null,
          joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
          ratingCount: 0, ratingSumMicro: 0, avgMicroCache: 0
        }, { merge:true });
      }
      const pRef = db.collection('profiles').doc(u.uid);
      const pSnap = await pRef.get();
      if(!pSnap.exists){
        let base = slugHandle((u.displayName||'').split(' ')[0] || (u.email||'user').split('@')[0]);
        base = await ensureHandleUnique(base, u.uid);
        const dn = u.displayName || (u.email||'Kullanƒ±cƒ±');
        await pRef.set({
          displayName: dn,
          displayNameLower: dn.toLowerCase(),
          handle: base, handleLower: base.toLowerCase(),
          bio: '', location: '', website: '',
          photoURL: u.photoURL || '', coverURL: '',
          joinedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      } else {
        // Eski profillerde displayNameLower yoksa ekle
        const p = pSnap.data();
        if(!p.displayNameLower && p.displayName){
          await pRef.set({ displayNameLower: p.displayName.toLowerCase() }, { merge:true });
        }
      }
    }

    /* ==== Ana sayfa ==== */
    async function renderHome(){
      showPage('home');
      try{
        const s = await db.collection('users').get();
        elMemberCount.textContent = '√úye: ' + s.size;
      }catch{ elMemberCount.textContent = '√úye: ‚Äî'; }

      const topBox = $('#homeTop10');
      const qs = await db.collection('users').get();
      const arr = [];
      qs.forEach(d=>{
        const u = d.data(); const count=u.ratingCount||0; const sum=u.ratingSumMicro||0;
        const avg = count? (sum/count)/100000 : 0;
        arr.push({id:d.id, name:u.displayName||'(ƒ∞simsiz)', avg, count});
      });
      arr.sort((a,b)=> b.avg - a.avg || b.count - a.count);
      const top = arr.slice(0,10);
      if(top.length===0){ topBox.textContent='Hen√ºz veri yok.'; return; }
      let html = '<table><thead><tr><th>#</th><th>Ad</th><th>Ortalama</th><th>Oy</th></tr></thead><tbody>';
      top.forEach((u,i)=>{
        html += `<tr><td>${i+1}</td><td><a href="#/u/${u.id}">${u.name}</a></td><td>${toComma(u.avg)}</td><td>${u.count}</td></tr>`;
      });
      html += '</tbody></table>';
      topBox.innerHTML = html;
    }

    /* ==== Rank ==== */
    async function renderRank(){
      showPage('rank');
      const wrap = $('#rankTableWrap');
      wrap.textContent = 'Y√ºkleniyor‚Ä¶';
      const qs = await db.collection('users').get();
      $('#rankTotal').textContent = 'Toplam √ºye: ' + qs.size;
      const arr = [];
      qs.forEach(d=>{
        const u = d.data(); const count=u.ratingCount||0; const sum=u.ratingSumMicro||0;
        const avg = count? (sum/count)/100000 : 0;
        arr.push({id:d.id, name:u.displayName||'(ƒ∞simsiz)', avg, count});
      });
      arr.sort((a,b)=> b.avg - a.avg || b.count - a.count);
      let html = '<table><thead><tr><th>#</th><th>Ad</th><th>Ortalama</th><th>Oy</th><th>Profil</th></tr></thead><tbody>';
      arr.forEach((u,i)=>{
        html += `<tr><td>${i+1}</td><td>${u.name}</td><td>${toComma(u.avg)}</td><td>${u.count}</td><td><a href="#/u/${u.id}">G√∂r</a></td></tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    /* ==== Profile ==== */
    let currentProfileUid = null;

    function setTab(which){
      $('#tabOverview').classList.toggle('active', which==='ov');
      $('#tabReceived').classList.toggle('active', which==='rcv');
      $('#overviewPane').style.display = which==='ov' ? 'block':'none';
      $('#receivedPane').style.display = which==='rcv' ? 'block':'none';
      if(which==='rcv' && currentProfileUid){ loadReceived(currentProfileUid); }
    }

    $('#tabOverview').onclick = ()=> setTab('ov');
    $('#tabReceived').onclick = ()=> setTab('rcv');

    async function renderProfile(uid){
      showPage('profile');
      currentProfileUid = uid;
      setTab('ov');

      const uRef = db.collection('users').doc(uid);
      const uDoc = await uRef.get();
      if(!uDoc.exists){ $('#pageProfile').innerHTML = '<div class="bd">Bu kullanƒ±cƒ± listede deƒüil.</div>'; return; }
      const udat = uDoc.data();
      const count = udat.ratingCount||0, sum=udat.ratingSumMicro||0;
      const avg = count? (sum/count)/100000 : 0;
      $('#profAvg').textContent = 'Ortalama: ' + toComma(avg);
      $('#profCount').textContent = 'Oy: ' + count;

      try{
        const qs = await db.collection('users').get();
        const arr=[];
        qs.forEach(d=>{
          const x=d.data(); const c=x.ratingCount||0, s=x.ratingSumMicro||0;
          const a=c?(s/c)/100000:0;
          arr.push({id:d.id, avg:a, count:c});
        });
        arr.sort((a,b)=> b.avg - a.avg || b.count - a.count);
        const idx = arr.findIndex(x=>x.id===uid);
        $('#profRank').textContent = 'Sƒ±ra: ' + (idx>=0? idx+1 : '‚Äî') + ' / ' + arr.length;
      }catch{ $('#profRank').textContent = 'Sƒ±ra: ‚Äî'; }

      const pRef = db.collection('profiles').doc(uid);
      const pDoc = await pRef.get();
      const p = pDoc.exists ? pDoc.data() : {
        displayName: udat.displayName||'(Kullanƒ±cƒ±)', handle:'user', handleLower:'user',
        bio:'', website:'', location:'', photoURL: udat.photoURL||'', coverURL:'', joinedAt: null
      };
      $('#profName').textContent = p.displayName || '(Kullanƒ±cƒ±)';
      $('#profHandle').textContent = '@' + (p.handle||'user');
      $('#profBio').textContent = p.bio || '';
      $('#profAvatar').src = p.photoURL || '';
      $('#profCover').style.backgroundImage = p.coverURL ? `url(${p.coverURL})` : 'none';

      const meta = [];
      if(p.location) meta.push('üìç ' + p.location);
      if(p.website) meta.push('üîó ' + p.website);
      if(p.joinedAt && p.joinedAt.toDate){
        const d=p.joinedAt.toDate(); meta.push('üóìÔ∏è ' + d.toLocaleDateString());
      }
      $('#profMeta').textContent = meta.join('   ');

      const own = me && me.uid===uid;
      $('#btnEdit').style.display = own ? 'inline-block':'none';
      $('#btnRateOpen').style.display = own ? 'none':'inline-block';
      $('#rateBox').style.display = own ? 'none':'flex';

      $('#btnShare').onclick = ()=>{
        const link = location.origin + '/#/u/' + uid;
        navigator.clipboard.writeText(link).then(()=> alert('Baƒülantƒ± kopyalandƒ±: ' + link));
      };
      $('#btnRateOpen').onclick = ()=> $('#scoreInput').focus();

      $('#btnEdit').onclick = ()=> openEditModal(p);
    }

    async function loadReceived(uid){
      const box = $('#receivedList');
      box.textContent = 'Y√ºkleniyor‚Ä¶';
      try{
        const snap = await db.collection('users').doc(uid).collection('ratings').orderBy('updatedAt','desc').limit(20).get();
        if(snap.empty){ box.textContent = 'Hen√ºz oy yok.'; return; }
        let html = '<table><thead><tr><th>Veren</th><th>Puan</th><th>Tarih</th></tr></thead><tbody>';
        for(const d of snap.docs){
          const r=d.data(); const micro=r.micro||0;
          const score = (micro/100000).toFixed(5).replace('.', ',');
          let rater='(anon)';
          try{
            const pp = await db.collection('profiles').doc(d.id).get();
            rater = pp.exists ? (pp.data().displayName || '@'+(pp.data().handle||'user')) : d.id;
          }catch{}
          const t = r.updatedAt && r.updatedAt.toDate ? r.updatedAt.toDate().toLocaleString() : '-';
          html += `<tr><td>${rater}</td><td>${score}</td><td>${t}</td></tr>`;
        }
        html += '</tbody></table>';
        box.innerHTML = html;
      }catch(e){ box.textContent = 'Hata: ' + e.message; }
    }

    /* ==== Puanlama ==== */
    $('#btnRate')?.addEventListener('click', async ()=>{
      const uid = currentProfileUid;
      const msg=$('#rateMsg');
      if(!me){ msg.textContent='√ñnce giri≈ü yap.'; return; }
      if(me.uid===uid){ msg.textContent='Kendini puanlayamazsƒ±n.'; return; }
      const parsed = parseScore($('#scoreInput').value);
      if(!parsed){ msg.textContent='Ge√ßersiz deƒüer. 0<puan‚â§100 ve 5 ondalƒ±k olmalƒ±.'; return; }

      try{
        await db.runTransaction(async (tx)=>{
          const userRef = db.collection('users').doc(uid);
          const rateRef = userRef.collection('ratings').doc(me.uid);
          const uSnap = await tx.get(userRef);
          if(!uSnap.exists) throw new Error('Kullanƒ±cƒ± yok');

          const rSnap = await tx.get(rateRef);
          const old = rSnap.exists ? (rSnap.data().micro||0) : 0;
          const deltaSum = parsed.micro - old;
          const deltaCount = rSnap.exists ? 0 : 1;

          tx.set(rateRef, {
            micro: parsed.micro,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: rSnap.exists ? rSnap.data().createdAt : firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });

          const oldSum = uSnap.data().ratingSumMicro||0;
          const oldCnt = uSnap.data().ratingCount||0;
          const newSum = oldSum + deltaSum;
          const newCnt = oldCnt + deltaCount;
          const newAvgMicro = newCnt>0 ? Math.floor(newSum / newCnt) : 0;

          tx.set(userRef, {
            ratingSumMicro: newSum,
            ratingCount: newCnt,
            avgMicroCache: newAvgMicro
          }, { merge:true });
        });
        msg.textContent='Kaydedildi ‚úî';
        renderProfile(currentProfileUid);
      }catch(e){ msg.textContent='Hata: ' + e.message; }
    });

    /* ==== Edit modal ==== */
    function openEditModal(p){
      $('#edMsg').textContent='';
      $('#edName').value   = p.displayName || '';
      $('#edHandle').value = p.handle || '';
      $('#edBio').value    = p.bio || '';
      $('#edLoc').value    = p.location || '';
      $('#edWeb').value    = p.website || '';
      $('#edAvatar').value = p.photoURL || '';
      $('#edCover').value  = p.coverURL || '';
      $('#editBack').style.display='flex';
    }
    $('#editClose').onclick = ()=> $('#editBack').style.display='none';
    $('#edSave').onclick = async ()=>{
      if(!me){ $('#edMsg').textContent='Oturum yok.'; return; }
      const name = $('#edName').value.trim();
      let handle  = slugHandle($('#edHandle').value || '');
      const bio   = $('#edBio').value.trim().slice(0,160);
      const location = $('#edLoc').value.trim();
      const website  = normUrl($('#edWeb').value.trim());
      const photoURL = $('#edAvatar').value.trim();
      const coverURL = $('#edCover').value.trim();

      if(handle.length<3){ $('#edMsg').textContent='@kullanƒ±cƒ± adƒ± √ßok kƒ±sa.'; return; }

      $('#edSave').disabled = true; $('#edMsg').textContent='Kaydediliyor‚Ä¶';
      try{
        handle = await ensureHandleUnique(handle, me.uid);
        await db.collection('profiles').doc(me.uid).set({
          displayName: name||'(Kullanƒ±cƒ±)',
          displayNameLower: (name||'(Kullanƒ±cƒ±)').toLowerCase(),
          handle, handleLower: handle.toLowerCase(),
          bio, location, website, photoURL, coverURL
        }, { merge:true });
        $('#edMsg').textContent='Kaydedildi ‚úî';
        setTimeout(()=>{$('#editBack').style.display='none'; renderProfile(me.uid);}, 400);
      }catch(e){
        $('#edMsg').textContent='Hata: ' + e.message;
      }finally{
        $('#edSave').disabled = false;
      }
    };

    /* ==== Hƒ±zlƒ± Arama ==== */
    const qInput = $('#q'); const qDrop = $('#qDrop');
    function hideDrop(){ qDrop.classList.add('hidden'); qDrop.innerHTML=''; }
    function openDrop(){ qDrop.classList.remove('hidden'); }

    async function doSearch(){
      const raw = (qInput.value||'').trim();
      if(raw.length < 2){ hideDrop(); return; }
      const term = raw.toLowerCase().replace(/^@/,'');
      const results = new Map();

      // handleLower ile ba≈üa e≈üle≈üme
      const hSnap = await db.collection('profiles')
        .orderBy('handleLower').startAt(term).endAt(term+'\uf8ff').limit(6).get();
      hSnap.forEach(d=> results.set(d.id, d.data()));

      // displayNameLower ile ba≈üa e≈üle≈üme (ek olarak)
      const nSnap = await db.collection('profiles')
        .orderBy('displayNameLower').startAt(term).endAt(term+'\uf8ff').limit(6).get();
      nSnap.forEach(d=> results.set(d.id, d.data()));

      const arr = Array.from(results.entries()).slice(0,8);
      if(arr.length===0){ openDrop(); qDrop.innerHTML = '<div class="drop-empty">Sonu√ß yok</div>'; return; }

      let html = '';
      arr.forEach(([id,p])=>{
        const av = p.photoURL || '';
        html += `<div class="drop-item" data-id="${id}">
          <img src="${av}" alt="">
          <div><div class="h">${p.displayName||'(Kullanƒ±cƒ±)'}</div>
          <div class="muted">@${p.handle||'user'}</div></div>
        </div>`;
      });
      qDrop.innerHTML = html; openDrop();
      // tƒ±klama
      Array.from(qDrop.querySelectorAll('.drop-item')).forEach(el=>{
        el.onclick = ()=>{ location.hash = '#/u/' + el.dataset.id; hideDrop(); qInput.blur(); };
      });
    }
    qInput.addEventListener('input', debounce(doSearch, 300));
    qInput.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ hideDrop(); qInput.blur(); }
      if(e.key==='Enter'){
        const first = qDrop.querySelector('.drop-item');
        if(first){ location.hash = '#/u/' + first.dataset.id; hideDrop(); qInput.blur(); }
      }
    });
    document.addEventListener('click', (e)=>{
      if(!qDrop.contains(e.target) && e.target!==qInput){ hideDrop(); }
    });

    /* ==== Router ==== */
    function router(){
      const h = location.hash || '#/';
      if(h==='#/' || h==='#'){ renderHome(); return; }
      if(h.startsWith('#/rank')){ renderRank(); return; }
      if(h.startsWith('#/u/')){ renderProfile(h.split('/')[2]); return; }
      renderHome();
    }
    window.addEventListener('hashchange', router);
    router();
  </script>
</body>
</html>
