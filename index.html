<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>piann — Gerçek değerini keşfet; skorun senin imzan</title>
<meta name="description" content="Yorum yok, gürültü yok; sadece puan ve sıralama. Gerçek değerini keşfet; skorun senin imzan.">
<style>
  :root{
    --bg:#f7f8fb; --ink:#0f172a; --muted:#64748b;
    --card:#ffffff; --line:#e6e9ef;
    --accent:#0A66C2; --accent-600:#0857A6;
    --container:max(320px, min(1200px, 92vw));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  a{color:inherit;text-decoration:none}
  .btn{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent-600);border-color:var(--accent-600)}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--muted)}

  /* NAV */
  .nav{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
  .nav-inner{max-width:var(--container);margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:800;color:var(--accent)}
  .spacer{flex:1}
  .count{color:var(--muted);font-size:14px}

  /* RIBBON */
  .ribbon{background:#eef5ff;border-bottom:1px solid #d5e7ff}
  .ribbon .inner{max-width:var(--container);margin:0 auto;padding:8px 16px;color:#0a3e78;font-weight:600}

  /* WRAPS */
  .wrap{max-width:var(--container);margin:24px auto 64px;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 24px rgba(15,23,42,.04)}
  .hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
  .bd{padding:16px}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}

  /* DISCOVER CARD */
  .disc-row{display:grid;grid-template-columns:1fr 220px;gap:14px;align-items:center}
  .disc-left{display:flex;gap:14px}
  .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#f2f3f7;border:1px solid var(--line)}
  .name{font-weight:800}
  .handle{color:var(--muted);font-size:14px}
  .bio{color:#1f2937;margin:8px 0 10px;font-size:15px;line-height:1.4}
  input[type=text]{padding:10px 12px;border:1px solid var(--line);border-radius:10px}
  .rightbox{background:#eef5ff;border:1px solid #d5e7ff;border-radius:12px;padding:20px;text-align:center}
  .rightbox .score{font-weight:900;font-size:28px;color:#0a3e78}
  .rightbox .sub{color:var(--muted);font-size:12px}

  /* TABLE */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{color:#111827}

  footer{margin:32px 0;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-inner">
    <a href="#/" class="brand">piann</a>
    <a href="#/" class="btn">Keşfet</a>
    <a href="#/ranking" class="btn">Leaderboard</a>
    <div class="spacer"></div>
    <a href="#/profile/me" class="btn">Profil (Hakan)</a>
    <span id="memberCount" class="count">Üye: —</span>
  </div>
</nav>

<!-- SLOGAN RIBBON -->
<div class="ribbon">
  <div class="inner">Gerçek değerini keşfet; skorun senin imzan.</div>
</div>

<!-- HOME (DISCOVER + TOP50) -->
<main id="pageHome" class="wrap" style="display:none">
  <div class="grid">
    <section class="card">
      <div class="hd">Keşfet</div>
      <div class="bd" id="discoverBox">Yükleniyor…</div>
    </section>
    <aside class="card">
      <div class="hd">Top 50</div>
      <div class="bd" id="top50Wrap">Yükleniyor…</div>
    </aside>
  </div>
</main>

<!-- RANKING (TOP 500) -->
<section id="pageRanking" class="wrap" style="display:none">
  <div class="card">
    <div class="hd">Leaderboard – İlk 500</div>
    <div class="bd">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <label class="pill">Kategori:
          <select id="fltType">
            <option value="">Tümü</option>
            <option value="person">Kişiler</option>
            <option value="brand">Markalar</option>
          </select>
        </label>
        <label class="pill">Min. Oy:
          <select id="fltMin">
            <option value="1">1</option>
            <option value="10" selected>10</option>
            <option value="50">50</option>
          </select>
        </label>
      </div>
      <div id="rankWrap">Yükleniyor…</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="btnPrev">Önceki</button>
        <span class="muted" id="pageInfo">—</span>
        <button class="btn" id="btnNext">Sonraki</button>
      </div>
    </div>
  </div>
</section>

<!-- PROFILE -->
<section id="pageProfile" class="wrap" style="display:none">
  <div class="card">
    <div class="hd">Profil</div>
    <div class="bd" id="profWrap">—</div>
  </div>
</section>

<footer>© piann.com — demo prototip</footer>

<script>
/* ========= Utilities ========= */
const $=(s)=>document.querySelector(s);
const to5=(n)=>Number.isFinite(n)?n.toFixed(5).replace('.',','):'—';
const clip=(x)=>Math.max(0,Math.min(100,x));
function lcb(sumMicro,sumSqMicro,n){
  if(!n||n<=0) return 0;
  const mean=(sumMicro/n)/1e5;
  let sd=25;
  if(n>1){
    const ex2=(sumSqMicro/n)/1e10;
    const ex =(sumMicro/n)/1e5;
    const variance=Math.max(0,ex2-ex*ex);
    sd=Math.sqrt(variance);
  }
  return clip(mean - 1.96*(sd/Math.sqrt(n)));
}
const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick=(arr,n)=>{const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a.slice(0,n)}

/* ========= Fake Data (100 profile) ========= */
const seedPeople=[
  "Cristiano Ronaldo","Lionel Messi","Kylian Mbappé","Erling Haaland","Neymar Jr",
  "Elon Musk","Bill Gates","Mark Zuckerberg","Jeff Bezos","Tim Cook",
  "Taylor Swift","Ariana Grande","Beyoncé","Ed Sheeran","Rihanna",
  "Hakan Kocapüskül","Ada Yılmaz","Efe Demir","Zeynep Kaya","Mert Aydın",
  "Ayşe Çelik","Can Yıldız","Deniz Aksoy","Emre Koç","Selin Arslan",
  "Barış Yaman","Derya Kurt","Kerem Öz","Seda Şahin","Burak Tunç",
  "Melis Korkmaz","Oğuzhan Kara","Gizem Yalçın","Cem Uçar","İrem Taş",
  "Ahmet Kaya","Mehmet Can","Fatma Nur","Gamze Kır","Onur Ege"
];
const seedBrands=[
  "Coca-Cola","Pepsi","Nike","Adidas","Apple","Samsung","Microsoft","Google","Amazon","Tesla",
  "BMW","Mercedes-Benz","Audi","Ferrari","Puma",
  "Fenerbahçe","Galatasaray","Beşiktaş","Real Madrid","Barcelona"
];
const bios = [
  "Kısa ve net: skor konuşur.","Her gün biraz daha iyi.","Veri takıntılı, kahve bağımlısı.",
  "Sade, hızlı, net.","Yıldızları hedefle.","Takım oyuncusu.","Minimalist, sonuç odaklı.",
  "Bugün daha iyi.","Deney ve öğren.","Puanlarınla şekilleniyorum."
];
function makeId(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,16) || ('id'+Math.random().toString(36).slice(2,8)); }
function mkAgg(n, mean, sd){
  // E[X]=mean, Var=sd^2 -> E[X^2]=Var+mean^2
  const sumMicro = Math.round(n*mean*1e5);
  const ex2 = sd*sd + mean*mean;
  const sumSqMicro = Math.round(n*ex2*1e10);
  return {ratingCount:n, ratingSumMicro:sumMicro, ratingSumSqMicro:sumSqMicro, avgMicroCache: Math.floor(sumMicro/n)};
}
function avatarUrl(id){ return `https://i.pravatar.cc/100?u=${encodeURIComponent(id)}`; }
function brandImg(name){ return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0A66C2&color=fff&size=100&bold=true`; }

const profiles=[];
(function seed(){
  // People
  seedPeople.forEach((name,i)=>{
    const id = (name==="Hakan Kocapüskül")?"me":makeId(name)+(i%7);
    const n  = randInt(12,1200);
    const m  = randInt(50,95); // ortalama
    const sd = randInt(6,18);  // standart sapma
    const agg= mkAgg(n, m, sd);
    profiles.push({
      id, displayName:name, type:"person", tags:["general"],
      photoURL: avatarUrl(id),
      bio: bios[randInt(0,bios.length-1)],
      ...agg
    });
  });
  // Brands/Teams
  seedBrands.forEach((name,i)=>{
    const id = makeId(name)+ (i%5);
    const n  = randInt(20,2000);
    const m  = randInt(45,92);
    const sd = randInt(5,16);
    const agg= mkAgg(n, m, sd);
    profiles.push({
      id, displayName:name, type: (["Fenerbahçe","Galatasaray","Beşiktaş","Real Madrid","Barcelona"].includes(name)?"team":"brand"),
      tags: ["popular"],
      photoURL: brandImg(name),
      bio: `${name} için topluluk skoru.`,
      ...agg
    });
  });
  // Fill up to 100 with generic users
  const baseN = profiles.length;
  const need = 100 - baseN;
  for(let i=0;i<need;i++){
    const name = `Kullanıcı ${i+1}`;
    const id   = makeId(name)+i;
    const n    = randInt(5,800);
    const m    = randInt(40,90);
    const sd   = randInt(6,20);
    const agg  = mkAgg(n,m,sd);
    profiles.push({
      id, displayName:name, type:"person", tags:["demo"],
      photoURL: avatarUrl(id),
      bio: bios[randInt(0,bios.length-1)],
      ...agg
    });
  }
})();
const ME = profiles.find(p=>p.id==="me") || profiles[0];
$('#memberCount').textContent = 'Üye: ' + profiles.length;

/* ========= Router ========= */
const views = ['#pageHome','#pageRanking','#pageProfile'];
function showOnly(ids){ views.forEach(id=> $(id).style.display = ids.includes(id)?'block':'none'); }
function route(){
  const h=location.hash||'#/';
  if(h.startsWith('#/ranking')){ showOnly(['#pageRanking']); loadRanking(); return; }
  if(h.startsWith('#/profile/')){ const uid=h.split('/')[2]; showOnly(['#pageProfile']); renderProfile(uid); return; }
  showOnly(['#pageHome']); loadDiscover(); loadTop50();
}
window.addEventListener('hashchange', route);
route();

/* ========= In-memory rating (demo) ========= */
function rateInMemory(targetId, val){
  // self-rate engel
  if(targetId===ME.id){ alert('Kendini puanlayamazsın (demo).'); return; }
  const u=profiles.find(p=>p.id===targetId);
  if(!u) return;
  const micro = Math.round(val*1e5);
  // sanki ilk kez oy veriyormuşuz gibi güncelle (demo)
  const old = 0;
  const deltaSum = micro - old;
  const deltaCnt = 1; // yeni oy gibi
  u.ratingSumMicro += deltaSum;
  u.ratingSumSqMicro += (micro*micro - old*old);
  u.ratingCount += deltaCnt;
  u.avgMicroCache = Math.floor(u.ratingSumMicro/u.ratingCount);
}

/* ========= HOME: Discover (3) ========= */
function loadDiscover(){
  const box=$('#discoverBox'); box.textContent='Yükleniyor…';
  // 3 farklı kişi/marka, ME hariç
  const candidates = profiles.filter(p=>p.id!==ME.id);
  const pick3 = pick(candidates, 3);
  const html = pick3.map(u=>{
    const score=lcb(u.ratingSumMicro,u.ratingSumSqMicro,u.ratingCount);
    return `
    <div class="card" style="margin-bottom:12px">
      <div class="bd">
        <div class="disc-row">
          <div class="disc-left">
            <img class="avatar" src="${u.photoURL}">
            <div style="flex:1">
              <div class="name">${u.displayName}</div>
              <div class="handle">@${u.id.slice(0,8)} • <span class="muted">${u.type}</span></div>
              <div class="bio">${u.bio||''}</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <button class="btn q" data-id="${u.id}" data-v="70">70</button>
                <button class="btn q" data-id="${u.id}" data-v="80">80</button>
                <button class="btn q" data-id="${u.id}" data-v="90">90</button>
                <button class="btn q" data-id="${u.id}" data-v="95">95</button>
                <input class="score-input" data-id="${u.id}" type="text" placeholder="0–100 (örn: 88,75000)" style="max-width:200px">
                <button class="btn primary save" data-id="${u.id}">Puanla</button>
                <button class="btn skip">Atla</button>
                <a href="#/profile/${u.id}" class="btn">Profili gör</a>
              </div>
            </div>
          </div>
          <div class="rightbox">
            <div class="score">${to5(score)}</div>
            <div class="sub">Oy: ${u.ratingCount}</div>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
  box.innerHTML=html;

  // wiring
  box.querySelectorAll('.btn.q').forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.id, v=b.dataset.v;
      const inp=box.querySelector(`.score-input[data-id="${id}"]`);
      if(inp) inp.value=v.replace('.',',');
    };
  });
  box.querySelectorAll('.btn.save').forEach(b=>{
    b.onclick=()=>{
      const uid=b.dataset.id;
      const inp=box.querySelector(`.score-input[data-id="${uid}"]`);
      const v = Number((inp.value||'').trim().replace(',', '.'));
      if(!isFinite(v)||v<=0||v>100){ alert('0<puan≤100 olmalı.'); return; }
      rateInMemory(uid, v);
      loadDiscover(); loadTop50(); // anında güncelle
    };
  });
  box.querySelectorAll('.btn.skip').forEach(b=>{
    b.onclick=()=> loadDiscover();
  });
}

/* ========= HOME: Top 50 ========= */
function loadTop50(){
  const wrap=$('#top50Wrap'); wrap.textContent='Yükleniyor…';
  const arr = profiles
    .filter(p=>p.ratingCount>0)
    .map(p=>({id:p.id, name:p.displayName, count:p.ratingCount,
              score:lcb(p.ratingSumMicro,p.ratingSumSqMicro,p.ratingCount)}));
  arr.sort((a,b)=> b.score - a.score || b.count - a.count);
  const top=arr.slice(0,50);
  if(!top.length){ wrap.textContent='Henüz veri yok.'; return; }
  let html='<table><thead><tr><th>#</th><th>Ad</th><th>Puan</th><th>Oy</th></tr></thead><tbody>';
  top.forEach((u,i)=> html+=`<tr><td>${i+1}</td><td><a href="#/profile/${u.id}">${u.name}</a></td><td>${to5(u.score)}</td><td>${u.count}</td></tr>`);
  html+='</tbody></table>';
  wrap.innerHTML=html;
}

/* ========= RANKING (Top 500 demo) ========= */
const paging = { list:[], page:1, per:50 };
$('#btnPrev').onclick=()=>{ if(paging.page>1){ paging.page--; renderRankingPage(); } };
$('#btnNext').onclick=()=>{ const max=Math.ceil(paging.list.length/paging.per)||1; if(paging.page<max){ paging.page++; renderRankingPage(); } };
$('#fltType').onchange=()=> loadRanking();
$('#fltMin').onchange =()=> loadRanking();

function loadRanking(){
  const wrap=$('#rankWrap'); wrap.textContent='Yükleniyor…';
  const type=$('#fltType').value; const min=Number($('#fltMin').value||1);
  let arr = profiles.filter(p=>p.ratingCount>=min);
  if(type) arr = arr.filter(p=>p.type===type);
  const list = arr.map(p=>({
    id:p.id, name:p.displayName, count:p.ratingCount,
    score:lcb(p.ratingSumMicro,p.ratingSumSqMicro,p.ratingCount)
  }));
  list.sort((a,b)=> b.score - a.score || b.count - a.count);
  paging.list = list.slice(0,500);
  paging.page = 1;
  renderRankingPage();
}
function renderRankingPage(){
  const wrap=$('#rankWrap');
  const start=(paging.page-1)*paging.per, end=start+paging.per;
  const pageItems=paging.list.slice(start,end);
  if(!pageItems.length){ wrap.textContent='Kayıt yok.'; $('#pageInfo').textContent='—'; return; }
  let html='<table><thead><tr><th>#</th><th>Ad</th><th>Puan</th><th>Oy</th><th>Profil</th></tr></thead><tbody>';
  pageItems.forEach((u,i)=> html+=`<tr><td>${start+i+1}</td><td>${u.name}</td><td>${to5(u.score)}</td><td>${u.count}</td><td><a href="#/profile/${u.id}">Gör</a></td></tr>`);
  html+='</tbody></table>';
  wrap.innerHTML=html;
  const max=Math.ceil(paging.list.length/paging.per)||1;
  $('#pageInfo').textContent=`Sayfa ${paging.page}/${max}`;
}

/* ========= PROFILE ========= */
function renderProfile(uid){
  const box=$('#profWrap'); box.textContent='Yükleniyor…';
  const p = profiles.find(x=>x.id===uid) || profiles[0];
  const cnt=p.ratingCount||0;
  const s  =lcb(p.ratingSumMicro,p.ratingSumSqMicro,cnt);

  // Rank hesapla
  const arr = profiles
    .filter(x=>x.ratingCount>0)
    .map(x=>({id:x.id,score:lcb(x.ratingSumMicro,x.ratingSumSqMicro,x.ratingCount),count:x.ratingCount}));
  arr.sort((a,b)=> b.score - a.score || b.count - a.count);
  const rank = arr.findIndex(x=>x.id===p.id);
  const total=arr.length;

  box.innerHTML=`
    <div style="display:flex;gap:14px;align-items:center;margin-bottom:12px">
      <img class="avatar" src="${p.photoURL}">
      <div>
        <div class="name">${p.displayName}</div>
        <div class="muted">@${p.id.slice(0,8)} • ${p.type}</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <span class="pill">Puan: ${to5(s)}</span>
          <span class="pill">Oy: ${cnt}</span>
          <span class="pill">Sıra: ${rank>=0?(rank+1):'—'} / ${total}</span>
        </div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        ${ uid===ME.id ? '' : '<button class="btn primary" id="btnRateOpen">Puan ver</button>'}
        <button class="btn" id="btnShare">Paylaş</button>
      </div>
    </div>
    <div class="muted" style="margin:6px 0">${p.bio||''}</div>

    ${ uid===ME.id ? `
      <div class="muted" style="margin-top:8px">Bu demo sürümünde profil düzenleme kapalıdır.</div>
    `:`
      <div id="rateBox" style="margin-top:12px">
        <input id="rateInput" type="text" placeholder="0–100, 5 ondalık (örn: 89,12345)" style="max-width:220px">
        <button class="btn primary" id="btnRate">Puanla / Güncelle</button>
      </div>
    `}
  `;

  $('#btnShare').onclick=()=>{
    const link = location.origin + location.pathname + '#/profile/' + p.id;
    navigator.clipboard.writeText(link).then(()=> alert('Bağlantı kopyalandı: '+link));
  };
  if(uid!==ME.id){
    $('#btnRateOpen') && ($('#btnRateOpen').onclick=()=> $('#rateInput').focus());
    $('#btnRate').onclick=()=>{
      const s = ($('#rateInput').value||'').trim().replace(',', '.');
      const v = Number(s);
      if(!isFinite(v)||v<=0||v>100){ alert('0<puan≤100 olmalı.'); return; }
      rateInMemory(uid, v);
      renderProfile(uid); loadTop50();
    };
  }
}
</script>
</body>
</html>
