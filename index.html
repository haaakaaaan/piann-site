<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>piann â€” puan & sÄ±ralama</title>
<meta name="color-scheme" content="light" />
<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --line:#e6e9ef;
    --bg:#f7f8fb; --card:#ffffff;
    --accent:#0A66C2; --accent-600:#0857A6;
    --ok:#10b981; --err:#ef4444;
    --container:min(1080px, 96vw);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:var(--bg)}

  /* NAV (giriÅŸten sonra) */
  .nav{display:none; position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid var(--line)}
  .nav .in{max-width:var(--container); margin:0 auto; padding:10px 12px; display:flex; gap:10px; align-items:center}
  .brand{font-weight:800; letter-spacing:.2px}
  .nav a, .nav button{appearance:none; border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; color:var(--ink); text-decoration:none; cursor:pointer; font-weight:600}
  .nav .sp{flex:1}
  .nav .pill{border-radius:999px; background:#eef2ff; border-color:#e6e9ef; color:#3730a3; font-size:12px}

  /* WRAP + COMMON */
  main{max-width:var(--container); margin:24px auto 72px; padding:0 12px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 24px rgba(15,23,42,.04)}
  .hd{padding:14px 16px; border-bottom:1px solid var(--line); font-weight:800}
  .bd{padding:16px}
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .btn{appearance:none; border:1px solid var(--line); background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700}
  .btn.primary{background:var(--accent); border-color:var(--accent); color:#fff}
  .btn.primary:hover{background:var(--accent-600); border-color:var(--accent-600)}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  input,textarea{width:100%; background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px 12px; color:var(--ink)}
  textarea{min-height:80px; resize:vertical}

  /* LOGIN VIEW */
  #login{display:flex; align-items:flex-start; gap:28px; margin-top:28px}
  #login .left{flex:1 1 60%}
  #login .left h1{font-size:42px; line-height:1.2; margin:0 0 12px; color:#0b4f8f}
  #login .right{flex:1 1 40%}
  #login .panel{max-width:420px; margin-left:auto}
  #login .status{font-size:13px; color:var(--muted); margin-top:6px}

  /* DISCOVER */
  .discover-col{display:flex; flex-direction:column; gap:14px}
  .dcard{display:flex; gap:14px; padding:14px}
  .d-left{flex:1 1 auto; min-width:0}
  .avatar{width:56px; height:56px; border-radius:50%; object-fit:cover; border:1px solid var(--line); background:#f1f5f9}
  .bio{font-size:15px; color:#111827; line-height:1.45}
  .chip{font-size:13px; padding:6px 8px; border-radius:8px; border:1px solid var(--line); background:#fff; cursor:pointer}
  .d-right{flex:0 0 190px; display:flex; align-items:center; justify-content:center}
  .scorebox{width:100%; text-align:center; background:#eef4ff; border:1px solid #dce6ff; border-radius:12px; padding:18px}
  .scorebox .big{font-size:26px; font-weight:800; color:#0b4f8f}
  .scorebox small{display:block; color:#445}
  .rank{font-size:12px; color:#0b4f8f; font-weight:700; margin-top:6px}

  /* TABLE */
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; font-size:14px}
  th{color:#111827; font-weight:800}

  /* PROFILE */
  .kp{display:flex; gap:12px; align-items:center}
  .pill{padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; font-size:12px; color:var(--muted)}

  footer{margin:32px 0; text-align:center; color:var(--muted); font-size:12px}
</style>
</head>
<body>

<!-- NAV (yalnÄ±zca giriÅŸten sonra gÃ¶rÃ¼nÃ¼r) -->
<nav class="nav" id="nav">
  <div class="in">
    <div class="brand">piann</div>
    <a id="navDiscover" href="#/discover">KeÅŸfet</a>
    <a id="navBoard" href="#/board">Leaderboard</a>
    <div class="sp"></div>
    <span id="countUsers" class="pill">Ãœye: â€”</span>
    <a id="navMe" href="#/me" style="display:none">Profilim</a>
    <button id="btnOut" class="btn">Ã‡Ä±kÄ±ÅŸ</button>
  </div>
</nav>

<main>

  <!-- LOGIN -->
  <section id="login">
    <div class="left">
      <h1>GerÃ§ek deÄŸerini keÅŸfet; skorun senin imzan</h1>
      <p class="muted">
        piann, insanlarÄ±n birbirini puanladÄ±ÄŸÄ± ve gerÃ§ek deÄŸerini gÃ¶rdÃ¼ÄŸÃ¼ topluluk.
      </p>
    </div>
    <div class="right">
      <div class="card panel">
        <div class="hd">GiriÅŸ yap</div>
        <div class="bd">
          <button id="btnGoogle" class="btn primary" style="width:100%">
            <span style="display:inline-flex; gap:8px; align-items:center">
              <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12 s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C33.041,6.053,28.741,4,24,4C12.955,4,4,12.955,4,24 s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.349,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.814C14.406,16.108,18.878,12,24,12c3.059,0,5.842,1.154,7.961,3.039 l5.657-5.657C33.041,6.053,28.741,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.176,0,9.86-1.977,13.409-5.197l-6.19-5.238C29.127,35.399,26.715,36,24,36 c-5.202,0-9.62-3.317-11.283-7.946l-6.521,5.025C9.5,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.097,5.571 c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.773,44,34,44,24C44,22.659,43.862,21.349,43.611,20.083z"></path></svg>
              Google ile giriÅŸ yap
            </span>
          </button>
          <div id="loginStatus" class="status"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- DISCOVER -->
  <section id="pageDiscover" style="display:none">
    <div class="card">
      <div class="hd">KeÅŸfet</div>
      <div class="bd discover-col" id="discoverList">YÃ¼kleniyorâ€¦</div>
    </div>
  </section>

  <!-- LEADERBOARD -->
  <section id="pageBoard" style="display:none">
    <div class="card">
      <div class="hd row" style="justify-content:space-between">
        <span>Liderboard</span>
        <span id="rankMeta" class="pill">Puanlanan Ã¼ye: â€”</span>
      </div>
      <div class="bd" id="boardWrap">YÃ¼kleniyorâ€¦</div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="pageProfile" style="display:none">
    <div class="card">
      <div class="hd">Profil</div>
      <div class="bd">
        <div class="kp">
          <img id="pAvatar" class="avatar" alt="">
          <div style="flex:1">
            <div id="pName" style="font-weight:800; font-size:20px">â€”</div>
            <div id="pHandle" class="muted">@â€”</div>
          </div>
          <button id="btnEdit" class="btn" style="display:none">Profili dÃ¼zenle</button>
          <button id="btnShare" class="btn">PaylaÅŸ</button>
        </div>
        <p id="pBio" class="muted" style="margin:10px 0 6px"></p>
        <div id="pMeta" class="muted" style="font-size:14px"></div>

        <div class="row" style="margin:12px 0">
          <span id="pillScore" class="pill">Puan: â€”</span>
          <span id="pillCount" class="pill">Oy: â€”</span>
          <span id="pillRank" class="pill">SÄ±ra: â€”</span>
        </div>

        <div id="rateBox" class="row" style="display:none">
          <input id="rateInput" placeholder="0â€“100 (Ã¶rn: 89.12345)" style="max-width:220px" />
          <button id="btnRate" class="btn primary">Puanla / GÃ¼ncelle</button>
          <span id="rateMsg" class="muted"></span>
        </div>

        <h3 style="margin:18px 0 8px">AlÄ±nan Puanlar</h3>
        <div id="receivedList" class="muted">YÃ¼kleniyorâ€¦</div>
      </div>
    </div>
  </section>

</main>

<footer>Â© piann.com</footer>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  /* ===== Firebase config (piann-c58b8) ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyCB71Ffsvv3y5QArsgauAC91lhjFiE5K8Q",
    authDomain: "piann-c58b8.firebaseapp.com",
    projectId: "piann-c58b8",
    storageBucket: "piann-c58b8.appspot.com",
    messagingSenderId: "1086334896697",
    appId: "1:1086334896697:web:7770adc7f9438be4a49be8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const nav = $('#nav');
  const loginView = $('#login');
  const pageDiscover = $('#pageDiscover');
  const pageBoard    = $('#pageBoard');
  const pageProfile  = $('#pageProfile');

  function show(...ids){
    // giriÅŸ sonrasÄ± gÃ¶rÃ¼nÃ¼r nav
    nav.style.display = auth.currentUser ? 'block':'none';
    const map = {discover:pageDiscover, board:pageBoard, profile:pageProfile, login:loginView};
    for(const k of Object.keys(map)) map[k].style.display = 'none';
    ids.forEach(id=> map[id].style.display = 'block');
  }

  function to5(x){ return (Math.round(x*100000)/100000).toFixed(5).replace('.', ','); }
  function clamp100(x){ return Math.max(0, Math.min(100, x)); }
  const pick = (arr,n)=> arr.sort(()=>Math.random()-0.5).slice(0,n);

  // LCB: mean âˆ’ 1.96 * (sd / sqrt(n))
  function lcbFrom(sumMicro, sumSqMicro, n){
    if(!n || n<=0) return 0;
    const mean = (sumMicro/n)/100000;
    let sd = 25; // sumSq yoksa korumacÄ± varsayÄ±m
    if (typeof sumSqMicro === 'number' && n>1){
      const ex2 = (sumSqMicro/n)/1e10;
      const ex  = (sumMicro/n)/1e5;
      const variance = Math.max(0, ex2 - ex*ex);
      sd = Math.sqrt(variance) || 25;
    } else if(n===1){ sd = 25; }
    const lcb = mean - 1.96 * (sd / Math.sqrt(n));
    return clamp100(lcb);
  }

  function normUrl(u){ if(!u) return ''; return /^https?:\/\//i.test(u) ? u : 'https://' + u; }

  async function ensureUserDocs(u){
    if(!u) return;
    const uRef = db.collection('users').doc(u.uid);
    const pRef = db.collection('profiles').doc(u.uid);

    const uSnap = await uRef.get();
    if(!uSnap.exists){
      await uRef.set({
        displayName: u.displayName || u.email || null,
        photoURL: u.photoURL || null,
        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
        ratingCount:0,
        ratingSumMicro:0,
        avgMicroCache:0
      }, {merge:true});
    }else{
      await uRef.set({
        displayName: u.displayName || uSnap.data().displayName || null,
        photoURL: u.photoURL || uSnap.data().photoURL || null
      }, {merge:true});
    }

    const pSnap = await pRef.get();
    if(!pSnap.exists){
      const base = ((u.displayName||u.email||'user').split(/[ @]/)[0] || 'user').toLowerCase().replace(/[^a-z0-9_]+/g,'_').slice(0,15);
      await pRef.set({
        displayName: u.displayName || (u.email||'KullanÄ±cÄ±'),
        displayNameLower: (u.displayName || (u.email||'KullanÄ±cÄ±')).toLowerCase(),
        handle: base, handleLower: base,
        bio:'', website:'', location:'', photoURL: u.photoURL || '', coverURL:'',
        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }
  }

  /* ====== AUTH: mobilde redirect, desktop popup (fallback) ====== */
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                    || window.navigator.standalone === true;
  const isMobileUA = /android|iphone|ipad|ipod/i.test(navigator.userAgent);
  const preferRedirect =
      isStandalone || isMobileUA ||
      new URLSearchParams(location.search).get('method') === 'redirect' ||
      location.hash.includes('forceRedirect');
  const REDIRECT_FLAG = 'piann_auth_redirect';

  async function ensurePersistence(){
    try{
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    }catch{ await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION); }
  }

  async function handleRedirectResult(){
    try{
      const res = await auth.getRedirectResult();
      if(res && res.user){ localStorage.removeItem(REDIRECT_FLAG); }
      else if(localStorage.getItem(REDIRECT_FLAG)){
        $('#loginStatus').textContent = 'TarayÄ±cÄ± yÃ¶nlendirmeyi engellemiÅŸ olabilir. LÃ¼tfen reklam engelleyiciyi kapatÄ±p tekrar deneyin.';
        localStorage.removeItem(REDIRECT_FLAG);
      }
    }catch(err){
      console.error('getRedirectResult',err);
      localStorage.removeItem(REDIRECT_FLAG);
      $('#loginStatus').textContent = 'GiriÅŸ hata (redirect sonucu): ' + (err.message||err.code);
    }
  }

  async function signInWithGoogle(){
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    await ensurePersistence();

    if(preferRedirect){
      try{
        $('#loginStatus').textContent = 'Googleâ€™a yÃ¶nlendiriliyorâ€¦';
        localStorage.setItem(REDIRECT_FLAG,'1');
        await auth.signInWithRedirect(provider);
      }catch(err){
        localStorage.removeItem(REDIRECT_FLAG);
        $('#loginStatus').textContent = 'GiriÅŸ baÅŸlatÄ±lamadÄ± (redirect): ' + (err.message||err.code);
      }
    }else{
      try{
        $('#loginStatus').textContent = 'Google aÃ§Ä±lÄ±yorâ€¦';
        await auth.signInWithPopup(provider);
      }catch(err){
        console.error('popup err',err);
        if(err && err.code==='auth/popup-blocked'){
          try{
            $('#loginStatus').textContent = 'AÃ§Ä±lÄ±r pencere engellendi, yÃ¶nlendiriliyorâ€¦';
            localStorage.setItem(REDIRECT_FLAG,'1');
            await auth.signInWithRedirect(provider);
          }catch(e2){
            localStorage.removeItem(REDIRECT_FLAG);
            $('#loginStatus').textContent = 'GiriÅŸ hatasÄ±: '+(e2.message||e2.code);
          }
          return;
        }
        $('#loginStatus').textContent = 'GiriÅŸ hatasÄ±: '+(err.message||err.code);
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    handleRedirectResult();
    $('#btnGoogle').addEventListener('click', signInWithGoogle);
    $('#btnOut').addEventListener('click', ()=> auth.signOut());
    $('#navDiscover').onclick = ()=>{ location.hash='#/discover'; };
    $('#navBoard').onclick    = ()=>{ location.hash='#/board'; };
    $('#navMe').onclick       = ()=>{ location.hash='#/me'; };
  });

  /* ====== onAuthStateChanged ====== */
  auth.onAuthStateChanged(async (u)=>{
    if(u){
      await ensureUserDocs(u);
      // nav sayacÄ±
      refreshCounts();
      $('#navMe').style.display = 'inline-block';
      show('discover');
      renderDiscover();
    }else{
      $('#navMe').style.display = 'none';
      show('login');
    }
  });

  /* ====== Counts ====== */
  async function refreshCounts(){
    try{
      const snap = await db.collection('users').get();
      $('#countUsers').textContent = 'Ãœye: ' + snap.size;
    }catch{ $('#countUsers').textContent = 'Ãœye: â€”'; }
  }

  /* ====== DISCOVER (3 profil, dikey) ====== */
  async function renderDiscover(){
    const list = $('#discoverList');
    list.textContent = 'YÃ¼kleniyorâ€¦';
    try{
      const us = await db.collection('users').get();
      const arr = [];
      us.forEach(d=>{
        const u = d.data();
        if(auth.currentUser && d.id === auth.currentUser.uid) return;
        const c  = u.ratingCount||0;
        const s  = u.ratingSumMicro||0;
        const ss = u.ratingSumSqMicro; // olabilir/yok olabilir
        const lcb = lcbFrom(s, ss, c);
        arr.push({uid:d.id, name:u.displayName||'(KullanÄ±cÄ±)', photo:u.photoURL||'', c, s, ss, lcb});
      });
      // Rank iÃ§in tÃ¼m puanlananlar arasÄ±nda sÄ±rala
      const ranked = arr.filter(x=>x.c>0).sort((a,b)=> b.lcb - a.lcb || b.c - a.c);
      ranked.forEach((x,i)=> x.rank = i+1);
      // c==0 olanlara rank yok
      const pick3 = pick(arr, 3);

      // profilleri Ã§ek
      const profs = {};
      await Promise.all(pick3.map(async x=>{
        const p = await db.collection('profiles').doc(x.uid).get();
        profs[x.uid] = p.exists? p.data() : {};
      }));

      list.innerHTML = '';
      if(pick3.length===0){ list.textContent='GÃ¶sterilecek profil bulunamadÄ±.'; return; }

      for(const x of pick3){
        const p = profs[x.uid] || {};
        const img = p.photoURL || x.photo || 'https://i.pravatar.cc/100?u='+x.uid;
        const bio = (p.bio||'').trim() || 'â€”';
        const name = p.displayName || x.name || '(KullanÄ±cÄ±)';
        const handle = p.handle ? '@'+p.handle : '';

        const rankText = x.c>0 && x.rank ? `<div class="rank">SÄ±ra: ${x.rank}</div>` : `<div class="rank">SÄ±ra: â€”</div>`;
        const html = `
          <div class="dcard card">
            <div class="d-left">
              <div class="row" style="align-items:center">
                <img src="${img}" class="avatar" alt="">
                <div>
                  <div style="font-weight:800">${name}</div>
                  <div class="muted">${handle} Â· <span class="pill">Oy: ${x.c}</span></div>
                </div>
              </div>
              <div class="bio" style="margin:10px 0">${bio}</div>
              <div class="row">
                <span class="chip" data-q="70">70</span>
                <span class="chip" data-q="80">80</span>
                <span class="chip" data-q="90">90</span>
                <span class="chip" data-q="95">95</span>
              </div>
              <div class="row" style="margin-top:8px">
                <input class="in-rate" placeholder="0â€“100 (Ã¶rn: 88.5)" style="max-width:220px" />
                <button class="btn primary act-save">Puanla</button>
                <button class="btn act-skip">Atla</button>
                <a class="btn" href="#/u/${x.uid}">Profili gÃ¶r</a>
                <span class="muted act-msg"></span>
              </div>
            </div>
            <div class="d-right">
              <div class="scorebox">
                <div class="big">${to5(x.lcb).replace(',','.')}</div>
                <small>LCB</small>
                ${rankText}
              </div>
            </div>
          </div>
        `;
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        const node = wrap.firstElementChild;

        // quick chips
        node.querySelectorAll('[data-q]').forEach(el=>{
          el.onclick = ()=> node.querySelector('.in-rate').value = el.dataset.q;
        });
        // save
        node.querySelector('.act-save').onclick = ()=> saveRatingUI(x.uid, node);
        // skip
        node.querySelector('.act-skip').onclick = ()=> renderDiscover();

        list.appendChild(node);
      }

    }catch(err){
      console.error(err);
      list.textContent = 'Hata: '+(err.message||err.code);
    }
  }

  function parseRate(s){
    if(!s) return null; s=String(s).trim().replace(',', '.');
    const v=Number(s); if(!isFinite(v)) return null;
    const r=Math.round(v*100000)/100000;
    if(!(r>0 && r<=100)) return null;
    return {val:r, micro:Math.round(r*100000)};
  }

  async function saveRatingUI(targetUid, cardEl){
    const input = cardEl.querySelector('.in-rate');
    const msg   = cardEl.querySelector('.act-msg');
    const parsed = parseRate(input.value);
    if(!auth.currentUser){ msg.textContent='Ã–nce giriÅŸ yap.'; return; }
    if(auth.currentUser.uid===targetUid){ msg.textContent='Kendini puanlayamazsÄ±n.'; return; }
    if(!parsed){ msg.textContent='GeÃ§ersiz deÄŸer.'; return; }
    msg.textContent='Kaydediliyorâ€¦';

    try{
      await db.runTransaction(async (tx)=>{
        const uDoc = db.collection('users').doc(targetUid);
        const rDoc = uDoc.collection('ratings').doc(auth.currentUser.uid);

        const uSnap = await tx.get(uDoc);
        if(!uSnap.exists) throw new Error('KullanÄ±cÄ± yok');

        const rSnap = await tx.get(rDoc);
        const old = rSnap.exists ? (rSnap.data().micro||0) : 0;
        const deltaSum   = parsed.micro - old;
        const deltaCount = rSnap.exists ? 0 : 1;

        tx.set(rDoc, {
          micro: parsed.micro,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: rSnap.exists ? rSnap.data().createdAt : firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});

        const d=uSnap.data();
        const nSum=(d.ratingSumMicro||0)+deltaSum;
        const nCnt=(d.ratingCount||0)+deltaCount;
        const newAvg = nCnt>0 ? Math.floor(nSum/nCnt) : 0;

        tx.set(uDoc, {ratingSumMicro:nSum, ratingCount:nCnt, avgMicroCache:newAvg}, {merge:true});
      });
      msg.textContent='Kaydedildi âœ”';
      renderDiscover();
    }catch(err){
      console.error(err);
      msg.textContent='Hata: '+(err.message||err.code);
    }
  }

  /* ====== BOARD (Top 25, 5 ondalÄ±k) ====== */
  async function renderBoard(){
    const wrap = $('#boardWrap'); wrap.textContent='YÃ¼kleniyorâ€¦';
    try{
      const snap = await db.collection('users').get();
      const arr=[];
      snap.forEach(d=>{
        const u=d.data();
        const c=u.ratingCount||0;
        if(c<=0) return; // en az 1 oy ÅŸartÄ±
        const s=u.ratingSumMicro||0;
        const ss=u.ratingSumSqMicro;
        arr.push({uid:d.id, name:u.displayName||'(KullanÄ±cÄ±)', c, lcb:lcbFrom(s,ss,c)});
      });
      $('#rankMeta').textContent='Puanlanan Ã¼ye: '+arr.length;
      arr.sort((a,b)=> b.lcb - a.lcb || b.c - a.c);
      const top = arr.slice(0,25);
      if(!top.length){ wrap.textContent='Puanlanan Ã¼ye yok.'; return; }

      let html = '<table><thead><tr><th>#</th><th>Ad</th><th>Puan</th><th>Oy</th><th>Profil</th></tr></thead><tbody>';
      top.forEach((u,i)=>{
        html += `<tr>
          <td>${i+1}</td>
          <td>${u.name}</td>
          <td>${to5(u.lcb)}</td>
          <td>${u.c}</td>
          <td><a class="btn" href="#/u/${u.uid}">GÃ¶r</a></td>
        </tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }catch(err){
      wrap.textContent='Hata: '+(err.message||err.code);
    }
  }

  /* ====== PROFILE ====== */
  let currentProfileUid=null;

  async function renderProfile(uid){
    currentProfileUid = uid || (auth.currentUser && auth.currentUser.uid);
    if(!currentProfileUid){ show('discover'); return; }

    show('profile');

    const uRef = db.collection('users').doc(currentProfileUid);
    const uDoc = await uRef.get();
    if(!uDoc.exists){ $('#pageProfile .bd').innerHTML='<p class="muted">KullanÄ±cÄ± bulunamadÄ±.</p>'; return; }
    const u = uDoc.data();
    const cnt=u.ratingCount||0, sum=u.ratingSumMicro||0, sumsq=u.ratingSumSqMicro;
    const myLCB = lcbFrom(sum, sumsq, cnt);

    $('#pillScore').textContent = 'Puan: '+to5(myLCB);
    $('#pillCount').textContent = 'Oy: '+cnt;

    // rank
    const all = await db.collection('users').get();
    const arr=[]; all.forEach(d=>{
      const x=d.data(); const c=x.ratingCount||0; if(c<=0) return;
      arr.push({uid:d.id, lcb:lcbFrom(x.ratingSumMicro||0, x.ratingSumSqMicro, c), c});
    });
    arr.sort((a,b)=> b.lcb - a.lcb || b.c - a.c);
    const pos = arr.findIndex(x=>x.uid===currentProfileUid);
    $('#pillRank').textContent = 'SÄ±ra: ' + (pos>=0? (pos+1) : 'â€”');

    // profile doc
    const pSnap = await db.collection('profiles').doc(currentProfileUid).get();
    const p = pSnap.exists? pSnap.data() : {};
    $('#pName').textContent   = p.displayName || u.displayName || '(KullanÄ±cÄ±)';
    $('#pHandle').textContent = p.handle ? '@'+p.handle : '';
    $('#pBio').textContent    = p.bio || '';
    $('#pAvatar').src         = p.photoURL || u.photoURL || 'https://i.pravatar.cc/100?u='+currentProfileUid;
    const meta = [];
    if(p.location) meta.push('ðŸ“ '+p.location);
    if(p.website)  meta.push('ðŸ”— '+normUrl(p.website));
    $('#pMeta').textContent = meta.join('   ');

    const own = auth.currentUser && auth.currentUser.uid===currentProfileUid;
    $('#btnEdit').style.display = own ? 'inline-block' : 'none';
    $('#rateBox').style.display = own ? 'none' : 'flex';

    $('#btnShare').onclick = ()=>{
      const link = location.origin + '/#/u/' + currentProfileUid;
      navigator.clipboard.writeText(link).then(()=> alert('BaÄŸlantÄ± kopyalandÄ±: ' + link));
    };
    $('#btnRate').onclick = async ()=>{
      const parsed = parseRate($('#rateInput').value);
      const msg = $('#rateMsg');
      if(!parsed){ msg.textContent='GeÃ§ersiz deÄŸer.'; return; }
      try{
        await db.runTransaction(async (tx)=>{
          const rDoc = uRef.collection('ratings').doc(auth.currentUser.uid);
          const rSnap = await tx.get(rDoc);
          const old = rSnap.exists ? (rSnap.data().micro||0) : 0;
          const deltaSum   = parsed.micro - old;
          const deltaCount = rSnap.exists ? 0 : 1;

          tx.set(rDoc, {
            micro: parsed.micro,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: rSnap.exists ? rSnap.data().createdAt : firebase.firestore.FieldValue.serverTimestamp()
          }, {merge:true});

          const d=uDoc.data();
          const nSum=(d.ratingSumMicro||0)+deltaSum;
          const nCnt=(d.ratingCount||0)+deltaCount;
          const newAvg = nCnt>0 ? Math.floor(nSum/nCnt) : 0;

          tx.set(uRef, {ratingSumMicro:nSum, ratingCount:nCnt, avgMicroCache:newAvg}, {merge:true});
        });
        msg.textContent='Kaydedildi âœ”';
        renderProfile(currentProfileUid);
      }catch(err){
        msg.textContent='Hata: '+(err.message||err.code);
      }
    };

    // received ratings
    const box = $('#receivedList'); box.textContent='YÃ¼kleniyorâ€¦';
    const rs = await uRef.collection('ratings').orderBy('updatedAt','desc').limit(20).get();
    if(rs.empty){ box.textContent='HenÃ¼z oy yok.'; return; }
    let html='<table><thead><tr><th>Veren</th><th>Puan</th><th>Tarih</th></tr></thead><tbody>';
    for(const d of rs.docs){
      const r=d.data();
      let who = d.id;
      try{
        const pp = await db.collection('profiles').doc(d.id).get();
        if(pp.exists){ const pd=pp.data(); who=pd.displayName || '@'+(pd.handle||'user'); }
      }catch{}
      const t = r.updatedAt && r.updatedAt.toDate ? r.updatedAt.toDate().toLocaleString() : '-';
      html+=`<tr><td>${who}</td><td>${to5((r.micro||0)/100000)}</td><td>${t}</td></tr>`;
    }
    html+='</tbody></table>'; box.innerHTML=html;
  }

  /* ===== Router (giriÅŸten sonra) ===== */
  window.addEventListener('hashchange', router);
  function router(){
    const h = location.hash||'#/';
    if(!auth.currentUser){ show('login'); return; }
    if(h.startsWith('#/board')){ show('board'); renderBoard(); return; }
    if(h.startsWith('#/u/')){ const uid=h.split('/')[2]; renderProfile(uid); return; }
    if(h.startsWith('#/me')){ renderProfile(auth.currentUser.uid); return; }
    show('discover'); renderDiscover();
  }
</script>
</body>
</html>
