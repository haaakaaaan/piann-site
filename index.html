<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>piann — oylama</title>

  <!-- Yazı tipi (opsiyonel ama şık) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: linear-gradient(180deg,#f7f9fc 0%, #eef2f7 100%);
      --card:#fff; --line:#e8ecf2; --muted:#6b7280; --text:#0f172a;
      --brand:#111827; --accent:#3b82f6; --accent-2:#9ec5fe;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Arial, sans-serif;
      color:var(--text); background:var(--bg);
    }

    /* Üst bar (çok sade) */
    .nav{
      position:sticky; top:0; z-index:10;
      background:rgba(255,255,255,.85); backdrop-filter: blur(6px);
      border-bottom:1px solid var(--line);
    }
    .nav-inner{
      max-width:960px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{ font-weight:700; letter-spacing:.2px; color:var(--brand) }

    /* Ana alan */
    .wrap{ max-width:960px; margin:28px auto 72px; padding:0 16px; }
    .layout{ display:grid; grid-template-columns: 1.05fr .95fr; gap:20px; }
    @media (max-width: 900px){ .layout{ grid-template-columns: 1fr; } }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow: 0 6px 20px rgba(15,23,42,.06); }
    .card-body{ padding:18px; }
    .muted{ color:var(--muted); font-size:14px }
    .section-title{ margin:0 0 6px; font-size:18px; font-weight:700 }

    /* Auth alanı */
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .btn{
      padding:10px 14px; border:1px solid var(--line); background:#fff;
      border-radius:12px; cursor:pointer; font-weight:600;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 6px 14px rgba(17,24,39,.06) }
    .btn:disabled{ opacity:.55; cursor:not-allowed }

    /* Seçenek kartları */
    .choices{ display:grid; grid-template-columns: repeat(2, minmax(160px, 1fr)); gap:12px; margin-top:8px }
    @media (max-width:560px){ .choices{ grid-template-columns: 1fr; } }
    .choice{
      height:92px; border:1px solid var(--line); border-radius:14px; background:#fff;
      display:flex; align-items:center; justify-content:center; gap:10px;
      font-weight:700; font-size:18px; cursor:pointer; user-select:none;
      transition: outline-color .1s ease, transform .08s ease;
    }
    .choice:hover{ outline:3px solid var(--accent-2); transform: translateY(-1px) }
    .emoji{ font-size:22px }

    /* Liderlik tablosu */
    .leader-row{
      display:flex; align-items:center; gap:12px; padding:12px 0;
      border-bottom:1px dashed var(--line);
    }
    .badge{
      width:32px; height:32px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--line); background:#fff; font-weight:700
    }
    .bar{ height:10px; background:#eef2f7; border-radius:6px; overflow:hidden; flex:1 }
    .fill{ height:100%; background:var(--accent); }
    .top1{ background:#fff9ed } /* lider satıra nazik vurgu */

    .hidden{ display:none }
    .ok{ color:#10b981 } .err{ color:#ef4444 }

    footer{ text-align:center; color:#9ca3af; font-size:12px; margin:36px 0 }
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">piann</div>
      <div class="muted" id="miniInfo"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="layout">
      <!-- Sol: oy kartı -->
      <section class="card">
        <div class="card-body">
          <div class="row" style="justify-content:space-between; margin-bottom:8px">
            <h2 class="section-title">Katıl</h2>
            <div class="row">
              <button id="btnSignIn" class="btn">Google ile giriş yap</button>
              <button id="btnSignOut" class="btn hidden">Çıkış</button>
            </div>
          </div>
          <div id="who" class="muted" style="margin-bottom:4px"></div>

          <div id="voteCard" class="hidden">
            <div class="muted">Bir seçenek seç ve tıkla.</div>
            <div class="choices">
              <div class="choice" data-key="islam"><span class="emoji">☪️</span> İslam</div>
              <div class="choice" data-key="hristiyanlik"><span class="emoji">✝️</span> Hristiyanlık</div>
              <div class="choice" data-key="musevilik"><span class="emoji">✡️</span> Musevilik</div>
              <div class="choice" data-key="inanmiyorum"><span class="emoji">🚫</span> İnanmıyorum</div>
            </div>
            <div id="voteMsg" class="muted" style="margin-top:10px"></div>
          </div>
        </div>
      </section>

      <!-- Sağ: canlı sonuçlar -->
      <section class="card">
        <div class="card-body">
          <div class="row" style="justify-content:space-between">
            <h2 class="section-title">Canlı Sıralama</h2>
            <div id="total" class="muted">Toplam: 0</div>
          </div>
          <div id="resultsCard">
            <div id="rankList"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <footer>© piann.com</footer>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    /* Firebase config (piann-c58b8) */
    const firebaseConfig = {
      apiKey: "AIzaSyCB71Ffsvv3y5QArsgauAC91lhjFiE5K8Q",
      authDomain: "piann-c58b8.firebaseapp.com",
      projectId: "piann-c58b8",
      storageBucket: "piann-c58b8.appspot.com",
      messagingSenderId: "1086334896697",
      appId: "1:1086334896697:web:7770adc7f9438be4a49be8"
    };

    // --- Init
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- UI refs
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignOut = document.getElementById('btnSignOut');
    const who = document.getElementById('who');
    const miniInfo = document.getElementById('miniInfo');
    const voteCard = document.getElementById('voteCard');
    const voteMsg = document.getElementById('voteMsg');
    const totalEl = document.getElementById('total');
    const rankList = document.getElementById('rankList');
    const boxes = Array.from(document.querySelectorAll('.choice'));

    const NAMES = { islam:'İslam', hristiyanlik:'Hristiyanlık', musevilik:'Musevilik', inanmiyorum:'İnanmıyorum' };

    // --- Auth
    btnSignIn.onclick = async () => {
      try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
      catch(e){ alert('Giriş hatası: ' + e.message); }
    };
    btnSignOut.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async (user)=>{
      if(user){
        btnSignIn.classList.add('hidden');
        btnSignOut.classList.remove('hidden');
        const name = user.displayName || user.email;
        who.textContent = `${name} olarak giriş yaptınız.`;
        miniInfo.textContent = 'Giriş yapıldı';
        voteCard.classList.remove('hidden');
        setupVoteGuard(user.uid);
        subscribeResults();
      }else{
        btnSignIn.classList.remove('hidden');
        btnSignOut.classList.add('hidden');
        who.textContent = '';
        miniInfo.textContent = '';
        voteCard.classList.add('hidden');
        cleanupResults();
      }
    });

    function setBoxesEnabled(on){
      boxes.forEach(b=>{
        b.style.pointerEvents = on ? 'auto':'none';
        b.style.opacity = on ? '1' : '.6';
      });
    }

    async function setupVoteGuard(uid){
      voteMsg.className='muted';
      voteMsg.textContent='Oyunu seç ve tıkla.';
      setBoxesEnabled(true);

      const u = await db.collection('users').doc(uid).get();
      if(u.exists){
        setBoxesEnabled(false);
        voteMsg.className='muted ok';
        voteMsg.textContent='Daha önce oy verdin: ' + NAMES[u.data().choice];
      }else{
        boxes.forEach(el => { el.onclick = () => handleVote(uid, el.dataset.key); });
      }
    }

    async function handleVote(uid, choice){
      try{
        await db.runTransaction(async (tx)=>{
          const uRef = db.collection('users').doc(uid);
          const sRef = db.collection('stats').doc('votes');

          const uSnap = await tx.get(uRef);
          if(uSnap.exists) throw new Error('Bu kullanıcı zaten oy vermiş.');

          const sSnap = await tx.get(sRef);
          const base = sSnap.exists ? sSnap.data() : {islam:0,hristiyanlik:0,musevilik:0,inanmiyorum:0};
          const inc = firebase.firestore.FieldValue.increment(1);

          tx.set(uRef, { choice, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          tx.set(sRef, {
            islam: choice==='islam' ? inc : (base.islam||0),
            hristiyanlik: choice==='hristiyanlik' ? inc : (base.hristiyanlik||0),
            musevilik: choice==='musevilik' ? inc : (base.musevilik||0),
            inanmiyorum: choice==='inanmıyorum' ? inc : (base.inanmiyorum||0)
          }, { merge:true });
        });

        setBoxesEnabled(false);
        voteMsg.className='muted ok';
        voteMsg.textContent='Teşekkürler! Oyun kaydedildi: ' + NAMES[choice];
      }catch(e){
        voteMsg.className='muted err';
        voteMsg.textContent = 'Hata: ' + e.message;
      }
    }

    // --- Live results
    let unsubResults=null;
    function subscribeResults(){
      const ref = db.collection('stats').doc('votes');
      unsubResults = ref.onSnapshot(s=>{
        const data = s.exists ? s.data() : {islam:0,hristiyanlik:0,musevilik:0,inanmiyorum:0};
        renderRanking(data);
      });
    }
    function cleanupResults(){ if (unsubResults){unsubResults();unsubResults=null;} }

    function renderRanking(counts){
      const pairs = Object.entries(counts);
      const total = pairs.reduce((a,[,v])=>a+(v||0),0);
      totalEl.textContent = 'Toplam: ' + total;

      const sorted = pairs.sort((a,b)=>(b[1]||0)-(a[1]||0));
      rankList.innerHTML='';
      sorted.forEach(([key,val],i)=>{
        const pct = total>0 ? Math.round((val||0)*100/total) : 0;
        const row = document.createElement('div');
        row.className='leader-row' + (i===0 ? ' top1':'');

        const medal = i===0?'🏆':(i===1?'🥈':(i===2?'🥉':''));
        row.innerHTML = `
          <div class="badge">${i+1}</div>
          <div style="width:190px">${medal} ${NAMES[key]}: <b>${val||0}</b> (${pct}%)</div>
          <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
        `;
        rankList.appendChild(row);
      });
    }
  </script>
</body>
</html>
