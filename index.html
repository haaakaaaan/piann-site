<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>piann — Google Giriş Test Kiti (Tek Sayfa)</title>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--bg:#f8fafc;--blue:#0A66C2}
    *{box-sizing:border-box} body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:var(--ink);background:#fff}
    h1{margin:0 0 12px} small{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .primary{background:var(--blue);color:#fff;border-color:var(--blue)}
    .ghost{background:#fff;color:var(--blue)}
    .card{border:1px solid var(--line);border-radius:12px;padding:14px;margin:16px 0}
    .ok{color:#16a34a}.err{color:#dc2626}
    #log{background:var(--bg);border:1px dashed #cbd5e1;border-radius:10px;padding:12px;white-space:pre-wrap;max-height:320px;overflow:auto}
    .grid{display:grid;grid-template-columns:160px 1fr;gap:8px}
    .pill{display:inline-block;padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
    img{border-radius:50%}
    code{background:#f1f5f9;padding:1px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Google Giriş Test Kiti</h1>
  <small>Tek sayfa ile tüm akışı test eder (popup + redirect). Konsolu da (F12) açık tut.</small>

  <div class="row">
    <button id="btnPopup" class="primary">Google ile giriş (Popup)</button>
    <button id="btnRedirect" class="ghost">Google ile giriş (Redirect)</button>
    <button id="btnLogout">Çıkış</button>
    <button id="btnClear">Logu temizle</button>
  </div>

  <div class="card">
    <div><b>Durum:</b> <span id="status">Hazır</span></div>
    <div class="row" style="margin-top:6px">
      <span class="pill" id="pOrigin">origin</span>
      <span class="pill" id="pAuthDomain">authDomain</span>
      <span class="pill" id="pCookies">cookies</span>
      <span class="pill" id="pPersist">persistence</span>
    </div>
  </div>

  <div id="userCard" class="card" style="display:none">
    <h3 style="margin:0 0 8px">Kullanıcı</h3>
    <div class="grid">
      <div>Ad</div>     <div id="uName">—</div>
      <div>E-posta</div><div id="uMail">—</div>
      <div>UID</div>    <div id="uUid" style="overflow-wrap:anywhere">—</div>
      <div>Foto</div>   <div id="uPhoto">—</div>
      <div>Provider</div><div id="uProv">—</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <b>Log</b>
      <span class="pill">getRedirectResult + onAuthStateChanged</span>
    </div>
    <div id="log"></div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    // === KENDİ FIREBASE AYARLARIN ===
    const firebaseConfig = {
      apiKey: "AIzaSyCB71Ffsvv3y5QArsgauAC91lhjFiE5K8Q",
      authDomain: "piann-c58b8.firebaseapp.com",
      projectId: "piann-c58b8",
      storageBucket: "piann-c58b8.appspot.com",
      messagingSenderId: "1086334896697",
      appId: "1:1086334896697:web:7770adc7f9438be4a49be8"
    };

    // === KISA SEÇİCİLER / UI ===
    const $ = s => document.querySelector(s);
    const statusEl = $('#status'), logEl = $('#log');
    const uCard = $('#userCard'), uName=$('#uName'), uMail=$('#uMail'), uUid=$('#uUid'), uPhoto=$('#uPhoto'), uProv=$('#uProv');

    function log(...args){
      console.log(...args);
      const line = args.map(a => typeof a==='object' ? JSON.stringify(a,null,2) : String(a)).join(' ');
      logEl.textContent += line + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(txt, cls){
      statusEl.className = cls||''; statusEl.textContent = txt;
    }
    function showUser(u){
      if(!u){ uCard.style.display='none'; return; }
      uCard.style.display='block';
      uName.textContent = u.displayName || '(isimsiz)';
      uMail.textContent = u.email || '—';
      uUid.textContent  = u.uid;
      uProv.textContent = (u.providerData||[]).map(p=>p.providerId).join(', ') || '—';
      uPhoto.innerHTML  = u.photoURL ? `<img src="${u.photoURL}" alt="" width="56" height="56">` : '—';
    }

    // === Firebase init ===
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // UI info pills
    $('#pOrigin').textContent     = 'origin: ' + location.origin;
    $('#pAuthDomain').textContent = 'authDomain: ' + firebaseConfig.authDomain;
    $('#pCookies').textContent    = 'cookies: ' + (navigator.cookieEnabled ? 'enabled' : 'DISABLED');

    // Persistence (LOCAL fallback SESSION)
    (async ()=>{
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        $('#pPersist').textContent = 'persistence: LOCAL';
      }catch(e){
        $('#pPersist').textContent = 'persistence: SESSION (fallback)';
        await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
      }
    })();

    // Redirect sonucu (sayfa her açıldığında kontrol et)
    auth.getRedirectResult()
      .then(res=>{
        if(res && res.user){
          setStatus('Redirect sonucu: giriş OK → ' + (res.user.displayName || res.user.email), 'ok');
          showUser(res.user);
          log('getRedirectResult user:', {uid:res.user.uid, email:res.user.email});
        }else{
          log('getRedirectResult: user yok (ilk açılış olabilir)');
        }
      })
      .catch(err=>{
        setStatus('Redirect sonucu hata: ' + (err.code||err.message), 'err');
        log('getRedirectResult error:', err);
      });

    // Auth state listener
    auth.onAuthStateChanged(u=>{
      if(u){
        setStatus('Giriş OK: ' + (u.displayName || u.email), 'ok');
        showUser(u);
        log('onAuthStateChanged user:', {uid:u.uid, email:u.email});
      }else{
        setStatus('Oturum yok');
        showUser(null);
        log('onAuthStateChanged: user yok');
      }
    });

    // POPUP login
    $('#btnPopup').onclick = async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        setStatus('Popup açılıyor…');
        await auth.signInWithPopup(provider);
        setStatus('Popup sonucu: giriş OK', 'ok');
      }catch(err){
        setStatus('Popup hata: ' + (err.code||err.message), 'err');
        log('signInWithPopup error:', err);
        if (err && err.code === 'auth/popup-blocked') {
          log('Bilgi: Tarayıcı popupı engelledi, Redirect deneyin.');
        }
      }
    };

    // REDIRECT login
    $('#btnRedirect').onclick = async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      try{
        setStatus('Google’a yönlendiriyorum…');
        await auth.signInWithRedirect(provider);
      }catch(err){
        setStatus('Redirect hata: ' + (err.code||err.message), 'err');
        log('signInWithRedirect error:', err);
      }
    };

    // ÇIKIŞ
    $('#btnLogout').onclick = async ()=>{
      try{
        await auth.signOut();
        setStatus('Çıkış yapıldı', 'ok');
        showUser(null);
        log('signOut OK');
      }catch(err){
        setStatus('Çıkış hatası: ' + (err.code||err.message), 'err');
        log('signOut error:', err);
      }
    };

    // Log temizle
    $('#btnClear').onclick = ()=>{ logEl.textContent=''; };
  </script>
</body>
</html>
