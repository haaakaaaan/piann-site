<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>piann — Gerçek değerini keşfet; skorun senin imzan</title>
<style>
  :root{ --bg:#f7f8fb; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --line:#e6e9ef; --accent:#0A66C2; --accent-600:#0857A6; --container:max(320px, min(1080px, 92vw)); }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  a{color:inherit;text-decoration:none}
  .btn{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent-600);border-color:var(--accent-600)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)} .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 24px rgba(15,23,42,.04)}
  .hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700} .bd{padding:16px}
  .wrap{max-width:var(--container);margin:24px auto 64px;padding:0 16px}

  /* NAV */
  .nav{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);display:none}
  .nav-inner{max-width:var(--container);margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:800;color:var(--accent)} .spacer{flex:1} .count{color:var(--muted);font-size:14px}

  /* LOGIN HERO */
  .hero-wrap{max-width:var(--container);margin:48px auto;padding:0 16px;display:grid;grid-template-columns:1.2fr 1fr;gap:22px}
  @media (max-width:900px){.hero-wrap{grid-template-columns:1fr}}
  .hero-left h1{font-size:44px;line-height:1.12;margin:0 0 10px;color:#0a3e78}
  .hero-left p{color:var(--muted);font-size:18px;margin:0 0 16px}

  /* PROFILE */
  .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;background:#eef2f7;border:1px solid var(--line)}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.row-2{grid-template-columns:1fr}}
  input[type=text], textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
  textarea{resize:vertical}

  /* TABLE */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{color:#111827}

  footer{margin:32px 0;text-align:center;color:#64748b;font-size:12px}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav" id="nav">
  <div class="nav-inner">
    <a href="#/" class="brand">piann</a>
    <a href="#/members" class="btn">Üyeler</a>
    <div class="spacer"></div>
    <span id="memberCount" class="count">Üye: —</span>
    <button id="btnMy" class="btn" style="display:none">Profilim</button>
    <button id="btnOut" class="btn" style="display:none">Çıkış</button>
  </div>
</nav>

<!-- LOGIN -->
<section id="loginHero" style="display:none">
  <div class="hero-wrap">
    <div class="hero-left">
      <h1>Gerçek değerini keşfet; skorun senin imzan.</h1>
      <p>Beğeni/yorum yok — sadece puan ve sıralama. Herkes aynı zeminde yarışsın.</p>
      <ul class="muted" style="line-height:1.6">
        <li>Google ile giriş yap, profilini düzenle</li>
        <li>Üyeler sayfasından profillere bak ve takip et</li>
      </ul>
    </div>
    <div class="card">
      <div class="hd">Giriş yap</div>
      <div class="bd">
        <button class="btn primary" id="btnGoogle" style="width:100%">Google ile giriş yap</button>
        <div class="muted" id="loginInfo" style="margin-top:8px"></div>
        <div class="muted" style="margin-top:12px;font-size:12px">Test için <b>http://localhost</b> kullan; Firebase Console > Authentication > <b>Authorized domains</b>’e domainini eklemeyi unutma.</div>
      </div>
    </div>
  </div>
</section>

<!-- APP -->
<main class="wrap" id="appMain" style="display:none">
  <!-- PROFILE -->
  <section id="pageProfile" class="card" style="display:none">
    <div class="hd">Profil</div>
    <div class="bd" id="profWrap">—</div>
  </section>

  <!-- MEMBERS -->
  <section id="pageMembers" class="card" style="display:none; margin-top:16px">
    <div class="hd">Üyeler</div>
    <div class="bd">
      <div class="muted" style="margin-bottom:8px">Mevcut üyelerden profillere girip takip edebilirsin.</div>
      <div id="membersWrap">Yükleniyor…</div>
    </div>
  </section>
</main>

<footer>© piann.com</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* 🔐 Firebase config — kendi projenle aynı olmalı */
const firebaseConfig = {
  apiKey: "AIzaSyCB71Ffsvv3y5QArsgauAC91lhjFiE5K8Q",
  authDomain: "piann-c58b8.firebaseapp.com",
  projectId: "piann-c58b8",
  storageBucket: "piann-c58b8.appspot.com",
  messagingSenderId: "1086334896697",
  appId: "1:1086334896697:web:7770adc7f9438be4a49be8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ===== Utils ===== */
const $=(s)=>document.querySelector(s);
const show=(ids=[])=>{
  const all=['#pageProfile','#pageMembers'];
  all.forEach(sel=> $(sel).style.display = ids.includes(sel)?'block':'none');
};
function avatarDataURL(name){
  const bg='#0A66C2', txt='#fff';
  const ini=(name||'').trim().split(/\s+/).map(s=>s[0]||'').slice(0,2).join('').toUpperCase()||'P';
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><rect width='100' height='100' rx='50' ry='50' fill='${bg}'/><text x='50%' y='56%' text-anchor='middle' dominant-baseline='middle' font-size='44' font-family='Arial, Helvetica, sans-serif' fill='${txt}'>${ini}</text></svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}

/* ===== State ===== */
let me=null;
let followingSet=new Set();

/* ===== Auth UI ===== */
const nav=$('#nav'), loginHero=$('#loginHero'), appMain=$('#appMain');
const btnGoogle=$('#btnGoogle'), btnOut=$('#btnOut'), btnMy=$('#btnMy');
const memberCount=$('#memberCount');

btnGoogle && (btnGoogle.onclick=async ()=>{
  try{ $('#loginInfo').textContent='Google açılıyor…'; await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
  catch(e){ $('#loginInfo').textContent='Hata: '+(e.message||e.code||e); }
});
btnOut && (btnOut.onclick=()=>auth.signOut());
btnMy && (btnMy.onclick=()=>{ if(!me) return; location.hash = '#/u/'+me.uid; renderProfile(me.uid); show(['#pageProfile']); });

auth.onAuthStateChanged(async (u)=>{
  me=u||null;
  const loggedIn=!!me;
  nav.style.display = loggedIn? 'block':'none';
  loginHero.style.display = loggedIn? 'none':'block';
  appMain.style.display = loggedIn? 'block':'none';

  if(loggedIn){
    btnOut.style.display='inline-block'; btnMy.style.display='inline-block';
    await ensureUserDocs();
    await refreshCounters();
    await refreshFollowing();
    // GİRİŞTEN SONRA DOĞRUDAN PROFİLE GÖNDER
    location.hash = '#/u/'+me.uid;
    await route();
  }else{
    btnOut.style.display='none'; btnMy.style.display='none';
  }
});

/* ===== Ensure user docs ===== */
async function ensureUserDocs(){
  if(!me) return;
  const uRef=db.collection('users').doc(me.uid);
  const uSnap=await uRef.get();
  if(!uSnap.exists){
    await uRef.set({
      displayName: me.displayName || me.email || 'Kullanıcı',
      photoURL: me.photoURL || '',
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }else{
    await uRef.set({
      displayName: me.displayName || uSnap.data().displayName || 'Kullanıcı',
      photoURL: me.photoURL || uSnap.data().photoURL || ''
    }, {merge:true});
  }

  const pRef=db.collection('profiles').doc(me.uid);
  const pSnap=await pRef.get();
  if(!pSnap.exists){
    const base=(me.displayName||'').split(' ')[0] || (me.email||'user').split('@')[0];
    const handle=(base||'user').toLowerCase().replace(/[^a-z0-9_]+/g,'_').replace(/_+/g,'_').slice(0,15) || 'user';
    await pRef.set({
      displayName: me.displayName || (me.email||'Kullanıcı'),
      displayNameLower: (me.displayName||'kullanıcı').toLowerCase(),
      handle, handleLower:handle,
      bio:'', website:'', location:'',
      photoURL: me.photoURL || '', coverURL:'',
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }
}

/* ===== Following ===== */
async function refreshFollowing(){
  if(!me){ followingSet.clear(); return; }
  const snap=await db.collection('users').doc(me.uid).collection('following').get();
  followingSet = new Set(snap.docs.map(d=>d.id));
}
async function followUser(targetUid){
  if(!me || targetUid===me.uid) return;
  await db.collection('users').doc(me.uid).collection('following').doc(targetUid)
    .set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() });
  followingSet.add(targetUid);
}
async function unfollowUser(targetUid){
  if(!me || targetUid===me.uid) return;
  await db.collection('users').doc(me.uid).collection('following').doc(targetUid).delete();
  followingSet.delete(targetUid);
}
function isFollowing(uid){ return followingSet.has(uid); }

/* ===== Router ===== */
window.addEventListener('hashchange', route);
async function route(){
  if(!me){ return; }
  const h=location.hash || '#/';
  if(h.startsWith('#/u/')){ const uid=h.split('/')[2]; await renderProfile(uid); show(['#pageProfile']); return; }
  if(h.startsWith('#/members')){ await renderMembers(); show(['#pageMembers']); return; }
  // default → profil
  location.hash = '#/u/'+me.uid;
}

/* ===== Counters ===== */
async function refreshCounters(){
  try{
    const s=await db.collection('users').get();
    memberCount.textContent = 'Üye: ' + s.size;
  }catch{
    memberCount.textContent = 'Üye: —';
  }
}

/* ===== Profile ===== */
async function renderProfile(uid){
  const box=$('#profWrap'); box.textContent='Yükleniyor…';
  try{
    const uDoc=await db.collection('users').doc(uid).get();
    if(!uDoc.exists){ box.textContent='Kullanıcı bulunamadı.'; return; }
    const u=uDoc.data();
    const pDoc=await db.collection('profiles').doc(uid).get();
    const p=pDoc.exists?pDoc.data():{};
    const own = me && me.uid===uid;
    const avatar=(p.photoURL||u.photoURL)||avatarDataURL(p.displayName||u.displayName||'Kullanıcı');

    const followBtn = (!own)
      ? (isFollowing(uid)
          ? `<button class="btn" id="btnUnfollow">Takibi bırak</button>`
          : `<button class="btn primary" id="btnFollow">Takip et</button>`)
      : '';

    box.innerHTML = `
      <div style="display:flex;gap:14px;align-items:flex-start;margin-bottom:12px">
        <img class="avatar" src="${avatar}" alt="">
        <div style="flex:1">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div style="font-weight:800">${p.displayName||u.displayName||'(Kullanıcı)'}</div>
            <span class="muted">@${(p.handle||uid.slice(0,6))}</span>
          </div>
          <div class="muted" style="margin-top:6px">${p.bio||''}</div>
          <div class="muted" style="font-size:14px;margin-top:4px">
            ${p.location?('📍 '+p.location):''} ${p.website?(' • 🔗 '+p.website):''}
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:start">
          ${ own ? `<button class="btn" id="btnEdit">Düzenle</button>` : `` }
          ${ followBtn }
          <button class="btn" id="btnShare">Paylaş</button>
        </div>
      </div>

      ${ own ? `
      <form id="editForm" class="card" style="padding:12px;border:1px dashed var(--line)">
        <div class="row-2">
          <label>Ad Soyad
            <input id="fName" type="text" value="${(p.displayName||u.displayName||'')}" />
          </label>
          <label>Handle
            <input id="fHandle" type="text" value="${(p.handle||'')}" />
          </label>
          <label style="grid-column:1/-1">Bio
            <textarea id="fBio" rows="3">${(p.bio||'')}</textarea>
          </label>
          <label>Website
            <input id="fWeb" type="text" value="${(p.website||'')}" />
          </label>
          <label>Konum
            <input id="fLoc" type="text" value="${(p.location||'')}" />
          </label>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <span id="saveMsg" class="muted" style="align-self:center"></span>
          <button class="btn" type="button" id="btnCancel">İptal</button>
          <button class="btn primary" type="submit">Kaydet</button>
        </div>
      </form>` : ``}
    `;

    // Share
    $('#btnShare').onclick=()=>{ const link=location.origin+location.pathname+'#/u/'+uid; navigator.clipboard?.writeText(link).then(()=>alert('Bağlantı kopyalandı: '+link)).catch(()=>alert(link)); };

    // Follow/Unfollow
    if(!own){
      const refollow=async ()=>{ await refreshFollowing(); renderProfile(uid); };
      $('#btnFollow') && ($('#btnFollow').onclick=async ()=>{ await followUser(uid); await refollow(); });
      $('#btnUnfollow') && ($('#btnUnfollow').onclick=async ()=>{ await unfollowUser(uid); await refollow(); });
    }

    // Edit form
    if(own){
      $('#btnEdit').onclick=()=> $('#fName').focus();
      $('#btnCancel').onclick=()=> route();
      $('#editForm').onsubmit=async (e)=>{
        e.preventDefault();
        const dis=(v)=> (v||'').toString().trim();
        const displayName=dis($('#fName').value);
        let handle=(dis($('#fHandle').value)||displayName.split(' ')[0]||'user').toLowerCase()
          .replace(/[^a-z0-9_]+/g,'_').replace(/_+/g,'_').slice(0,15);
        const bio=dis($('#fBio').value), website=dis($('#fWeb').value), location=dis($('#fLoc').value);
        try{
          await db.collection('profiles').doc(uid).set({
            displayName, displayNameLower:displayName.toLowerCase(),
            handle, handleLower:handle, bio, website, location,
            photoURL:p.photoURL||u.photoURL||''
          }, {merge:true});
          await db.collection('users').doc(uid).set({displayName, photoURL:p.photoURL||u.photoURL||''}, {merge:true});
          $('#saveMsg').textContent='Kaydedildi.';
          setTimeout(()=> renderProfile(uid), 600);
        }catch(err){
          $('#saveMsg').textContent='Hata: '+(err.message||err);
        }
      };
    }
  }catch(e){
    $('#profWrap').textContent='Hata: '+(e.message||e);
  }
}

/* ===== Members (mevcut gerçek üyeler) ===== */
async function renderMembers(){
  const wrap=$('#membersWrap'); wrap.textContent='Yükleniyor…';
  try{
    const snap=await db.collection('users').orderBy('joinedAt','desc').limit(100).get();
    if(snap.empty){ wrap.innerHTML='<div class="muted">Şimdilik başka kullanıcı yok.</div>'; return; }
    const rows=[];
    for(const d of snap.docs){
      const id=d.id; const u=d.data();
      const p=await db.collection('profiles').doc(id).get();
      const dis=(p.exists && p.data().displayName)||u.displayName||'(Kullanıcı)';
      rows.push({id, name:dis});
    }
    let html='<table><thead><tr><th>Ad</th><th>Profil</th></tr></thead><tbody>';
    rows.forEach(r=>{
      html+=`<tr><td>${r.name}</td><td><a class="btn" href="#/u/${r.id}">Gör</a></td></tr>`;
    });
    html+='</tbody></table>';
    wrap.innerHTML=html;
  }catch(e){
    wrap.textContent='Hata: '+(e.message||e);
  }
}

/* ===== Boot / Nav ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  $('#nav').style.display='none';
  $('#loginHero').style.display='block';
  $('#appMain').style.display='none';
});
</script>
</body>
</html>
